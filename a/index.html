<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel="icon" type="image/png" sizes="16x16" href="../kelas16.png">
<title>a</title>
<style>
body{font-family:georgia,serif;font-size:large}
pre{background:#eee}
textarea{color:white;background:black;resize:none}
</style>
</head><body onload="kinit()">

<h1>the k incunabulum (2024)</h1>

<h2>a.h</h2>
<pre>
typedef unsigned long u;
#define _u(f,e,x...) u f(x){return _(e);}
#define ax (10>x)
#define nx sx[-1]
#define sx ((char*)x)
#define xi sx[i]
#define _(e) ({e;})
#define r(a,e) _(u r=a;e;r)
#define x(a,e) _(u x=a;e)
#define y(a,e) _(u y=a;e)
#define i(n,e) {int $n=n;int i=0;for(;i<$n;++i){e;}}
#define f(f,e) _u(f,e,u x)
#define F(f,e) _u(f,e,u x,u y)
#define G(g,e) _u(g,e,u f,u x,u y)
#define us(f,e) _u(f,e,char*s)
#define Q(e) if(96==(e))return 96;
#define Qr(e) if(e){return err((u)__func__,(u)"rank");}
#define Qz(e) if(e){return err((u)__func__,(u)"todo");}
#define ri sr[i]
#define yi x(y,xi)
#define nr x(r,nx)
#define ny x(y,nx)
#define sr x(r,sx)
#define sy x(y,sx)
#define ay x(y,ax)
</pre>

<h2>a.c</h2>
<pre>
#include"a.h"//cc -Os -oa a.c -w
F(w_,write(1,y,x))f(w,127>x?w_(1,(u)&x):w_(strlen(x),x))F(err,w(x);w(58);w(y);w(10);96)f(qz,Qz(1)0)
G(m,(u)memcpy((void*)x,(void*)y,f))
f(a,char*s=malloc(x+1);*s++=x;(u)s)
f(ind,Qr(!ax)x=a(x);i(nx,xi=i)x)
f(cat,Qr(!ax)u r=a(1);*sr=x;r)
F(Cat,x=ax?cat(x):x;y=ay?cat(y):y;u r=a(nx+ny);m(ny,r+nx,y);m(nx,r,x))
f(at,Qr(ax)*sx)
F(At,Qr(ax||!ay)sx[y])
f(cnt,Qr(ax)nx)
F(Cnt,Qr(!ax||ay)x=a(x);m(nx,x,y))
F(Add,ax?ay?x+y:Add(y,x):r(a(ny),i(nr,ri=(ax?x:xi)+yi)))
u(*f[])()={0,qz,ind,cnt,cat,at},(*F[])()={0,Add,qz,Cnt,Cat,At};
u U[26];f(n,10>x-48?x-48:U[x-97])
char*V=" +!#,@";f(v,(strchr(V,x)?:V)-V)
us(e,u i=*s++;v(i)?x(e(s),Q(x)f[v(i)](x)):x(n(i),*s?y(e(s+1),Q(y)F[v(*s)](x,y)):x))
us(ws,u x=*s?e(s):0;Q(x)ax?w(48+x):_(i(nx,w(48+xi);w(32))0);w(10))
int main(){char s[99];while(1)w(32),s[read(0,s,99)-1]=0,ws(s);}
</pre>

<textarea id="o" spellcheck="false" rows="20" cols="80" readonly="true"                      ></textarea>
<textarea id="t" spellcheck="false" rows="1"  cols="80" onkeydown="key(event,this)"></textarea>

<h2>compile to wasm</h2>
the main function allocates an input buffer goes into a repl loop.
for wasm on a webpage <tt>read()</tt> blocks the ui and the page is unresponsive.<br>
we don't use main but add <tt>kinit</tt> that returns a pointer to a buffer and call <tt>ws()</tt> directly from javascript.
<pre>
char *kinit(){char s[99];return s;}
</pre>

wasm has only 4 types (int32, int64, float32 and float64).
pointers are int32 which are indexes into it's linear memory section.
code is separate from data.
as wasm has an infinite number of local variables in functions, stack is not neccessarily needed, but 


to compile with clang we use
<pre>
PATH="$PATH:/usr/lib/llvm-13/bin" # i need this for clang to find the linker

clang-13 -Os --target=wasm32 -mbulk-memory \
 -Wl,--export=kinit,--export=ws,--export=__heap_base,-allow-undefined \
 --no-standard-libraries -Wl,--no-entry -oa.wasm a.c
</pre>

we export the functions that we need to have available from js and <text>__heap_base</text> which clang uses to mark the end of the stackdefines separate 

<pre>
$wasm2wat a.wasm -o a.wat
$head -15 a.wat
(module
  (type (;0;) (func (param i32) (result i32)))
  (type (;1;) (func (param i32 i32) (result i32)))
  (type (;2;) (func (param i32)))
  (type (;3;) (func (param i32 i32)))
  (type (;4;) (func (result i32)))
  (type (;5;) (func (param i32 i32 i32) (result i32)))
  (import "env" "write" (func (;0;) (type 5)))
  (import "env" "strlen" (func (;1;) (type 0)))
  (import "env" "malloc" (func (;2;) (type 0)))
  (import "env" "strchr" (func (;3;) (type 1)))
  (func (;4;) (type 2) (param i32)
    (local i32)
    global.get 0
    i32.const 16
$grep export a.wat
  (export "memory" (memory 0))
  (export "ws" (func 16))
  (export "kinit" (func 17))
  (export "__heap_base" (global 1))
</pre>

<script>
let t=document.getElementById("t")
let O=x=>{o.value+=x;o.scrollTo(0,o.scrollHeight)}
let lo=x=>Number(BigInt.asUintN(32,x))
const td_=new TextDecoder("utf-8"),su=x=>td_.decode(x)
const te_=new TextEncoder("utf-8"),us=x=>te_.encode(x)



 
let /*there be*/ K
let B //input buffer, returned from  (char*)kinit(){c s[99];return s;}
let C=_=>new Uint8Array(K.memory.buffer)
let S=(x,n)=>su(new Uint8Array(K.memory.buffer,x,n))
let kenv={env:{
 malloc:x=>{M+=x;return M-x},
 write:(x,y,z)=>{O(S(y,z));return z},
 strlen:x=>C().slice(x).indexOf(0),
 strchr:(x,y)=>C().indexOf(x=>(!x)||x==y),
}}

let key=(e,t,s)=>{v=t.value;if("Enter"==e.key){O(s);ws(us(s));t.value=" "}}
let ws=u=>{let c=C();u.forEach((x,i)=>c[B+i]=u);c[B+u.length]=0;K.ws(B)}

/*
let repl=t=>{let c=C(),s=us(t.value)
 console.log(s)
 for(let i=0;i<s.length;i++)c[B+i]=s[i];C[B+s.length]=0;
 K.repl(B)
}
*/

let kinit=()=>{
 fetch("a.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(r,kenv)).then(r=>{
  K=r.instance.exports
  M=K.__heap_base
  B=K.kinit()
  console.log("B",B)
  t.focus()})}


</script></body></html>
