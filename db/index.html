<!DOCTYPE html>
<head><meta charset="utf-8"><title>db</title>
<link rel="manifest" href="db.webmanifest">
<link rel="icon" type="image/png" sizes="32x32" href="kelas32.png">
<link rel="icon" type="image/png" sizes="16x16" href="kelas16.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<meta name="theme-color" content="black"/>
<style>
*{font-size:x-large;font-family:monospace;box-sizing:border-box}
html{margin:0;padding:0}
body{min-height:100vh;margin:0;padding:0;overflow:hidden}
.but:active{transform:translateY(2px)}
a,.link{text-decoration:underline;color:blue;y-padding:1em}
.link:hover{cursor:pointer}
input{-webkit-appearance:none}
select{-webkit-appearance:none}
#buttons{position:absolute;z-index:1;display:none;width:2em;height:2em;top:0;right:0;font-weight:bold;text-align:center;border:2px solid black;border-radius:6px;color:black;background:white}
#queries{position:absolute;top:0;width:calc(100% - 2em);height:2em;text-align:center;font-weight:bold;border:2px solid black;border-radius:6px;color:black;background:white}
#kelas{position:absolute;top:4px;right:4px;cursor:pointer;background:#ffe}
#out{position:absolute;width:100%;height:calc(100vh - 2em);top:2em;background:#fdfdfd}
#kout{width:100%;height:50%;margin:0;padding:5px;overflow:auto;background:black;border-top:2px solid #f85c24;scrollbar-width:none}
#kout::-webkit-scrollbar{display:none}
#tty{margin:0;color:white}
#mono{position:absolute;left:100;top:100;visibility:hidden}
#editor{width:100%;padding:0;height:50%;resize:none;border:none;outline:none;overflow:auto;padding:0.5em;white-space:pre;background:#ffe}
svg{display:block;margin-left:auto;margin-right:auto}
.bar{fill:grey}.hibar{stroke:white;stroke-width:4px}.highpoint{fill:red}
.legend{fill:white;text-anchor:middle}
.line{fill:none;stroke-width:3}.stroke0{stroke:#ff2}.stroke1{stroke:#e11}.stroke2{stroke:#2d2}.stroke3{stroke:#28f}
</style>
</head>
<body onload="init()">

<select id="queries" onchange="querychange()">
 <option value="">[tables]</option>
</select>
<select id="buttons" onchange="addelquery(this.value)"><option>..</option><option value="add">+</option><option value="del">-</option><option value="share">â†‘</option><option value="shareurl">#</option></select>
<img id="kelas" class="but" src="kelas32.png" onclick="help()"/>

<div id="out"></div>

<pre id="mono">M 0 1 2 3 4 5 6 7 8 9 0</pre>   <!--measure console size-->

<script>
if("serviceWorker"in navigator)navigator.serviceWorker.register("db.sw.js")

let tables=[{name:"A",k:["alpha","beta","gamma"],t:"ifs",v:[[1,2,3,4],[2.3,4.5,1.234,-4.2],["hans","peter","werner","florian"]]}]

let init=async()=>{
 await fetch("db").then(r=>r.text()).then(r=>tables=[fromcsv("t","id,type,time,dist,coords\ni,s,f,f,i\n"+r.replaceAll(" ",","))])
 await fetch("queries.k").then(r=>r.text()).then(r=>r.split(/\n\/\//).slice(1).map(x=>{x=x.trim().split("\n");addquery(x[0],"/"+x[0]+"\n"+x.slice(1).join("\n"))}))
 queries.value=""
 let s=decodeURIComponent(window.location.hash.substr(1))
 if(s){addquery(s.split("\n")[0].slice(1),s);queries.value=s;return querychange()}
 showtables()
}
function ge(x){return document.getElementById(x)}
function ce(x){return document.createElement(x)}
function ct(x){return document.createTextNode(x)}
function tc(x,y){x.textContent=y;return x}
function ac(x,y){x.appendChild(y);return y}
function th(t){let T=ce("table");t.forEach((r,i)=>{let R=ce("tr");ac(T,R);r.forEach(c=>{ac(R,tc(ce(i?"td":"th"),c))})});return T}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}}
function rm(p){while(p.firstChild)p.removeChild(p.firstChild);return p}
function flip(x){
 let n=x.length,m=x[0].length,r=[]
 for(let i=0;i<m;i++)r[i]=Array(n)
 for(let i=0;i<n;i++){for(let j=0;j<m;j++)r[j][i]=x[i][j]}
 return r
}
const td_=new TextDecoder("utf-8"),su=x=>td_.decode(x)
const te_=new TextEncoder("utf-8"),us=x=>te_.encode(x)


let out=ge("out"),queries=ge("queries")

function nt(t){return(0==t.v.length)?0:t.v[0].length}
function addelquery(q){("add"==q)?newquery():("del"==q)?delquery():("share"==q)?sharequery(0):("shareurl"==q)?sharequery(1):0;querychange()}
function addquery(name,q){let o=ce("option");o.textContent=name;o.value=q;ac(queries,o);queries.value=o.value}
function delquery(){queries.removeChild(currentOption())}
function sharequery(u){
 let v=currentOption().value,d={title:v.split("\n")[0].slice(1),text:v,url:"https://ktye.github.io/db/index.html#"+encodeURI(v)}
 window.location.hash="#"+encodeURI(v)
 delete(d[u?"text":"url"]);navigator.share(d)
}
function newquery(){let s="query"+queries.options.length;addquery(s,"/"+s+"\n`answer"+queries.options.length)}
async function querychange(){
 let q=currentOption().value,b=ge("buttons");b.style.display=q.length?"block":"none"
 if(""==q)       return showtables()
 rm(out);b.value="..";let e=ce("textarea");e.id="editor";e.spellcheck=false;e.value=currentOption().value;ac(out,e)
 e.onchange=()=>{currentOption().value=e.value;tc(currentOption(),e.value.split("\n")[0].slice(1,41));querychange()}
 runquery(q)
}
async function runquery(q){q=q.trim()
 let p=ce("pre"),d=ce("div");p.id="tty";d.id="kout";ac(d,p);ac(out,d)
 await kinit(queries.options[1].value) //always start with prolog
 svg=newsvg(Math.min(out.clientWidth-10,Math.floor(out.clientHeight/2)-12))
 K.repl(KC(q))
 fillsvg();if(svg.childElementCount)ge("tty").parentNode.insertBefore(svg,ge("tty"))
}
function currentOption(){return queries.options[queries.selectedIndex]}
function load(s){
 try{
  let j=JSON.parse(s)
  clear()
  tables=j.tables;j.queries.forEach(q=>addquery(q.name,q.value))
  showtables()
 }catch(e){ac(out,ct(e.message))}
}
function importcsv(name,s){
 try{
  tables.push(fromcsv(name,s));showtables()
 }catch(e){ac(out,ct(e.message))}
}

function showtables(){rm(out)
 let T=[["name"],["rows"],["keys"]]
 tables.map(t=>{
  T[0].push(t.name);T[1].push(nt(t));T[2].push(t.k.length+":"+t.k.slice(0,3).join(",")+"..")
 })
 ac(out,th(flip(T)))
 ac(out,ce("hr"))

 let dl=ac(out,ce("a"));dl.textContent="save ";
 let x=new Blob([us(JSON.stringify({tables:tables,queries:Array.from(queries.options).slice(1).map(x=>({name:x.textContent,value:x.value}))}))],{type:"application/json"})
 dl.href=URL.createObjectURL(x);dl.download="db.json"

 ac(out,ce("br"))
 ac(out,ct("load:"))
 let ld=ac(out,ce("input"));ld.type="file";ld.accept=".json"
 ld.onchange=e=>e.target.files[0].text().then(r=>load(r))
 
 ac(out,ce("br"))
 ac(out,ct("csv::"))
 let cs=ac(out,ce("input"));cs.type="file";cs.accept=".csv"
 cs.onchange=e=>e.target.files[0].text().then(r=>importcsv(e.target.files[0].name.slice(0,-4),r))

 ac(out,ce("br"))
 let cl=tc(ac(out,ce("span")),"clear");cl.classList.add("link")
 cl.onclick=clear

 ac(out,ce("br"))
 let rs=tc(ac(out,ce("span")),"reset");rs.classList.add("link")
 rs.onclick=init

 ac(out,ce("hr"))
 ac(out,ce("pre")).textContent=`
save/load(code and data)as json
csv import table:
 1st row names
 2nd row types i,f,s
clear(tables and queries)
reset(reload example)
 `
}
function help(){if("PRE"==out.firstElementChild.nodeName)return showtables();rm(out);fetch("ref").then(r=>r.text()).then(r=>ac(out,ce("pre")).textContent=r)}
function clear(){tables=[];Array.from(queries.options).slice(1).forEach(o=>queries.removeChild(o));addquery("prolog","/prolog\n");queries.value="";showtables()}
function fromcsv(name,x){x=x.trim().split("\n")
 let k=x[0].split(",")  //first row names
 let t=x[1].split(",")  //secnd row types, e.g. i,f,s
 let v=flip(x.slice(2).map(x=>x.split(","))).map((c,j)=>c.map(v=>("s"==t[j])?v:Number(v)))
 return{name:name,k:k,t:t,v:v}
}
function ttysize(){let mono=ge("mono");let n=mono.textContent.length;
 return[Math.floor(ge("tty").clientHeight/mono.clientHeight),Math.floor(n*ge("tty").clientWidth/mono.clientWidth)]}


let /*there be*/ K
let C=()=>new Int8Array(K.memory.buffer),I=()=>new Int32Array(K.memory.buffer),J=()=>new BigInt64Array(K.memory.buffer),F=()=>new Float64Array(K.memory.buffer),lo=x=>Number(BigInt.asUintN(32,x))
let kenv={env:{ 
 Exit:  function(x      ){},
 Args:  function(       ){return 0},
 Arg:   function(x,y    ){return 0},
 Read:  function(a,b,c  ){return -1},
 Write: function(a,b,c,d){kout(su(new Uint8Array(K.memory.buffer,c,d)));return 0},
 ReadIn:function(x,y    ){return 0},
 Native:function(x,y    ){let i=lo(x);console.log("xcal i",i,"x",x);K.dx(x);return xcal[i](K.Atx(4n,y))},
}}
function kout(s){let o=ge("tty");if(o===null){o=ce("pre");o.id="tty";ac(ge("out"),o)};o.textContent+=s}
async function kinit(a){
 let kw;await fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>kw=r) //lz(u64s(""))
 let r=await WebAssembly.instantiate(kw,kenv)
 K=r.instance.exports
 K.kinit()
 xcal=[];xreg("bar",bar);xreg("axis",axis);xreg("plot",plot);xreg("polar",polar)
 let[rows,cols]=ttysize();K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC((cols-2)+" 50")))))
 K.Grp=x=>K.Atx(10n,x)
 tables.forEach(t=>asn(t.name,KT(t)))
 K.Val(KC(a))
}
let xcal=[],xreg=(name,g)=>{xcal.push(g)
 let f=K.l2(BigInt(xcal.length-1),Ks(name))         //external function representation idx-as-verb,name
 I()[(lo(f)>>>2)-3]=1                             //arity here:monadic only
 f=(BigInt(14)<<BigInt(59))+BigInt(lo(BigInt(f))) //type tag xf
 asn(name,f)
}

KT=t=>K.Atx(K.Val(KC("+!/")),K.l2(KS(t.k),KL(t.v.map((x,i)=>("i"==t.t[i])?KI(x):("f"==t.t[i])?KF(x):KS(x))))),
KC=x=>{let r=K.mk(18,x.length  );C().set(("string"===typeof x)?us(x):x,lo(r));return r},
KF=x=>{let r=K.mk(21,x.length  );F().set(x,lo(r)>>>3);return r},
KS=x=>{let r=K.mk(20,x.length);I().set(x.map(x=>lo(Ks(x))),lo(r)>>>2);return r},
KI=x=>{let r=K.mk(19,x.length);I().set(x,lo(r)>>>2);return r},
KL=x=>{let r=K.mk(23,x.length);J().set(x,lo(r)>>>3,new BigInt64Array(x));return r},
IK=x=>{let p=lo(x)>>>2,n=K.nn(x);let r=I().slice(p,p+n);K.dx(x);return r},
FK=x=>{let p=lo(x)>>>3,n=K.nn(x);let r=F().slice(p,p+n);K.dx(x);return r},
ZK=x=>{let p=lo(x)>>>3,n=K.nn(x);let r=F().slice(p,p+2*n);K.dx(x);return r},
DK=x=>{let j=J(),p=lo(x)>>>3,r=[K.rx(j[p]),K.rx(j[1+p])];K.dx(x);return r}
Ks=x=>K.sc(KC(x)),
asn=(s,y)=>K.dx(K.Asn(Ks(s),y))

/*

fK=x=>{let r=F()[lo(x)>>>3];K.dx(x);return r},
SK=x=>{let p=lo(x)>>>2,n=K.nn(x);let r=I().slice(p,p+n).map(x=>sK(K.Ks(x)));K.dx(x);return r},
sK=x=>CK(K.cs(x)),
*/


//plot
let svg,W,pdata,legend,ax=[],newsvg=(w)=>{ax=[];pdata=[];W=w;return sA(cE("svg"),"width",w,"height",w)}

function bar(x){[x,y]=unpkg(x);pdata.push({t:"bar",x:x,y:y});return 0n}
function axis(x){ax=vec(x);return 0n}
function plot(x){[x,y]=unpkg(x);pdata.push({t:"xy",x:x,y:y});return 0n}
function polar(x){if(22!=K.tp(x))K.trap(1);x=ZK(x);pdata.push({t:"polar",x:x.filter((x,i)=>1==i%2),y:x.filter((x,i)=>0==i%2)});return 0n}

function vec(x){let t=K.tp(x);return(19==t)?IK(x):(21==t)?FK(x):K.trap(1)}
function unpkg(x,y){if(24!=K.tp(x))K.trap(1);[x,y]=DK(x);return[vec(x),vec(y)]}

function cE(x){return document.createElementNS("http://www.w3.org/2000/svg",x)}
function sA(x,...y){for(let i=0;i<y.length;i+=2)x.setAttributeNS(null,y[i],y[1+i]);return x}

function fillsvg(){if(!pdata.length)return
 limits()
 pdata.forEach((d,c)=>("bar"==d.t)?bars(d,c):("xy"==d.t)?lines(d,c):points(d,c))
 legend=[ac(svg,sA(cE("text"),"class","legend")),ac(svg,sA(cE("text"),"class","legend"))]
}
function limits(){if(ax.length)return;(pdata.findIndex(d=>d.t=="polar")<0)?xylimits():polimits()}
function polimits(){pdata.forEach(d=>{let r=Math.max(...d.x.map((x,i)=>Math.hypot(x,d.y[i])));if((!ax.length)||(r<ax[1]))ax=[-r,r,-r,r]})}
function xylimits(){let q=0
 pdata.forEach(d=>{let x0=Math.min(...d.x),x1=Math.max(...d.x),y0=Math.min(...d.y),y1=Math.max(...d.y)
  ax=(!ax.length)?[x0,x1,y0,y1]:[Math.min(ax[0],x0),Math.max(ax[1],x1),Math.min(ax[2],y0),Math.max(ax[0],y1)]
  if("bar"==d.t){ax[2]=0;q=0.5*(x1-x0)/(d.x.length-1)}
 })
 ax[0]-=q;ax[1]+=q
}
function X(x){return W*(x-ax[0])/(ax[1]-ax[0])}
function Y(y){return W*(y-ax[3])/(ax[2]-ax[3])}
function bars(d,c){let n=d.x.length,wbar=(d.x[d.x.length-1]-d.x[0])/(d.x.length-1),w=-2+X(wbar)-X(0)
 d.x.forEach((x,i)=>{let xi=2+X(x-wbar/2),yi=Y(d.y[i])
  let r=ac(svg,sA(cE("rect"),"x",xi,"y",yi,"width",w,"height",Y(0)-Y(d.y[i]),"class","link bar"))
  r.onclick=barclick
  r.dataset.xtext=short(x)
  r.dataset.ytext=short(d.y[i]);
  r.dataset.x=xi+w/2;r.dataset.y=yi;r.dataset.shift=(y[i]<0.8*ax[3])?"50%":"-100%"
 })
}
function lines(d,c){
 let l=ac(svg,sA(cE("polyline"),"class","line stroke"+c%4,"points",(Array.from(d.x).map((x,i)=>X(x)+","+Y(d.y[i])).join(" "))))
 d.x.forEach((x,i)=>{
  let p=ac(svg,sA(cE("circle"),"cx",X(x),"cy",Y(d.y[i]),"r",10,"class","link","fill","transparent"))
  p.onclick=lineclick
  p.dataset.x=X(x);p.dataset.y=Y(d.y[i]);p.dataset.xtext="x: "+short(x);p.dataset.ytext="y: "+short(d.y[i])
 })
}
function points(d,c){let R=W/2
 if(!svg.childNodes.length){
  ac(svg,sA(cE("circle"),"cx",R,"cy",R,"r",R,"stroke","grey","stroke-width",3))
  ac(svg,sA(cE("line"),"x1",0,"x2",W,"y1",R,"y2",R,"stroke","grey","stroke-width",2))
  ac(svg,sA(cE("line"),"y1",0,"y2",W,"x1",R,"x2",R,"stroke","grey","stroke-width",2))
  let a=[30,60,120,150,210,240,300,330].map(x=>x*Math.PI/180)
  a.forEach(a=>ac(svg,sA(cE("line"),"x1",R+0.95*R*Math.cos(a),"y1",R+0.95*R*Math.sin(a),"x2",R+R*Math.cos(a),"y2",R+R*Math.sin(a),"stroke","grey","stroke-width",2)))
 }
 d.x.forEach((x,i)=>{
  let p=ac(svg,sA(cE("circle"),"cx",X(x),"cy",Y(d.y[i]),"r",5,"fill","red"))
 })
}
function short(x){let r=String(x);return(r.length>7)?x.toPrecision(6):x}
function unhighlight(){svg.childNodes.forEach(x=>x.classList.remove("hibar","highpoint"))}
function barclick(e){
 unhighlight();e.target.classList.add("hibar");let d=e.target.dataset;
 sA(legend[0],"x",d.x,"y",W,"baseline-shift","50%").textContent=d.xtext
 sA(legend[1],"x",d.x,"y",d.y,"baseline-shift",d.shift).textContent=d.ytext
}
function lineclick(e){
 unhighlight();e.target.classList.add("hipoint");let d=e.target.dataset;
 sA(legend[1],"x",d.x,"y",d.y,"baseline-shift","50%").textContent=d.ytext
 sA(legend[0],"x",d.x,"y",d.y,"baseline-shift","-100%").textContent=d.xtext
}

</script></body></html>
