<!DOCTYPE html>
<head><meta charset="utf-8"><title>db</title>
<link rel="manifest" href="db.webmanifest">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<meta name="theme-color" content="black"/>
<style>
*{font-size:x-large;font-family:monospace;box-sizing:border-box}
html{margin:0;padding:0}
body{min-height:100vh;margin:0;padding:0;overflow:hidden}
caption{border-bottom:1px solid}
.but:active{transform:translateY(2px)}
.topborder{border-top:1px solid}
a,.link{text-decoration:underline;color:blue;y-padding:1em}
.link:hover{cursor:pointer}
#buttons{display:none;height:2em;font-weight:bold;border:2px solid black;border-radius:6px;background:#fff}
#queries{position:absolute;top:0;width:calc(100% - 2em);height:2em;text-align:center;font-weight:bold;border:2px solid black;border-radius:6px;background:#fff}
#buttons{position:absolute;top:0;right:0;width:2em;height:2em;font-weight:bold;border:2px solid black;border-radius:6px;background:#fff}

#out{position:absolute;width:100%;height:calc(100vh - 2em);top:2em;background:#efe}
#kout{margin:0.5em;height:50%;overflow-y:auto}
#mono{position:absolute;left:100;top:100;visibility:hidden}
#editor{width:100%;padding:0;height:calc(50vh - 2em);resize:none;border:none;outline:none;overflow:auto;padding:0.5em;white-space:pre;background:#ffe}
</style>
</head>
<body onload="init()">

<select id="queries" onchange="querychange()">
 <option value="">[tables]</option>
</select>
<select id="buttons" onchange="addelquery(this.value)"><option>..</option><option value="add">+</option><option value="del">-</option><option value="share">â†‘</option></select>

<div id="out"></div>

<pre id="mono">M 0 1 2 3 4 5 6 7 8 9 0</pre>   <!--measure console size-->

<script>
let tables=[{name:"A",k:["alpha","beta","gamma"],t:"ifs",v:[[1,2,3,4],[2.3,4.5,1.234,-4.2],["hans","peter","werner","florian"]]}]

let init=async()=>{
 window.onerror=(a,b,c)=>{out.appendChild(ce("br"));out.appendChild(document.createTextNode(a+" (at "+c+")"))}
 await fetch("db").then(r=>r.text()).then(r=>tables=[fromcsv("t","id,type,time,dist,coords\ni,s,f,f,i\n"+r.replaceAll(" ",","))])
 await fetch("queries").then(r=>r.text()).then(r=>r.split(/\n\/\//).slice(1).map(x=>{x=x.trim().split("\n");addquery(x[0],"/"+x[0]+"\n"+x.slice(1).join("\n"))}))
 queries.value=""
 showtables()
}
function ge(x){return document.getElementById(x)}
function ce(x){return document.createElement(x)}
function ct(x){return document.createTextNode(x)}
function tc(x,y){x.textContent=y;return x}
function ac(x,y){x.appendChild(y);return y}
function th(t){let T=ce("table");t.forEach((r,i)=>{let R=ce("tr");ac(T,R);r.forEach(c=>{ac(R,tc(ce(i?"td":"th"),c))})});return T}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}}
function rm(p){while(p.firstChild)p.removeChild(p.firstChild);return p}
function u64s(s){let c=function(x){const r=new Uint8Array(x.length);for(let i=0;i<x.length;i++)r[i]=x.charCodeAt(i);return r};return c(atob(s))}
function flip(x){
 let n=x.length,m=x[0].length,r=[]
 for(let i=0;i<m;i++)r[i]=Array(n)
 for(let i=0;i<n;i++){for(let j=0;j<m;j++)r[j][i]=x[i][j]}
 return r
}
const td_=new TextDecoder("utf-8"),su=x=>td_.decode(x)
const te_=new TextEncoder("utf-8"),us=x=>te_.encode(x)


let out=ge("out"),queries=ge("queries")

function vt(t){}
function nt(t){return(0==t.v.length)?0:t.v[0].length}
function Nt(t){return tables.length}
function pads(v){let m=Math.max(...v.map(x=>x.length));return v.map(x=>pad(x,m))}
function pad(s,n){return s+" ".repeat(Math.max(0,n-s.length))}

function addelquery(q){("add"==q)?newquery():("del"==q)?delquery():("share"==q)?sharequery():0;querychange()}
function addquery(name,q){let o=ce("option");o.textContent=name;o.value=q;ac(queries,o);queries.value=o.value}
function delquery(){queries.removeChild(currentOption())}
function sharequery(){let v=currentOption().value;const f=new File([v],v.split("\n")[0].slice(1),{type:"text/plain"});navigator.share({files:[f]})}
function newquery(){addquery("query "+queries.options.length,"`answer"+queries.options.length)}
async function querychange(){
 let q=currentOption().value,b=ge("buttons");b.style.display=q.length?"block":"none"
 if(""==q)       return showtables()
 rm(out);b.value="..";let e=ce("textarea");e.id="editor";e.value=currentOption().value;ac(out,e)
 e.onchange=()=>{currentOption().value=e.value;tc(currentOption(),e.value.split("\n")[0].slice(1,41));querychange()}
 runquery(q)
}
async function runquery(q){
 let p=ce("pre");p.id="kout";ac(out,p)
 await kinit(queries.options[1].value) //always start with prolog
 K.repl(KC(q.trim()))
}
function currentOption(){return queries.options[queries.selectedIndex]}
function load(s){
 try{
  let j=JSON.parse(s)
  clear()
  tables=j.tables;j.queries.forEach(q=>addquery(q.name,q.value))
  showtables()
 }catch(e){ac(out,ct(e.message))}
}
function importcsv(name,s){
 try{
  tables.push(fromcsv(name,s));showtables()
 }catch(e){ac(out,ct(e.message))}
}

function showtables(){rm(out)
 let T=[["name"],["rows"],["keys"]]
 tables.map(t=>{
  T[0].push(t.name);T[1].push(nt(t));T[2].push(t.k.slice(0,3).join(",")+"..")
 })
 ac(out,th(flip(T)))
 ac(out,ce("hr"))

 let dl=ac(out,ce("a"));dl.textContent="save ";
 let x=new Blob([us(JSON.stringify({tables:tables,queries:Array.from(queries.options).slice(1).map(x=>({name:x.textContent,value:x.value}))}))],{type:"application/json"})
 dl.href=URL.createObjectURL(x);dl.download="db.json"

 ac(out,ce("br"))
 ac(out,ct("load:"))
 let ld=ac(out,ce("input"));ld.type="file";ld.accept=".json"
 ld.onchange=e=>e.target.files[0].text().then(r=>load(r))
 
 ac(out,ce("br"))
 ac(out,ct("csv::"))
 let cs=ac(out,ce("input"));cs.type="file";cs.accept=".csv"
 cs.onchange=e=>e.target.files[0].text().then(r=>importcsv(e.target.files[0].name.slice(0,-4),r))

 ac(out,ce("br"))
 let cl=tc(ac(out,ce("span")),"clear");cl.classList.add("link")
 cl.onclick=clear

 ac(out,ce("br"))
 let rs=tc(ac(out,ce("span")),"reset");rs.classList.add("link")
 rs.onclick=init

 ac(out,ce("hr"))
 ac(out,ce("pre")).textContent=`
save/load(code and data)as json
csv import table:
 1st row names
 2nd row types i,f,s
clear(tables and queries)
reset(reload example)
 `
}
function clear(){tables=[];Array.from(queries.options).slice(1).forEach(o=>queries.removeChild(o)); showtables()}
function fromcsv(name,x){x=x.trim().split("\n")
 let k=x[0].split(",")  //first row names
 let t=x[1].split(",")  //secnd row types, e.g. i,f,s
 let v=flip(x.slice(2).map(x=>x.split(","))).map((c,j)=>c.map(v=>("s"==t[j])?v:Number(v)))
 return{name:name,k:k,t:t,v:v}
}
function ttysize(){let mono=ge("mono");let n=mono.textContent.length;
 return[Math.floor(ge("kout").clientHeight/mono.clientHeight),Math.floor(n*ge("kout").clientWidth/mono.clientWidth)]}

let /*there be*/ K
let C=()=>new Int8Array(K.memory.buffer),I=()=>new Int32Array(K.memory.buffer),J=()=>new BigInt64Array(K.memory.buffer),F=()=>new Float64Array(K.memory.buffer),lo=x=>Number(BigInt.asUintN(32,x))
let kenv={env:{ 
 Exit:  function(x      ){},
 Args:  function(       ){return 0},
 Arg:   function(x,y    ){return 0},
 Read:  function(a,b,c  ){return -1},
 Write: function(a,b,c,d){kout(su(new Uint8Array(K.memory.buffer,c,d)));return 0},
 ReadIn:function(x,y    ){return 0},
 Native:function(x,y    ){return 0},
}}
function kout(s){let o=ge("kout");if(o===null){o=ce("pre");o.id="kout";ac(ge("out"),o)};o.textContent+=s}
async function kinit(a){
 let kw;await fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>kw=r) //lz(u64s(""))
 let r=await WebAssembly.instantiate(kw,kenv)
 K=r.instance.exports
 K.kinit()
 let[rows,cols]=ttysize();K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cols+" 50")))))
 K.Grp=x=>K.Atx(10n,x)
 tables.forEach(t=>asn(t.name,KT(t)))
 K.Val(KC(a))
}
let lz/*4(uncompress)*/=(x)=>{let i=7,j,n,t,c,o,r=[],S=-(1<<31),R=(x,a,n)=>{for(j=0;j<n;j++)r.push(x[a+j]);return n},
 h=()=>x[i++]|x[i++]<<8,C=()=>{if(c===15)do{c+=x[i]}while(x[i++]==255)},
 d=n=>{while(i<n){t=x[i++];c=t>>4;C();i+=R(x,i,c);if(i<n){c=t&15;o=r.length-h();C();R(r,o,4+c)}}}
 while(n=h()|h()<<16)(n&S)?i+=R(x,i,n&~S):d(i+n);return new Uint8Array(r)},

KT=t=>K.Atx(K.Val(KC("+!/")),K.l2(KS(t.k),KL(t.v.map((x,i)=>("i"==t.t[i])?KI(x):("f"==t.t[i])?KF(x):KS(x))))),
KC=x=>{let r=K.mk(18,x.length  );C().set(("string"===typeof x)?us(x):x,lo(r));return r},
KF=x=>{let r=K.mk(21,x.length  );F().set(x,lo(r)>>>3);return r},
KS=x=>{let r=K.mk(20,x.length);I().set(x.map(x=>lo(Ks(x))),lo(r)>>>2);return r},
KI=x=>{let r=K.mk(19,x.length);I().set(x,lo(r)>>>2);return r},
KL=x=>{let r=K.mk(23,x.length);J().set(x,lo(r)>>>3,new BigInt64Array(x));return r},
Ks=x=>K.sc(KC(x)),
asn=(s,y)=>K.dx(K.Asn(Ks(s),y))

/*
FK=x=>{let p=lo(x)>>>3,n=K.nn(x);let r=F().slice(p,p+n);K.dx(x);return r},
fK=x=>{let r=F()[lo(x)>>>3];K.dx(x);return r},
IK=x=>{let p=lo(x)>>>2,n=K.nn(x);let r=I().slice(p,p+n);K.dx(x);return r},
SK=x=>{let p=lo(x)>>>2,n=K.nn(x);let r=I().slice(p,p+n).map(x=>sK(K.Ks(x)));K.dx(x);return r},
sK=x=>CK(K.cs(x)),
*/


</script></body></html>
