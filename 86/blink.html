<!doctype html>
<html><head><meta charset=utf-8><title>blink</title>
<style>
#controls{display:none!important}
#output{display:none!important}[class^=emscripten]:has(canvas){display:none!important}
.blink{display:block;margin-top:5px;margin-bottom:5px}
.blink-terminal{width:100%;margin:0 auto;margin-top:10px;border-left:0;border-right:0px;padding-left:0;padding-right:0;display:block;background-color:#000;color:#fff;font-family:'Lucida Console',Monaco,monospace;outline:0}

.l{color:blue}
.l:hover{cursor:pointer}
.b{width:100%;text-align:start;border:1px solid;background:#eee;font-family:monospace;}
.b:hover{cursor:pointer}
</style><script src=coi-serviceworker.js></script>

<script src=xterm.min.js></script>
<link href=xterm.css rel=stylesheet>

<style>
body{font-family:arial;margin:0;padding:none}
.emscripten{padding-right:0;margin-left:auto;margin-right:auto;display:block}
div.emscripten{text-align:center}
div.emscripten_border{border:1px solid #000}
canvas.emscripten{border:0 none;background-color:#000}
#emscripten_logo{display:inline-block;margin:0}
@-webkit-keyframes rotation{from{-webkit-transform:rotate(0)}to{-webkit-transform:rotate(360deg)}}@-moz-keyframes rotation{from{-moz-transform:rotate(0)}to{-moz-transform:rotate(360deg)}}@-o-keyframes rotation{from{-o-transform:rotate(0)}to{-o-transform:rotate(360deg)}}
@keyframes rotation{from{transform:rotate(0)}to{transform:rotate(360deg)}}
#status{display:inline-block;vertical-align:top;margin-top:30px;margin-left:20px;font-weight:700;color:#787878}
#progress{height:20px;width:300px}
#controls{display:inline-block;float:right;vertical-align:top;margin-top:30px;margin-right:20px}
#output{width:100%;height:200px;margin:0 auto;margin-top:10px;border-left:0;border-right:0px;padding-left:0;padding-right:0;display:block;background-color:#000;color:#fff;font-family:'Lucida Console',Monaco,monospace;outline:0}
</style></head>

<body>
<div class=spinner id=spinner></div>
<div class=emscripten id=status>Downloading...</div>
<span id=controls>
 <span><input type=checkbox id=resize>Resize canvas</span><span><input type=checkbox id=pointerLock checked>Lock/hide mouse pointer</span></span>
 <div class=emscripten><progress hidden id=progress max=100 value=0></progress></div>
 <div class=emscripten_border><canvas class=emscripten id=canvas oncontextmenu=event.preventDefault() tabindex=-1></canvas></div>
 <textarea id=output rows=8></textarea>
 
 <script>
 var statusElement=document.getElementById("status"),progressElement=document.getElementById("progress"),spinnerElement=document.getElementById("spinner"),stdinBuffer=[],terminal=new Terminal({convertEol:!0});
 terminal.onData((function(e){for(var t=0;t<e.length;++t)stdinBuffer.push(e.charCodeAt(t))}));
 var Module={
  preRun:[function(){let e={get_char:function(e){return stdinBuffer.length>0?stdinBuffer.shift():void 0},put_char:function(e,t){terminal.write(new Uint8Array([t]))},flush:function(e){},fsync:function(e){},poll:function(e){return stdinBuffer.length>0?5:4}};
  TTY.register(FS.makedev(5,0),e),TTY.register(FS.makedev(6,0),e),FS.devices[FS.makedev(5,0)].stream_ops.poll=e.poll,FS.devices[FS.makedev(6,0)].stream_ops.poll=e.poll}],postRun:[],
  canvas:function(){var e=document.getElementById("canvas");return e.addEventListener("webglcontextlost",(function(e){alert("WebGL context lost. You will need to reload the page."),e.preventDefault()}),!1),e}(),
  setStatus:function(e){if(Module.setStatus.last||(Module.setStatus.last={time:Date.now(),text:""}),e!==Module.setStatus.last.text){
  var t=e.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/),n=Date.now();t&&n-Module.setStatus.last.time<30||(Module.setStatus.last.time=n,Module.setStatus.last.text=e,t?(e=t[1],progressElement.value=100*parseInt(t[2]),
  progressElement.max=100*parseInt(t[4]),progressElement.hidden=!1,spinnerElement.hidden=!1):(progressElement.value=null,progressElement.max=null,progressElement.hidden=!0,e||(spinnerElement.style.display="none")),statusElement.innerHTML=e)}},
  totalDependencies:0,monitorRunDependencies:function(e){this.totalDependencies=Math.max(this.totalDependencies,e),Module.setStatus(e?"Preparing... ("+(this.totalDependencies-e)+"/"+this.totalDependencies+")":"All downloads complete.")}};
  Module.setStatus("Downloading..."),window.onerror=function(e){Module.setStatus("Exception thrown, see JavaScript console"),spinnerElement.style.display="none",Module.setStatus=function(e){e&&console.error("[post-exception status] "+e)}}
 </script>
 <script src=blink.js async></script>
 <div class="blink blink-terminal"id=terminal></div>
 <!--div class=blink>Upload an executable file:</div>
 <div class=blink><input type=file id=fileInput onchange='fileLoad(event,"executable")'>
 </div><div class=blink><textarea id=argsInput rows=4 class=blink-terminal placeholder="Space-separated arguments for the target binary...">
 </textarea></div><button id=runButton onclick=runExecutable()>Run</button-->
 
 <div style="display:flex;gap:1em">
 <div><pre id="dir" style="display:inline;width:fit-content"></pre>
  <button class="b" onclick="kexe(['a.k','ptree.k'])"        >/k a.k ptree.k</button></br>
  <button class="b" onclick="kexe(['a.k','as.k'],'a.as')"    >/k a.k as.k>a.as</button></br>
  <button class="b" onclick="exec(this.textContent.slice(1))">$fasm a.as</button></br>
  <button class="b" onclick="exec(this.textContent.slice(1))">$a</button></br>
 </div>
 <textarea id="edt" style="width:100%"></textarea>
 </div>
 
 <script>
 function fileLoad(e,t){var n=e.target.files[0],a=new FileReader;a.onloadend=function(e){e.target.readyState==FileReader.DONE&&FS.writeFile(t,new Uint8Array(e.target.result),{encoding:"binary",mode:493})},a.readAsArrayBuffer(n)}
 function runExecutable(){let e=["executable"].concat(document.getElementById("argsInput").value.split(" ").filter((e=>""!=e)));Module.callMain(e)}
 terminal.open(document.getElementById("terminal"))
 
 let fe=(x,y)=>fetch(x).then(r=>r.arrayBuffer()).then(r=>{FS.writeFile(y,new Uint8Array(r),{encoding:"binary",mode:493});ls()})
 fe("fasm.elf","fasm")
 fe("a.as","a.as")
 fe("../compile/tests/swt.k","a.k")
 fe("ptree.k","ptree.k")
 fe("../compile/as.k","as.k")
 
 let su=x=>t_.decode(x),t_=new TextDecoder("utf-8"),us=x=>_t.encode(x),_t=new TextEncoder("utf-8")
 let xxd=(x,s,i,o,O)=>(i=0,o="",O=x=>o+=x,s="  ",x.forEach((x,i)=>{if(0==i%16)(O((i?s+"\n":"")+i.toString(16).padStart(8,'0')+":"),s="  ");if(0==i%2)O(" ");O(x.toString(16).padStart(2,'0'));s+=(x>31&&x<127)?String.fromCharCode(x):"."}),(i=x.length%16),O(i?" ".repeat(2.5*(16-x.length%16)):""+s),o)
 let ls=_=>{let r="";let d=FS.readdir(".");d.forEach((f,i)=>r+=(i<6?f:`<span class="l" onclick='ed("${f}")'>${f}</span>`)+(" ".repeat(10-f.length))+String(FS.stat(f).size).padStart(12," ")+"\n");dir.innerHTML=r}
 let ed=x=>{let u=FS.readFile(x);edt.value=u.lenth==0?"":u[0]==0x7f?xxd(u):su(u)}
 let exec=x=>{try{Module.callMain(x.split(" "))}catch(e){ls()}}
 
 
 
 let kexe=(argv,tofile)=>{
  let K,lo=x=>Number(BigInt.asUintN(32,x)),af=Array.from,qa=x=>af(document.querySelectorAll(x))
  let C=()=>new Int8Array(K.memory.buffer)
  let KC=x=>{x=("string"===typeof x)?us(x):x;let r=K.mk(18,x.length);C().set(x,lo(r));return r}
  let kenv={env:{
   Exit:  function(x      ){},
   Args:  function(       ){return 0},
   Arg:   function(x,y    ){return 0},
   Read:  function(a,b,c  ){return -1},
   Write: function(a,b,c,d){let u=new Uint8Array(K.memory.buffer),v=u.slice(c,c+d),f=u.slice(a,a+b);edt.value+=su(v);return 0},
   ReadIn:function(x,y    ){return 0},
   Native:function(x,y  ,i){return 0}}}
  
  let kinit=_=>{
   let n,nk=x=>{n=x.byteLength;return x}
   fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(nk(r),kenv)).then(r=>{
    K=r.instance.exports;K.kinit();
    K.repl(KC('`l:(.`"lxy.")100 30'))
    edt.value="";argv.forEach(x=>K.dx(K.Val(KC(FS.readFile(x)))))
    if(tofile){FS.writeFile(tofile,us(edt.value));ls()}
   })}
  kinit()}
 
 //from: https://jart.github.io/blink/blink.html, needs: jart.github.io/blink/{blink.js,coi-serviceworker.js,xterm.min.js,xterm.css,blink.wasm}
 
 </script>

</body></html>
