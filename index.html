<html>
<head><meta charset="utf-8"><title>w</title></head>
<link rel='icon' type'image/png' href="k32.png">
<style>
 html,body,textarea{height:100%;margin:0;padding:0;overflow:hidden;}
 #kons{top:0;left:0;width:100%;height:100%;position:absolute;border:0pt;resize:none;font-family:monospace;overflow:auto;}
 .term{background:black;color:white}
 .hold{background:white;color:black}
 .edit{background:#ffffea;color:black}
 #cnv{width:100;height:100;top:0;right:0;position:absolute;}
 #dl{display:none;}
</style>
<body>
<textarea id="kons" class="term" wrap="off" autofocus spellcheck="false"></textarea>
<canvas id="cnv"></canvas>
<script>
var r = "AGFzbQEAAAABEANgAX8Bf2ACf38Bf2ABfwADERAAAQEAAQICAgIAAAAAAQEBBQMBAAEHYREDbWVtAgADaW5pAAACYmsAAQJtawACA21raQADA21rZAAEAmZyAAUCZHgABgJyeAAHAnJsAAgDdGlsAAkDdGlyAAoDcmV2AAsDZnN0AAwDYXR4AA0DcnNoAA4DdGFrAA8KngwQTQEDf0EAQoCCkMCAgoECNwMAQYABIAA2AgBBgAIhAUEIIQICQANAIAIgAElFDQFBBCACbCABNgIAIAFBAmwhASACQQFqIQIMAAsLIAALEwECf0EgQQcgASAALQAAbGpnawueAQEHfyAAIAEQASECQQQgAmwhAwJAA0AgAygCAEVFDQEgA0EEaiEDDAALC0GAASADRgRAAAsgAygCACEEIAMgBCgCADYCACADQQRrIQUCQANAIAVBBCACbE9FDQEgBEEBIAVBAnZ0aiEGIAYgBSgCADYCACAFIAY2AgAgBUEEayEFDAALCyAEIAEgAEEddHI2AgAgBEEEakEBNgIAIAQLGAECf0ECQQEQAiEBIAFBCGogADYCACABC3IBCX8gACgCAEEddiECIAAoAgBB/////wFxIQNBCCAAaiEEIAEoAgBBHXYhBSABKAIAQf////8BcSEGQQggAWohByACQQVGBEAACyADIAZGBEAAC0EHQQIQAiEIIAhBCGogADYCACAIQQxqIAE2AgAgCAs/AQV/IAAoAgBBHXYhASAAKAIAQf////8BcSECQQggAGohA0EEIAEgAhABbCEEIAAgBCgCADYCACAEIAA2AgALMAECfyAAQf8BSwRAIABBBGooAgAhASAAQQRqIAFBAWs2AgBBASABRgRAIAAQBQsLCyEBAX8gAEH/AUsEQCAAQQRqIQAgAEEBIAAoAgBqNgIACwtNAQV/IAAoAgBBHXYhASAAKAIAQf////8BcSECQQggAGohAyAAQQhqIQAgAgRAQQAhBANAIAAQByAAQQRqIQAgBEEBaiIEIAJJDQALCwt/AQh/IAAoAgBBHXYhASAAKAIAQf////8BcSECQQggAGohA0ECIAFGRQRAAAsgAygCACEEIAAQBiAEQQBIBEBBACAEaxAKDwsgASAEEAIhBUEIIAVqIQYgBARAQQAhBwNAIAYgBzYCACAGQQRqIQYgB0EBaiIHIARJDQALCyAFC0EBBH9BAiAAEAIhAUEEIAFBBCAAbGpqIQIgAARAQQAhAwNAIAIgAzYCACACQQRrIQIgA0EBaiIDIABJDQALCyABCzQBBH8gACgCAEEddiEBIAAoAgBB/////wFxIQJBCCAAaiEDIAJFBEAgAA8LIAAgAhAKEA0LRgEEfyAAKAIAQR12IQEgACgCAEH/////AXEhAkEIIABqIQMgAUEHRgRAQQwgAGoQByAAEAZBDCAAahAMDwsgAEEAEAMQDQuAAwEMfyAAKAIAQR12IQIgACgCAEH/////AXEhA0EIIABqIQQgASgCAEEddiEFIAEoAgBB/////wFxIQZBCCABaiEHIAJBB0YEQAALIAVBAkZFBEAACyACIAYQAiEIIAhBCGohCQJAAkACQAJAAkACQCACDgQAAQIDBAsADAQLIAYEQEEAIQsDQCAJIAtqQSA6AAAgBygCACEKIAogA0kEQCAJIAtqIAQgCmotAAA6AAALIAdBBGohByALQQFqIgsgBkkNAAsLDAMLIAYEQEEAIQsDQCAJQYCAgIB4NgIAIAcoAgAhCiAKIANJBEAgCSAEQQQgCmxqKAIANgIACyAJQQRqIQkgB0EEaiEHIAtBAWoiCyAGSQ0ACwsMAgsgBgRAQQAhCwNAIAlEAQAAAAAA+H85AwAgBygCACEKIAogA0kEQCAJIARBCCAKbGorAwA5AwALIAlBCGohCSAHQQRqIQcgC0EBaiILIAZJDQALCwwBCwAMAAsgABAGIAEQBiAIC18BCH8gACgCAEEddiECIAAoAgBB/////wFxIQNBCCAAaiEEIAEoAgBBHXYhBSABKAIAQf////8BcSEGQQggAWohByACQQJGRQRAIAAPCyADQQFGBEAgACABEA8PCyABC4wBAQx/IAAoAgBBHXYhAiAAKAIAQf////8BcSEDQQggAGohBCABKAIAQR12IQUgASgCAEH/////AXEhBkEIIAFqIQcgBCgCACEIIAAQCSEJIAlBCGohCiAGIAhJBEAgCARAQQAhCwNAIApBBCALbGogCyAGcDYCACALQQFqIgsgCEkNAAsLCyABIAkQDQs="
var rt = "NSBta2kgICAgICAgICAgICAgICAgICAgICAgICAvNQo1IG1raSB0aWwgICAgICAgICAgICAgICAgICAgIC8wIDEgMiAzIDQKNSBta2kgdGlsIHJldiAgICAgICAgICAgICAgICAvNCAzIDIgMSAwCiJhYmNkIiAgICAgICAgICAgICAgICAgICAgICAgLyJhYmNkIgoiYWJjZCIgcmV2ICAgICAgICAgICAgICAgICAgIC8iZGNiYSIKMSwyLDMgICAgICAgICAgICAgICAgICAgICAgICAvMSAyIDMKMSwyLiwzICAgICAgICAgICAgICAgICAgICAgICAvMSAyIDNmCjQsNSwzLDIgcmV2ICAgICAgICAgICAgICAgICAgLzIgMyA1IDQKNCw1LDMsMiAgMSwzIGF0eCAgICAgICAgICAgICAvNSAyCjQsNSwzLDIuIDEsMyBhdHggICAgICAgICAgICAgLzUgMmYKNSBta2kgdGlsIHJldiAzIG1raSB0aWwgYXR4ICAvNCAzIDIKMyBta2kgdGlsIHJldiA1IG1raSB0aWwgYXR4ICAvMiAxIDAgME4gME4KImFiYyIgNCBta2kgdGlsIGF0eCAgICAgICAgICAvImFiYyAiCjUgbWtpIHRpbCByZXYgZnN0ICAgICAgICAgICAgLzQKMyBta2kgNSBta2kgdGlsIHJzaCAgICAgICAgICAvMCAxIDIKNSBta2kgMyBta2kgdGlsIHRhayAgICAgICAgICAvMCAxIDIgMCAxCg=="
var rs = "aW5pOkk6SXswOjoxMTMwMzY2ODA3MzEwNTkyajsxMjg6Ong7cDoyNTY7aTo4OyhpPHgpPy8oKDQqaSk6OnA7cCo6MjtpKzoxKTt4fSAveDoxNig2NGspCmJrOkk6SUl7MzItKjcreSpJP0MgeH0KbWs6STpJSXt0OnggYmsgeTtpOjQqdDsofkkgaSk/L2krOjQ7KDEyOH5pKT8hO2E6SSBpO2k6OkkgYTtqOmktNDsoaj49NCp0KT8vKHU6YSsxPDxqPj4yO3U6OkkgajtqOjp1O2otOjQpO2E6Onl8eDw8Mjk7KGErNCk6OjE7YX0KbWtpOkk6SXtyOjIgbWsgMTsocis4KTo6eDtyfW1rZDpJOklJe3YyOyh4dH41KT8hOyh4bn55bik/ITtyOjcgbWsgMjsocis4KTo6eDsocisxMik6Onk7cn0KdjE6e3h0OihJIHgpPj4yOTt4bjooSSB4KSY1MzY4NzA5MTE7eHA6OCt4fXYyOnt2MTt5dDooSSB5KT4+Mjk7eW46KEkgeSkmNTM2ODcwOTExO3lwOjgreX0KZnI6MDpJe3YxO3Q6NCp4dCBiayB4bjt4OjpJIHQ7dDo6eH1keDowOkl7KHg+MjU1KT8oeHI6SSB4KzQ7KHgrNCk6OnhyLTE7KDF+eHIpP2ZyIHgpfWR4cjp7ZHggeDtyfWR4eXI6e2R4IHg7ZHggeTtyfXJ4OjA6SXsoeD4yNTUpPyh4Kzo0O3g6OjErSSB4KX1ybDowOkl7djE7eCs6ODt4bi8ocnggeDt4Kzo0KX0KdGlsOkk6SXt2MTsofjJ+eHQpPyE7bjpJIHhwO2R4IHg7KG48JzApPyA6dGlyIC1uO3I6eHQgbWsgbjtycDo4K3I7bi8ocnA6Omk7cnArOjQpO3J9dGlyOkk6SXtyOjIgbWsgeDtycDo0K3IrNCp4O3gvKHJwOjppO3JwLTo0KTtyfQpyZXY6STpJe3YxOyh+eG4pPyA6eDt4IGF0eCB0aXIgeG59CmZzdDpJOkl7djE7KHh0fjcpPyhyeCAxMit4O2R4IHg7IDpmc3QgMTIreCk7eCBhdHggbWtpIDB9CmF0eDpJOklJe3YyOyh4dH43KT8hOyh+eXR+Mik/ITtyOnh0IG1rIHluO3JwOnIrODt4dD9bITthdEM7YXRJO2F0RjshXTtkeHlyfQphdEM6eyh5bi8oKHJwK2kpOjpDPzMyO3lpOkkgeXA7KHlpPHhuKT8ocnAraSk6OkMgeHAreWk7eXArOjQpKX0KYXRJOnsoeW4vKHJwOjpuYUk7eWk6SSB5cDsoeWk8eG4pP3JwOjpJIHhwKzQqeWk7cnArOjQ7eXArOjQpKX1uYUk6ey0yMTQ3NDgzNjQ4fQphdEY6eyh5bi8ocnA6Om5hRjt5aTpJIHlwOyh5aTx4bik/cnA6OkYgeHArOCp5aTtycCs6ODt5cCs6NCkpfW5hRjp7OTIyMTEyMDIzNzA0MTA5MDU2MWZ9CnJzaDpJOklJe3YyOyh+eHR+Mik/IDp4Oyh4bn4xKT8gOnggdGFrIHk7eX0gL255aSByc2gKdGFrOkk6SUl7djI7bjpJIHhwO3I6dGlsIHg7cnA6cis4Oyh5bjxuKT8obi8ocnArNCppKTo6aVx5bik7eSBhdHggcn0KCg=="
function sa(s){var r=new Uint8Array(new ArrayBuffer(s.length));for(var i=0;i<s.length;i++)r[i]=s.charCodeAt(i);return r}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}};
function ae(x,y,z){x.addEventListener(y,z)};
var kwasm = sa(atob(r))
var tests = atob(rt)
var src = atob(rs)
var K
// kons (k console)
var hit = kons
var konstore = ""
var edname = ""
var ed = false
function initKons() {
 kons.value = "kwasm(1718 b) 2020.03.05 tests src ini bk mk mki mkd til tir rev fst atx rsh tak\n "
 var hold = false
 kons.onkeydown = function(e) {
  if(e.which === 27) { // quit edit / toggle hold / close image
   delay = 0
   pd(e)
   if (ed) { qed(); hold=true }
   hold = !hold
   kons.className = (hold) ? "hold" : "term"
   imgSize(0, 0)
   hit = kons
  } else if (e.which === 13 && !hold && !ed) { // execute
   pd(e)
   var a = kons.selectionStart
   var b = kons.selectionEnd
   var s = kons.value.substring(a, b)
   if (b == a) {
    if (kons.value[a] == "\n") a -= 1
    a = kons.value.lastIndexOf("\n", a)
    if (a == -1) a = 0
    b = kons.value.indexOf("\n", b)
    if (b == -1) b = kons.value.length
    s = kons.value.substring(a, b)
   }
   if (kons.selectionEnd != kons.value.length) O(s)
   O("\n")
   s = s.trim()
   if (s === "tests")           { O(tests);                        return }
   if (s === "src")             { O(src);                          return }
   if (s === "\\c")             { kons.value=" ";imgSize(0, 0);    return }
   if (s === "\\h")             { O(atob(h));P();                  return }
   if (s.substr(0,2) === "\\e") { P();edit(s.substr(2));           return }
   if (s.substr(0,2) === "\\w") { download(s.substr(2).trim());P();return }
   if (s.substr(0,2) === "\\L") { P();loop(s.substr(2).trim());    return }
   if (s === "\\lf")            { s = "\\m #:'.fs"                        }
   hash(s);E(s);P()
  }
 }
 kons.onmousedown = function(e) { hit=kons; if(e.button==2)pd(e); }
 kons.onblur  = function(e) { kons.style.filter = "brightness(70%)" }
 kons.onfocus = function(e) { kons.style.filter = "brightness(100%)" }
}
function O(s) { kons.value += s; kons.scrollTo(0, kons.scrollHeight) }
function P()  { kons.value += " " }

function us(s) { return new TextEncoder("utf-8").encode(s) } // uint8array from string
function su(u) { return (u.length) ? new TextDecoder("utf-8").decode(u) : "" }
function kst(x) {
 var h = K.I[x>>2]
 var t = h>>29
 var n = h&536870911
 var o = []
 switch(t){
 case 1:
  return '"'+su(K.C.slice(8+x, 8+x+n))+'"'
 case 2:
  x >>= 2
  return K.I.slice(2+x, 2+x+n).join(" ").split("2147483648").join("0N")
 case 3:
  x >>= 3
  var s = K.F.slice(1+x, 1+x+n).join(" ")
  if(s.indexOf(".")==-1) s+="f"
  return s
 default:
  return "kst nyi: t=" + String(t)
 }
}

var funcs = {"ini":1,"bk":2,"mk":2,"mki":1,"mkd":2,"til":1,"tir":1,"rev":1,"fst":1,"atx":2,"rsh":2,"tak":2}
function vector(s) {
 var t = 2
 if(s.indexOf(".") != -1) t = 3
 if(s.indexOf(",")==-1)   return 0
 if(s.startsWith(","))    s=s.substr(1)
 if(s.endsWith(","))      s=s.substr(0,s.length-1)
 var v = s.split(",").map(x=>Number(x))
 var n = v.length
 var x = K.exports.mk(t, n)
 if (t==2) for (var i=0;i<n;i++) K.I[2+i+(x>>2)] = v[i];
 else      for (var i=0;i<n;i++) K.F[1+i+(x>>3)] = v[i];
 return x
}
function chrVector(s) {
 s = s.substr(1,s.length-2)
 var n = s.length
 var x = K.exports.mk(1, n)
 console.log("chr ", x, n, K.I[x>>2])
 for (var i=0;i<n;i++) K.C[8+x+i] = s.charCodeAt(i);
 return x
}
function E(s) {
 try{ // todo save/restore
  var stack = []
  var v = s.split(" ").filter(x => x)
  for (var i=0; i<v.length; i++) {
   s = v[i]
   var x = vector(s)
   if (x!=0) { stack.push(x); continue; }
   if (s.startsWith('"')) { stack.push(chrVector(s)); continue; }
   var x = Number(s)
   var y = 0
   if(x==x) {
    stack.push(x)
   } else if(s in funcs) {
    var n = funcs[s]
    x = stack.pop()
    if(n==2) {
     y = x
     x = stack.pop()
     stack.push(K.exports[s](x, y))
     stack[stack.length-1]
    } else {
     stack.push(K.exports[s](x))
    }
   }
  }
  if(stack.length == 1) {
   x = stack[stack.length-1]
   O(kst(x)+"\n")
   K.exports.dx(x)
  }
 } catch(e) {
   O("error")
 }
}

function edit(name) { 
 edname = name; ed = true; konstore = kons.value; 
 var u = getfile(name.trim())
 kons.value = (u.length>0) ? su(u) : ""
 kons.className = "edit"
 kons.scrollTo(0,0);
}
function qed() { // quit edit
 putfile(edname, us(kons.value))
 kons.value = konstore; kons.scrollTo(0, kons.scrollHeight)
 ed = false
}
ae(kons,"contextmenu", function(e) { // button-3 search
 var l = kons.selectionEnd-kons.selectionStart; if(e.button==2&l>0) {
  pd(e); var t = kons.value.substring(kons.selectionStart,kons.selectionEnd)
  var f = function(a){ return kons.value.indexOf(t,a) }; var n = f(kons.selectionEnd)
  if (n<0){n=f(0)}; kons.setSelectionRange(n,n+l); }
})
function hash(s){window.location.hash=encodeURIComponent(s.trim())}

(async () => {
 initKons()
 const module = await WebAssembly.compile(kwasm.buffer);
 K = await WebAssembly.instantiate(module);
 K.C = new Uint8Array(K.exports.mem.buffer)
 K.I = new Uint32Array(K.exports.mem.buffer)
 K.F = new Float64Array(K.exports.mem.buffer)
 K.exports.ini(16);
 var h = decodeURIComponent(window.location.hash.substr(1))
 window.location.hash = h
 if (h.length > 0) {
  var p = kons.value.length
  kons.value += h
  kons.setSelectionRange(p, kons.value.length)
 }
 kons.focus()
})();
</script></body></html>
