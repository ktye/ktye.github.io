<head><meta charset="utf-8"><title>.</title></head>
<link rel=icon href='data:;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAACVBMVEX/AAAAAAD////KksOZAAAAMElEQVR4nGJYtWrVKoYFq1ZxMSyYhkZMgxNRXAwLpmbBCDAXSRZEgAwAGQUIAAD//+QzHr+8V1EyAAAAAElFTkSuQmCC'>
<link rel="stylesheet" href="codemirror/codemirror.min.css">

<style>
 html,body,textarea,input{overflow:hidden;font-family:monospace;}
 #term{position:absolute;top:0;right:0;width:50%;height:100%;background:black;color:#cccccc;border:none;resize:none;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;}::-webkit-scrollbar{width:0;height:0;}
 #term:focus{color:white;}.hold{background:#666666}
 .codemirror{position:absolute;top:0;left:0;width:50%;height:100%;border:none;resize:none;background:#ffffea}
 #runb{position:absolute;top:0;right:50%;font-family:monospace;z-Index:10}
 input:invalid{border:2px solid red}
</style>
<script src="codemirror/jquery.min.js"></script>
<script src="codemirror/codemirror.min.js"></script>
<script src="codemirror/matchbrackets.js"></script>

<body>
<div id="ide">
 <textarea id="edit"></textarea>
 <textarea id="term" class="term" wrap="off" spellcheck="false"></textarea>
 <button id="runb" onclick="run()">run</button>
</div><div id="uid""><form id="uiform">empty-ui</form></div>
<a id="dl" style:"display:none"></a>
<script>

function pd(e){if(e){e.preventDefault();e.stopPropagation()}};
function hash(){return decodeURIComponent(window.location.hash.substr(1))}
function ge(x){return document.getElementById(x)}
function ce(x){return document.createElement(x)}
function toggle(x){x.style.display=(x.style.display=="none")?"block":"none"}
var ide=ge("ide");ide.style.display="block"

var ed = CodeMirror.fromTextArea(edit, {"lineNumbers":false,"tabSize":8,"indentUnit":8,"indentWithTabs":true,"smartIndent":true,"matchBrackets":true})
ed.setValue(hash()); if(hash()==="")fetch('readme').then(r=>{return r.text()}).then(r=>ed.setValue(r))

// search selected: middle-button(all), right(next) (bug: mouseup(chrome), ff ok)
document.addEventListener('contextmenu',function(e){e.preventDefault()})
ed.on('mousedown', function(cm, e) {
 if     (e.button==2 && (ed.getSelection().length>0)){search(ed.getSelection(),false);pd(e)}
 else if(e.button==1 && (ed.getSelection().length>0)){search(ed.getSelection(),true );pd(e)}
})
function indexAll(a, s) { var r = [], i = -1; while ((i = a.indexOf(s, i+1)) != -1){ r.push(i); }; return r; }
function search(t, all){
 var v = ed.getValue()
 var p = ed.getCursor()
 if(all) {
  var n = indexAll(v,t)
  for(var i=0; i<n.length; i++) ed.addSelection(ed.posFromIndex(n[i]), ed.posFromIndex(n[i]+t.length), {"scroll":true})
 } else {
  var c = ed.indexFromPos(ed.getCursor())
  c = (p.sticky == "after") ? c+t.length : c
  var n = v.indexOf(t, c)
  if (n == -1) { n = v.indexOf(t, 0) }
  ed.setSelection(ed.posFromIndex(n), ed.posFromIndex(n+t.length), {"scroll":true})
 }
}


var term = ge("term")
window.addEventListener('unhandledrejection', function(e) {term.value+=String(e.reason)})
function banner(x){term.value = "ktye/k "+x.byteLength+"b\n ";return x}


var K, C, I, U, F, bak
function us(s){return new TextEncoder("utf-8").encode(s)}
function su(u){return (u.length)?new TextDecoder("utf-8").decode(u):""}
function lo(x){return Number(BigInt.asUintN(32,x))}
function ks(s){msl();s=us(s);var x=K.mk(18,s.length);C.set(s,lo(x));return x}
function sk(x){msl();x=(4==K.tp(x))?x=K.cs(x):x;var xp=lo(x);var r=su(C.slice(xp,xp+K.nn(x)));K.dx(x);return r}
function sy(x){return sk(K.cs(x))}
function la(a){msl();var r=K.mk(23,a.length);for(var i=0;i<a.length;i++)J[i+(lo(r)>>>3)]=a[i];return r}

var filename="" 
function path_open(fd,dirflags,path,pathlen,oflags,baserights,inheritrights,fdflags,res){
 msl();filename=su(C.slice(path,path+pathlen));if(oflags==0)return 1;U[res>>2]=3;return 0 //no read in js.
} 
function fd_write(fd,p,nio,nw){
 msl();var x=U[p>>>2]; var n=U[(4+p)>>>2];var u=(C.slice(x,x+n));if(fd==1){term.O(su(u))}else{download(filename,u)};return 0
}
var env={wasi_unstable:{ 
// l32:function(x){console.log(x);return x},
// l64:function(x){console.log(BigInt.asUintN(64,x));return x},
 args_get: function(a,b){return 0},
 args_sizes_get: function(a,b){return 0},
 proc_exit:function(x){console.log("exit", x)},
 fd_read:  function(a,b,c,d){console.log("read",a,b,c,d);return 0},
 fd_write: fd_write,
 fd_seek:  function(fd,o,w,r){return 0},
 fd_close: function(fd){return 0},
 path_open:path_open,
 clock_time_get:function(a,b,p){msl();J[p>>>3]=BigInt.asIntN(64, BigInt(Math.floor(1e6*performance.now())));return 0}
}}


function download(name,u){
 var dl=ge("dl");var b=new Blob([u],{type:"application/octet-stream"})
 dl.href=URL.createObjectURL(b);dl.download=name;dl.click()}

fetch('k.wasm').then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(banner(r),env)).then(r=>{
 K=r.instance.exports
 K.kinit()
 ksave()
 gettest()
})

function settest(){runb.value="test";runb.innerText="test"}
function gettest(){
 if(hash()==="test")
  fetch('k.t').then(r=>{return r.text()}).then(r=>{ed.setValue(r);settest()})
}

var bak
function msl() {
 C=new Uint8Array(K.memory.buffer)
 I=new Int32Array(K.memory.buffer)
 U=new Uint32Array(K.memory.buffer)
 J=new BigInt64Array(K.memory.buffer)
 F=new Float64Array(K.memory.buffer)}
function ksave(){ msl();bak=C.slice(0,1<<U[32]) }

function ktry(s) { 
 try      { if(typeof(s)==="function"){s()}else{K.repl(ks(s))}; ksave();return 0}
 catch(e) { console.log(e); C.set(bak); return K.Srcp() }}
function ktry(s) { if(typeof(s)==="function"){s()}else{K.repl(ks(s))}; ksave();return 0 } //unprotected


function kd(e){var N="\n";var t=e.srcElement;
 if(e.which===27){pd(e);if(t.hold){t.className="";t.selectionStart=t.hold;t.hold=0}else{t.hold=t.selectionStart;t.className="hold"}}
 if(e.which===13&&!t.hold){pd(e);let s=t.value,p=t.selectionStart,q=t.selectionEnd;
  if(p===q){
   p=s.slice(0,p).lastIndexOf(N)+1;q+=s.slice(q).indexOf(N)+1;t.value+=(q==t.value.length)?"":s.slice(1+p,q-1)
  }else{t.value+=s.slice(p,q)} S=s.slice(p,q);exec(S,t)}
}
function out(t,s){return function(s){t.value+=s;t.scrollTo(0,t.scrollHeight)}}
function exec(s,t) {s=s.trim();var t0=0;var t1=0
 if(s=="\\c"){t.value="ktye/k";t.exec(s)}
 if((s=="\\")||(s=="\\h")){t.value+="\n"+t.help+"\n ";t.scrollTo(0,t.scrollHeight);return}
 //if(s.startsWith("\\t")){s=s.slice(2);t0=performance.now()}
 t.exec(s);t1=performance.now();if(t0!=0){term.O((t1-t0)+"ms\n ")}
}
term.onkeydown=kd
term.O=out(term)
term.exec = function(s){term.value+="\n";ktry(s);term.O(" ")}
term.help = "...\n"

function run(){
 if(runb.value=="test"){test(ed.getValue());return}               //after drop file.t
 else if(runb.value!=""){assign(runb.value,ed.getValue());return} //after drop data file
 var s=ed.getValue();window.location.hash=encodeURIComponent(s);term.value="";
 var p = ktry(s); if(p!=0){ ed.setSelection(ed.posFromIndex(p-1), ed.posFromIndex(p), {"scroll":true})} else ui()
}
function assign(x,y){
 ktry(function(){K.dx(K.Asn(K.sc(ks(x)),ks(y)))})
 runb.value="";runb.innerText="run";ed.setValue("")
}
function test(x){
  ktry(function(){K.test(ks(x),0);runb.value="";runb.innerText="run";ed.setValue("ok")})
}


// drop file (execute *.k, or store in variable)
window.ondragover=function(e){pd(e)}
window.ondrop=function(e){pd(e);if (e.dataTransfer.items){for (var i=0;i<e.dataTransfer.items.length;i++){if(e.dataTransfer.items[i].kind=='file'){var file=e.dataTransfer.items[i].getAsFile();addfile(file)}}}else for(vari=0;i<e.dataTransfer.files.length;i++)addfile(e.dataTransfer.files[i])}
function addfile(x){
 var r = new FileReader()
 r.onload = function(){
  var u = new Uint8Array(r.result)
  ed.setValue(su(u))
  if(x.name.endsWith(".t")) settest()
  else if(x.name.endsWith(".k")==false){runb.value=x.name;runb.innerText=x.name+":"}
 }
 r.readAsArrayBuffer(x)
}




/*  
  x:1   /variable with type
 ui:`x  /ui references variables (double-binding)
 ui:("label";`x)   /add a label
 ui:`x`y`z         /container of 3 widgets (default: row direction)
 ui:("v";`x;`y;`z) /container with vertical layout (flexDirection:"column")
 */

// ui (toggle with cntrl-K)
var uid = ge("uid");uid.style.display="none"; var uiform = ge("uiform")
window.onkeydown=function(e){if(e.ctrlKey&&e.key=="k"){toggle(ide);toggle(uid);return false}}
function ui(){var u=K.Val(K.Ku(BigInt(26997)));if(u==0)return;clr(uiform);ktry(function(){showui(u,uiform)})}

var ee                                 //todo rm
function L(x){console.log(x);return x} //todo rm

function showui(x,p){var e=p;var ver=false
 var t=K.tp(x);if(t< 16){x=K.Enl(x);t+=16}
 else          if(t==18||t==24){x=K.Enl(x);t=23} //char/dict
 var n=K.nn(x);if((n>1)&&t==23){var h=K.Fst(K.rx(x));if(K.tp(h)==2){ver=lo(h)==118;x=K.ndrop(1,x);n--}else{K.dx(h)}}
 if(n > 1){e=ce("div");e.style.display="flex";e.style.flexDirection=ver?"column":"row"}
 for(var i=0;i<n;i++){var xi=K.ati(K.rx(x),i);t=K.tp(xi)
  switch(t){
  case  4: show(e,xi);               break // symbol (variable-binding)
  case 18: showText(e,sk(K.rx(xi))); break // char   (text node)\
  case 24: showCustom(e,K.rx(xi));   break // dict   (custom element)
  default: console.log(sk(K.Kst(K.rx(xi))));showui(K.rx(xi),e);       break // list   (nested row/column)
  }K.dx(xi)};K.dx(x)
 if(e!=p)p.appendChild(e);ide.style.display=x?"none":block;uid.style.display=x?"block":"none"}

function show(p,s){var x=lookup(s);var e;
 var t=K.tp(x)
 if(t==13 && typeof(s)!=="object"){ //lambda (button)
  e=ce("button");e.textContent=pathname(s)
  e.onclick=function(){ktry(function(){K.Cal(K.Val(s),K.mk(23,0)); ui()})}
  K.dx(x);p.appendChild(e)
 }else if(t>0&&t<23){var T="vbcisfzldtcdpl000BCISFZLDT"  //b..Z
  e=ce("input");e.title=pathname(s)+"("+T[t]+")"
  var get=function(e){return e.value}; var set=function(e,s){e.value=s}
  if(t==1){ e.type="checkbox";get=function(e){return e.checked?"1b":"0b"}; set=function(e,s){e.checked=s=="1b"}; }
  set(e,kstr(x))
  e.onchange=function(){update(e,s,T[t],get(e))}
  p.appendChild(e)
 }else if(t==24){ // dict
  var k=K.x0(lo(x));var v=K.x1(lo(x));K.dx(x);var n=K.nn(k);if(K.tp(k)!=20){K.dx(k);K.dx(v);return} // only `s!..
  var te=ce("table");
  for(var i=0;i<n;i++){var ki=K.ati(K.rx(k),i);
   var tr=ce("tr");var th=ce("th");th.innerText=sy(ki);tr.appendChild(th);
   var td=ce("td");show(td,pushpath(s,ki),K.ati(K.rx(v),i));tr.appendChild(td);te.appendChild(tr)}
  p.appendChild(te);K.dx(k);K.dx(v)
 }else K.dx(x)
}

function showText(p,s){var e=ce("span");e.textContent=s;p.appendChild(e)}

function showCustom(p,x){if(20!=K.tp(K.Key(K.rx(x))))return;var k=K.Key(K.rx(x));x=K.Val(x);var n=K.nn(k)
 var a={};for(i=0;i<n;i++){var v=K.ati(rx(x),i);var t=tp(v);a[sk(K.ati(rx(k),i))]=(t==18||t==4)?sk(v):sk(K.Kst(v))}
 K.dx(k);K.dx(x);n=a[""];if(n==undefined){return};delete a[""];
 var e=document.createNode(n);for(let k in a)e[k]=a;p.appendChild(a)}

function kstr(x){var t=K.tp(x);if(t==2)return String.fromCharCode(lo(x));if(t==18)return sk(x);if(t>16&&t<23){
 var n=K.nn(x);if(n==0){K.dx(x);return ""}else if(n==1){x=K.Fst(x)}};return sk(K.Kst(x))}

function lookup(s){ //symbol or path: [symbol;symbol;..]
 if(typeof s=="object"){ var r=K.Val(s[0]);s=s.slice(1);for(var i=0;i<s.length;i++)r=K.Atx(r,s[i]); return r }
 else return K.Val(s) }

function pathname(s)   { return (typeof s=="object") ? s.map(x=>sy(x)).join(".") : sy(s) }
function pushpath(s,a) { return (typeof s=="object") ? s.concat(a) : [s,a] }
 
function update(e,path,t,s){ // ui-assign callback
 console.log("update", path, t, s)
 var x=K.Cst(K.sc(ks(t)), ks(s)) // x:t$s
 e.setCustomValidity((x==0)?"invalid type "+t:""); if(x==0)return
 if(typeof path=="object") K.dx(K.Asn(path[0], K.Dmd(K.Val(path[0]),la(path.slice(1)),BigInt(1),x)))
 else K.dx(K.Asn(path,x))}

 
function clr(p){while(p.firstChild)p.removeChild(p.firstChild)}

</script>
</body></html>
