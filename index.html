<html>
<head><meta charset="utf-8"><title>w</title></head>
<link rel='icon' type'image/png' href="k32.png">
<style>
 html,body,textarea{height:100%;margin:0;padding:0;overflow:hidden;}
 #kons{top:0;left:0;width:100%;height:100%;position:absolute;border:0pt;resize:none;font-family:monospace;overflow:auto;}
 .term{background:black;color:white}
 .hold{background:white;color:black}
 .edit{background:#ffffea;color:black}
 #cnv{width:100;height:100;top:0;right:0;position:absolute;}
 #dl{display:none;}
</style>
<body>
<textarea id="kons" class="term" wrap="off" autofocus spellcheck="false"></textarea>
<canvas id="cnv"></canvas>
<script>
var r = "AGFzbQEAAAABEANgAX8Bf2ACf38Bf2ABfwADDAsAAQEAAQICAgIAAAUDAQABB0MMA21lbQIAA2luaQAAAmJrAAECbWsAAgNta2kAAwNta2QABAJmcgAFAmR4AAYCcngABwJybAAIA3RpbAAJA3JldgAKCrYIC00BA39BAEKAgpDAgIKBAjcDAEGAASAANgIAQYACIQFBCCECAkADQCACIABJRQ0BQQQgAmwgATYCACABQQJsIQEgAkEBaiECDAALCyAACxMBAn9BIEEHIAEgAC0AAGxqZ2sLngEBB38gACABEAEhAkEEIAJsIQMCQANAIAMoAgBFRQ0BIANBBGohAwwACwtBgAEgA0YEQAALIAMoAgAhBCADIAQoAgA2AgAgA0EEayEFAkADQCAFQQQgAmxPRQ0BIARBASAFQQJ2dGohBiAGIAUoAgA2AgAgBSAGNgIAIAVBBGshBQwACwsgBCABIABBHXRyNgIAIARBBGpBATYCACAECxgBAn9BAkEBEAIhASABQQhqIAA2AgAgAQtyAQl/IAAoAgBBHXYhAiAAKAIAQf////8BcSEDQQggAGohBCABKAIAQR12IQUgASgCAEH/////AXEhBkEIIAFqIQcgAkEFRgRAAAsgAyAGRgRAAAtBB0ECEAIhCCAIQQhqIAA2AgAgCEEMaiABNgIAIAgLPwEFfyAAKAIAQR12IQEgACgCAEH/////AXEhAkEIIABqIQNBBCABIAIQAWwhBCAAIAQoAgA2AgAgBCAANgIACzABAn8gAEH/AUsEQCAAQQRqKAIAIQEgAEEEaiABQQFrNgIAQQEgAUYEQCAAEAULCwshAQF/IABB/wFLBEAgAEEEaiEAIABBASAAKAIAajYCAAsLTQEFfyAAKAIAQR12IQEgACgCAEH/////AXEhAkEIIABqIQMgAEEIaiEAIAIEQEEAIQQDQCAAEAcgAEEEaiEAIARBAWoiBCACSQ0ACwsLbwEIfyAAKAIAQR12IQEgACgCAEH/////AXEhAkEIIABqIQNBAiABRkUEQAALIAMoAgAhBCABIAQQAiEFQQggBWohBiAEBEBBACEHA0AgBiAHNgIAIAZBBGohBiAHQQFqIgcgBEkNAAsLIAAQBiAFC9QCAQh/IAAoAgBBHXYhASAAKAIAQf////8BcSECQQggAGohAyACRQRAIAAPCyABQQVLBEAgABAICyABQQdGBEAgABAGIABBCGoQCiAAQQxqEAoQBA8LIAEgAhACIQRBCCAEaiEFQQAhBgJAAkACQAJAAkACQAJAAkAgAQ4GAAECAwQFBgsMBQsgBUEBIAJBAWtsaiEFIAIEQEEAIQcDQCAFIAZrIAMgBmotAAA6AAAgBkEBaiEGIAdBAWoiByACSQ0ACwsMBQsMAwsgBUEIIAJBAWtsaiEFIAIEQEEAIQcDQCAFIAZrIAMgBmorAwA5AwAgBkEIaiEGIAdBAWoiByACSQ0ACwsMAwsADAILDAALIAVBBCACQQFrbGohBSACBEBBACEHA0AgBSAGayADIAZqKAIANgIAIAZBBGohBiAHQQFqIgcgAkkNAAsLDAALIAAQBiAECw=="
function sa(s){var r=new Uint8Array(new ArrayBuffer(s.length));for(var i=0;i<s.length;i++)r[i]=s.charCodeAt(i);return r}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}};
function ae(x,y,z){x.addEventListener(y,z)};
var kwasm = sa(atob(r))
var K
// kons (k console)
var hit = kons
var konstore = ""
var edname = ""
var ed = false
function initKons() {
 kons.value = "kwasm(1195 b) 2020.03.03 ini bk mk mki mkd til rev\n "
 var hold = false
 kons.onkeydown = function(e) {
  if(e.which === 27) { // quit edit / toggle hold / close image
   delay = 0
   pd(e)
   if (ed) { qed(); hold=true }
   hold = !hold
   kons.className = (hold) ? "hold" : "term"
   imgSize(0, 0)
   hit = kons
  } else if (e.which === 13 && !hold && !ed) { // execute
   pd(e)
   var a = kons.selectionStart
   var b = kons.selectionEnd
   var s = kons.value.substring(a, b)
   if (b == a) {
    if (kons.value[a] == "\n") a -= 1
    a = kons.value.lastIndexOf("\n", a)
    if (a == -1) a = 0
    b = kons.value.indexOf("\n", b)
    if (b == -1) b = kons.value.length
    s = kons.value.substring(a, b)
   }
   if (kons.selectionEnd != kons.value.length) O(s)
   O("\n")
   s = s.trim()
   if (s === "\\c")             { kons.value=" ";imgSize(0, 0);    return }
   if (s === "\\h")             { O(atob(h));P();                  return }
   if (s.substr(0,2) === "\\e") { P();edit(s.substr(2));           return }
   if (s.substr(0,2) === "\\w") { download(s.substr(2).trim());P();return }
   if (s.substr(0,2) === "\\L") { P();loop(s.substr(2).trim());    return }
   if (s === "\\lf")            { s = "\\m #:'.fs"                        }
   hash(s);E(s);P()
  }
 }
 kons.onmousedown = function(e) { hit=kons; if(e.button==2)pd(e); }
 kons.onblur  = function(e) { kons.style.filter = "brightness(70%)" }
 kons.onfocus = function(e) { kons.style.filter = "brightness(100%)" }
}
function O(s) { kons.value += s; kons.scrollTo(0, kons.scrollHeight) }
function P()  { kons.value += " " }

function kst(x) {
 var h = K.I[x>>2]
 var t = h>>29
 var n = h&536870911
 var o = []
 switch(t){
 //case 1:
 case 2:
  x >>= 2
  return K.I.slice(2+x, 2+x+n).join(" ")
 default:
  return "kst nyi: t=" + String(t)
 }
}

var funcs = {"ini":1,"bk":2,"mk":2,"mki":1,"mkd":2,"til":1,"rev":1}
function E(s) {
 try{ // todo save/restore
  var stack = []
  var v = s.split(" ").filter(x => x)
  for (var i=0; i<v.length; i++) {
   s = v[i]
   var x = Number(s)
   var y = 0
   if(x==x) {
    stack.push(x)
   } else if(s in funcs) {
    var n = funcs[s]
    x = stack.pop()
    if(n==2) {
     y = x
     x = stack.pop()
     stack.push(K.exports[s](x, y))
     stack[stack.length-1]
    } else {
     stack.push(K.exports[s](x))
    }
   }
  }
  if(stack.length == 1) {
   x = stack[stack.length-1]
   O(kst(x)+"\n")
   K.exports.dx(x)
  }
 } catch(e) {
   O("error")
 }
}

function edit(name) { 
 edname = name; ed = true; konstore = kons.value; 
 var u = getfile(name.trim())
 kons.value = (u.length>0) ? su(u) : ""
 kons.className = "edit"
 kons.scrollTo(0,0);
}
function qed() { // quit edit
 putfile(edname, us(kons.value))
 kons.value = konstore; kons.scrollTo(0, kons.scrollHeight)
 ed = false
}
ae(kons,"contextmenu", function(e) { // button-3 search
 var l = kons.selectionEnd-kons.selectionStart; if(e.button==2&l>0) {
  pd(e); var t = kons.value.substring(kons.selectionStart,kons.selectionEnd)
  var f = function(a){ return kons.value.indexOf(t,a) }; var n = f(kons.selectionEnd)
  if (n<0){n=f(0)}; kons.setSelectionRange(n,n+l); }
})
function hash(s){window.location.hash=encodeURIComponent(s.trim())}

(async () => {
 initKons()
 const module = await WebAssembly.compile(kwasm.buffer);
 K = await WebAssembly.instantiate(module);
 K.C = new Uint8Array(K.exports.mem.buffer)
 K.I = new Uint32Array(K.exports.mem.buffer)
 K.F = new Float64Array(K.exports.mem.buffer)
 K.exports.ini(16);
 var h = decodeURIComponent(window.location.hash.substr(1))
 window.location.hash = h
 if (h.length > 0) {
  var p = kons.value.length
  kons.value += h
  kons.setSelectionRange(p, kons.value.length)
 }
 kons.focus()
})();

function us(s) { return new TextEncoder("utf-8").encode(s) } // uint8array from string
function su(u) { return (u.length) ? new TextDecoder("utf-8").decode(u) : "" }
</script></body></html>
