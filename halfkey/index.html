<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel=icon href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAABBSURBVDhPY/wPBAxIgJGREcrCBGhKwYAJSqMAdIXYNMIAVgNIAaMGDG8DYIkHXyICgdFABOZeYCChhBJp2ZmBAQC+JhoLeAkPhAAAAABJRU5ErkJggg=='>
<title>k.5</title>
<style>
body{margin:0;overflow:hidden}
*{box-sizing:border-box;font-family:monospace}
#ain{position:absolute;top:0;left:0;background:#efe;width:50vw;height:50vh;overflow:auto;border:none;outline:none;resize:none}
#kin{position:absolute;top:50vh;left:0;background:#ffe;width:50vw;height:50vh;overflow:auto;border:none;outline:none;resize:none}
#bar{position:absolute;top:0;left:50vw;height:2em}
#out{position:absolute;top:2em;margin:0;right:0;width:50vw;height:calc(100vh - 2em);overflow:auto}
.ln{color:darkblue;cursor:pointer}
.ln:hover{text-decoration:underline}
</style>
</head>

<body onload="init()">
<textarea id="ain" spellcheck="false" title="extension source">a</textarea>
<textarea id="kin" spellcheck="false" title="k source for stage2">k</textarea>
<div      id="bar">
 <button  id="but" onclick="run(0)"  title="compile to wasm and run">run</button>
 <button  id="ast" onclick="run(1)"  title="show IR table">ast</button>
 <button  id="ccc" onclick="run(2)"  title="compile to c">c</button>
 <span class="ln" onclick="showhk()" title="show compiler source">halfkey.k</span> <span class="ln" onclick="run(3)" title="download generated k+.c">k+.c</span>
 <a href="about.html">about</a>
</div>
<pre id="out">out</pre>
<a id="dl" style="display:none"></a>

<script>
let K,kk,hk,cc,wb,dt
function ge(x){return document.getElementById(x)}
function su(u){return(u.length)?new TextDecoder("utf-8").decode(u):""}
function us(s){return new TextEncoder("utf-8").encode(s)}
function O(x){let o=ge("out");o.textContent+=("string"==typeof x)?x:su(x)}
function init(){let fe=(u,f)=>{fetch(u).then(r=>r.text()).then(f)}
 fe("demo.a",r=>ge("ain").value=r);fe("demo.k",r=>ge("kin").value=r)
 fe("halfkey.k",   r=>hk=r) //halfkey compiler
 fe("drawtree.k",  r=>dt=r) //tree view
 fe("../kweb/k.k", r=>kk=r) //k-source as table
 fe("../kweb/cc.k",r=>cc=r) //c transpiler
 fe("../kweb/wb.k",r=>wb=r) //wasm(binary) compiler
}
window.onerror=function(m,s,l,c,e){O(m+" "+e+"\n")}
window.addEventListener("unhandledrejection",function(e){ 
   O(e.reason+"\n") 
});

let env={env:{ //wasm import object
 Exit:x=>{        },
 Args:()=>{return 0},
 Arg:(x,y)=>{return 0},
 Read:(x,y,z)=>{return 0},
 Write:(f,m,s,n)=>{O(new Uint8Array(K.memory.buffer,s,n));return 0},
 ReadIn:(x,y)=>{return 0},
 Native:(x,y)=>{return 0},
}}

//k-memory access
function lo(x){return Number(BigInt.asUintN(32,x))} //pointer
function C(){return new Int8Array(K.memory.buffer)} //heap
function KC(u){u=("string"==typeof u)?us(u):u;let r=K.mk(18,u.length);C().set(u,lo(r));return r}
function CK(x){return C().slice(lo(x),lo(x)+K.nn(x))}
function sc(x){return K.sc(KC(x))}

function run(c){ //stage 1
 ge("out").textContent=""
 fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(r,env)).then(r=>{
  K=r.instance.exports
  K.kinit()
  O("k1\n")  
  if(c!=2&&c!=3)K.dx(K.Val(KC(kk)))   //load k.k interpreter source (vars: C D T P I S)
  K.dx(K.Asn(sc("A"),K.Atx(K.Val(KC("`p@")),KC(ain.value)))) //parse src.a, store in A 
  K.dx(K.Val(KC(hk)))        //run halfkey.k compiler
  O("compile to "+(["wasm","IR","c","c"][c])+"..\n")
  setTimeout(()=>{            //to flush O
   if(c==1){
    K.dx(K.Val(KC(dt)))
    K.dx(K.Val(KC("draw simple B")))
    ge("out").textContent=ge("out").textContent.replaceAll("|","│").replaceAll("+","├").replaceAll("L","└").replaceAll("-","─").replaceAll("T","┬")
    return
   }
   K.dx(K.Val(KC(c?cc:wb)))   //load wb.k or cc.k
   let b=CK(K.Atx(K.Val(sc(c?"cc":"wb")),K.Val(KC("``")))) //call cc`` or wb``
   if(c)downld(b)
   else stage2(b)
  },10)
 })
}
function downld(u){
 let x=new Blob([u],{type:"application/octet-stream"}) //u:uint8array
 let dl=ge("dl")
 dl.href=URL.createObjectURL(x)
 dl.download="k+.c"
 dl.click()
}
function stage2(w){
 //return
 K=null                           //reboot
 WebAssembly.instantiate(w.buffer,env).then(r=>{
  K=r.instance.exports
  K.kinit()
  O("k2\n")
 })
}

function showhk(){ge("out").textContent=hk}

</script></body></html>

