<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel=icon href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAABBSURBVDhPY/wPBAxIgJGREcrCBGhKwYAJSqMAdIXYNMIAVgNIAaMGDG8DYIkHXyICgdFABOZeYCChhBJp2ZmBAQC+JhoLeAkPhAAAAABJRU5ErkJggg=='>
<title>k.5</title>
<style>
body{margin:0;overflow:hidden}
*{box-sizing:border-box;font-family:monospace}
#ain{position:absolute;top:2em;left:0;background:#efe;width:50vw;height:calc(50vh - 1em);overflow:auto;border:none;outline:none;resize:none}
#kin{position:absolute;top:calc(50vh + 1em);left:0;background:#ffe;width:50vw;height:calc(50vh - 1em);overflow:auto;border:none;outline:none;resize:none}
#bar{position:absolute;top:0;left:50vw;height:2em}
#out{position:absolute;top:2em;margin:0;right:0;width:50vw;height:calc(100vh - 2em);overflow:auto}
.ln{color:darkblue;cursor:pointer}
.ln:hover{text-decoration:underline}
</style>
</head>

<body onload="init()">
<select   id="exa" onchange='example(this)'></select>
<textarea id="ain" spellcheck="false" title="extension source">a</textarea>
<textarea id="kin" spellcheck="false" title="k source for stage2">k</textarea>
<div      id="bar">
 <button  id="ast" onclick="run('ast')"  title="show IR table">ast</button>
 <button  id="run" onclick="run('run')"  title="compile to wasm and run">run</button>
 <button  id="ccc" onclick="run('ccc')"  title="show compiled code">code</button>
 <select  id="sel" onchange="sel(this)">
  <option title="cc.k">c</option>
  <option title="go.k">go</option>
  <option title="wa.k: webassembly text format">wat</option>
  <option title="wb.k: webassembly binary">wasm</option>
 </select>
 <span class="ln" id="dlnk" onclick="run('dwn')">download</span> <span class="ln" onclick="showhk()" title="show compiler source">halfkey.k</span>
 <a href="about.html">about</a>
</div>
<pre id="out">out</pre>
<a id="dl" style="display:none"></a>

<script>
let K,kk,hk,cc,go,wa,wb,dt
function ge(x){return document.getElementById(x)}
function ce(x){return document.createElement(x)}
function su(u){return(u.length)?new TextDecoder("utf-8").decode(u):""}
function us(s){return new TextEncoder("utf-8").encode(s)}
function O(x){let o=ge("out");o.textContent+=("string"==typeof x)?x:su(x)}
function init(){let fe=(u,f)=>{fetch(u).then(r=>r.text()).then(f)}
 fe("halfkey.k",   r=>hk=r) //halfkey compiler
 fe("drawtree.k",  r=>dt=r) //tree view
 fe("../kweb/k.k", r=>kk=r) //k-source as table
 fe("../kweb/cc.k",r=>cc=r) //c transpiler
 fe("../kweb/go.k",r=>go=r) //go transpiler
 fe("../kweb/wa.k",r=>wa=r) //wasm(text)   compiler
 fe("../kweb/wb.k",r=>wb=r) //wasm(binary) compiler
}
window.onerror=function(m,s,l,c,e){O(m+" "+e+"\n")}
window.addEventListener("unhandledrejection",function(e){ 
   O(e.reason+"\n") 
});

function sel(o){let v=o.value
 let d=ge("dlnk");d.title="download generated k+."+v+" (full program)";d.textContent="k+."+v
}
ge("sel").value="c";sel({value:"c"})

let env={env:{ //wasm import object
 Exit:x=>{        },
 Args:()=>{return 0},
 Arg:(x,y)=>{return 0},
 Read:(x,y,z)=>{return 0},
 Write:(f,m,s,n)=>{O(new Uint8Array(K.memory.buffer,s,n));return 0},
 ReadIn:(x,y)=>{return 0},
 Native:(x,y)=>{return 0},
}}

//k-memory access
function lo(x){return Number(BigInt.asUintN(32,x))} //pointer
function C(){return new Int8Array(K.memory.buffer)} //heap
function KC(u){u=("string"==typeof u)?us(u):u;let r=K.mk(18,u.length);C().set(u,lo(r));return r}
function CK(x){return C().slice(lo(x),lo(x)+K.nn(x))}
function sc(x){return K.sc(KC(x))}

function run(c){ //stage 1
 ge("out").textContent="";let simple=(c=="ast"||c=="ccc")
 fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(r,env)).then(r=>{
  K=r.instance.exports
  K.kinit()
  
  O("k1\n")  
  K.dx(K.Val(KC(kk)))        //load k.k interpreter source (vars: C D T P I S)
  K.dx(K.Asn(sc("A"),K.Atx(K.Val(KC("`p@")),KC(ain.value)))) //parse src.a, store in A 
  K.dx(K.Val(KC(hk)))        //run halfkey.k compiler
  setTimeout(()=>{           //to flush O
   if(c=="ast"){
    K.dx(K.Val(KC(dt)))
    K.dx(K.Val(KC("draw simple[]")))
    ge("out").textContent=ge("out").textContent.replaceAll("|","│").replaceAll("+","├").replaceAll("L","└").replaceAll("-","─").replaceAll("T","┬")
    return
   }
   let lang=ge("sel").value;let l={
    c:   [cc, ";C:_&8;ccren:{x}", "cc`nort`lib", "cc``"],
    go:  [go, "",                 "go`nort`lib", "go``"],
    wat: [wa, "",                 "wa`nort`lib", "wa``"],
    wasm:[wb, "",                 "wb`nort`lib", "wb``"],
   }[lang]
   
   K.dx(K.Val(KC((c=="run")?wb:l[0])))                        //load ${compiler}.k
   K.dx(K.Val(KC(simple?"simple[]"+l[1]:"full[]")))
   let b=CK(K.Val(KC((c=="ast")?"": simple ? l[2] : (c=="run") ? "wb``" : l[3] )))
   
        if(c=="run") stage2(b)
   else if(simple)   ge("out").textContent=(lang=="wasm")?hex(b):su(b)
   else              downld("k+."+lang,b)
   
  },10)
 })
}
function hex(b){return(" "+[...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,'0')).join('').match(/.{1,4}/g).join(" ")).match(/.{1,40}/g).join("\n")}
function showhk(){ge("out").textContent=hk}
function downld(s,u){
 O("download "+s+"\n")
 let x=new Blob([u],{type:"application/octet-stream"}) //u:uint8array
 let dl=ge("dl")
 dl.href=URL.createObjectURL(x)
 dl.download=s
 dl.click()
}
function stage2(w){
 //return
 K=null                           //reboot
 WebAssembly.instantiate(w.buffer,env).then(r=>{
  K=r.instance.exports
  K.kinit()
  O("k2\n")
  let x=ge("kin").value
  x = KC(x)
  K.dx(K.Val(x))
 })
}




let examples={
 add:{a:`/add two integers
f:{[xi;yi]x+y}

/x and y are declared as integer atoms
/they are automatically unpacked, typechecked and converted back to a k value on return.

/click on [ast ] to see the compiled function representation.
/click on [code] to see generated code for the selected language.
/[k+.c] downloads the c version of a modified interpreter that has 'f' defined as a native function.
/compile with: gcc k+.c -lm   or clang -fwrapv k+.c -lm

/the text in this editor can be changed.
`, k:`/test f with two ints
 \\f[2;3]
 
/this code runs in the stage2 interpreter, if you click the [run] button
`},

 ktypes:{
  a:`/variables of k type call k functions instead of integer opcodes.
/k vars are declared by xk or x alone
take:{[x;y]x#y}

/mixed i+k or f+k convert the scalar to k types. mixed i+f converts to float.
mixed:{[xf;yi]x+y}

/vector types also call k functions
vectors:{[xI;yF]x+y}
`,
  k:` \\take[2#;!5]
 \\mixed[3.5;2]
 \\vectors[1 2 3;0.5 0.6 0.7]
`
 },
 
 float:{
  a:`/some scalar floating point functions are predefined:
/ hypot atan2 pow fmin fmax copysign
/ exp log atan abs sqrt ceil floor nearest
f:{[xf;yf]exp hypot[x;y]}
`,
  k:`/scalar integers are automatically uptyped when floats are expected
 \\f[3;4]
`,
 },
 
 index:{
  a:`/first and last expect integer vectors.
/typecheck is done on entry, indexing is type-dependent.
first:{[xI]x[0]}
last:{[xI]x[-1+xn]}`,
  k:" \\first 1 2 3\n \\last 1 2 3\n",
 },

 macro:{
    a:`/for each k variable some symbols are replaced by primitives:
/ xt     short for tp[x]  int value of the type
/ xn     short for nn[x]  length of the array
/ x0..x2      x[0]..x[2]  indexing
/ xi          x[i]        e.g. within loops
first:{[xI]10*x0}
`,
  k:" \\first 7 8 9\n",
 },
 
 amend:{
  a:`/indexed assignment for vector types
amend:{[xI]x[1]:3;x}

/modified assign
mod:{[xI]x[1]+:2;x}
`,
  k:" \\amend x:7 8 9\n \\mod 3 4 5\n\n/x is modified! change amend to: {[xI]rI;r:0+x;r[1]:3;r}\n\n`x \\x",
 },
 
 cond:{
    a:`/if is a keyword. 2 args is a simple if statement:
absolute:{[xi]if[0>x;x:-x];x}

/3 args is if-else-then:
ifelse:{[xi;yf]if[x<3;x:2*x;y:4*y];x}

/if both branches return the same type, it's an expression:
tern:{[xi]2*if[x<3;4;5]}

`,
  k:" \\absolute -3\n \\ifelse[3;4.5]\n \\tern 3",
 },
 
 switch:{
    a:`/switch is a jump table
/the first expression evaluates to an integer, the cases are consecutive 0,1,2..default

jump:{[xi]switch[x;x:2*x;x:5*x;x:3];x}
`,
  k:" \\jump 1\n",
 },
 
 loop:{
    a:`/while is W

/one statement
loop:{[xi]W[x>3;x:x-1];x}

/multiple
loop2:{[xi]W[x<10;x:x-1;x:2*x];x}

/Ndo is N. it uses the loop variable i:0..
Ndo:{[xi;yi]N[x;y+:i];y}
`,
  k:" \\loop 5\n \\loop2 5\n \\Ndo[3;4]\n",
 },

 lu:{
    a:`/lu decomposition
LU:{[B]PI;Ak     /predeclare P as ints
 A:0+B;n:An      /deep copy, we will overwrite A
 P:!Ki n         /permutation vector
 N[n
  j:0            /todo find pivot
  t:A[j]         /swap
  A[i]:A[j]
  A[j]:t]
 (,A),,P}        /(A;P)
 
`,
  k:`lu:{[A]i:0;k:!#A;P:!#A      /k version
 while[1<#k
  j:i+*&a=m:|/a:abs A[k;i]  /or optimized (*>) 
  P[(i;j)]:P[(j;i)]
  A[(i;j)]:A[(j;i)]
  A[k:1_k;i]%:A[i;i]
  A[k;k]-:A[k;i]*\\:A[i;k]
  i+:1]
 (A;P)}
` + "\nA:`A \\(0 5.,22%3.;4 2 1.;2 7 9.)\nr:`r \\lu A\n\nR:`R \\LU A"

 },
 
 
}
for(let x in examples){let o=ce("option");o.value=x;o.textContent=x;ge("exa").appendChild(o)}
function example(s){if(ge("exa").value!=s.value)ge("exa").value=s.value;let x=examples[s.value];ge("ain").value=x.a;ge("kin").value=x.k}
let h=window.location.hash.slice(1);example({value:(h.length)?h:"add"})

</script></body></html>

