<!DOCTYPE html>
<html><head><meta charset="UTF-8">
</head><body>
<pre id="o"></pre>
<pre id="a"></pre>
<div style="display:flex;gap:1em"><pre id="X" style="display:inline-block"></pre>
<pre id="Y" style="display:inline-block"></pre></div>
<script src="wa.js"></script>
<script>
let lns=x=>x.split("\n").map((x,i)=>(""+i).padStart(2," ")+"  "+x).join("\n")
//let xxd=(d,x)=>(d.textContent=x.map(x=>x.toString(16).padStart(2,"0")).join(" ").match(/.{1,8}/g).join("\n"),x)
let xxd=(d,x)=>((d.textContent=Array.from(x).map(x=>x.toString(16).padStart(2,"0")).join(" ").match(/.{1,12}/g).join("\n").replaceAll(" \n","\n")),x)

let diff=(x,y)=>{if(x.length!=y.length)throw new Error("binary length differs");for(let i=0;i<x.length;i++){
 if(x[i]!=y[i]){throw new Error("binary mismatch at "+Math.floor(i/3))}}}

let tests="locs glob".split(" "),tc=0
run=_=>{x=tests[tc++];if(tc>tests.length)return
 o.textContent+=x+".."
 fetch("tests/"+x+".wasm").then(r=>r.arrayBuffer()).then(r=>{xxd(Y,new Uint8Array(r))
  fetch("tests/"+x+".a").then(r=>r.text()).then(r=>{
   let t=r.slice(1,r.indexOf("\n")).split(" ").map(Number);r=r.slice(1+r.indexOf("\n"))
   a.textContent=lns(r)
   try{
    r=xxd(X,wa(r))
    diff(X.textContent,Y.textContent)
    WebAssembly.instantiate(r).then(r=>{let m=r.instance.exports;
     let q=m.test(t[0]); if(t[1]!=q){throw new Error("test("+t[0]+"): expected "+t[1]+" got "+q)}else{o.textContent+=" ok\n";run()}
    }).catch(e=>{o.textContent+="\n"+e.message;throw(e)})
   }catch(e){o.textContent+="\n"+e.message;throw(e)}
  })
 })
}
run()
</script>
</body></html>
