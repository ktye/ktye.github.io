<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>turbok/wa.test</title>
<style>*{font-family:monospace}
span{color:blue}:hover{cursor:pointer}
#T{display:flex;gap:1em}
#O{display:inline-block;vertical-align:top;margin-top:0}
</style>
</head><body>
<div    id="T"><button onclick="step()">step</button></div>
<select id="S" multiple></select>
<pre    id="O">x</pre>

<script src="wa.js"></script>
<script src="ai.js"></script>

<script>
let ce=s=>document.createElement(s)
let tc=(t,x)=>(x.textContent=t,x)
let ac=(p,x)=>(p.appendChild(x),x)

let A
let run=s=>{S.innerHTML="";let src=""
 fetch("tests/"+s+".a").then(r=>r.text()).then(r=>{r.split("\n").filter(x=>x[0]!="/").forEach((x,_,a)=>{src+=x+"\n";tc(x,ac(S,ce("option")));S.size=a.length});
  fetch("ai.a").then(r=>r.text()).then(r=>WebAssembly.instantiate(wa(r)).then(r=>{
   A=ai.parse(src,{},r.instance.exports)   
   A.f="f";A.l=0;S.selectedIndex=ai.line(A)
   step()
}))})}

let step=_=>{ai.step(A);S.selectedIndex=ai.line(A);O.textContent=state()}
let state=r=>{
 let c="instr: "+A.F[A.f].c[A.l].join(" ")
 let f="func : "+A.f;
 let s="stack: ";for(let i=0;i<A.S.length;i++)s+=A.S[A.S.length-1-i]+" "
 let l="local: ",lo=A.F[A.f].lo
 for(let v in lo)l+=v+":"+lo[v]+" "
 let g="globl: ";for(v in A.G)g+=v+":"+A.G[v]	 
 return[c,f,s,l,g].join("\n")}


"blck data elif glob libm locs loop swtc tabl".split(" ").forEach(x=>{ac(T,tc(x,ce("span"))).onclick=e=>run(e.target.textContent)})
run("glob")

</script>
</body></html>
