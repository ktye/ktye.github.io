<!DOCTYPE html>
<html lang="en" class="no-tui-scroll">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAABSSURBVDhPY2RgWPGfgQLASLEB/4EA3QGMjCuxuun//3AMcUaYAbg04fIdzDAaGfA/ArvFjCvg4vhdMGoAAwPFYUBE0qZ+OkC2lKSkTHFmotQAAMNiZn1JrqSvAAAAAElFTkSuQmCC">

<title>TURBO.K</title>
<script src="tuicss.min.js"></script>
<link rel="stylesheet" href="tuicss.min.css">
<style>
 textarea{resize:none}
#out{color:#ccc}
.fullscr{width:100%!important;height:100%!important;position:absolute;left:0;top:0;z-index:9}
.hidden{display:none}
.h1{flex-grow:1}
.h2{flex-grow:2.57}
.tui-dropdown:focus{background:#00a800;outline:none}
.tui-dropdown li:focus{background:#00a800;outline:none}
.tui-dropdown:focus>.tui-dropdown-content:first-of-type{display:block}
.tui-dropdown:focus-within>.tui-dropdown-content:first-of-type{display:block}
.tui-dropdown-content{min-width:300px}
.tui-dropdown-content:focus{display:block}
</style>
</head><body>

<script>

let file={name:"",h:null,ed:null},
af=x=>Array.from(x),
pd=e=>e.preventDefault(),
max=(x,y)=>Math.max(x,y),min=(x,y)=>Math.min(x,y),
fullscr=x=>x.closest(".tui-window").classList.toggle("fullscr"),
fullcol=x=>(x=x.closest(".tui-window"),x.style.flexGrow=(x.style.flexGrow?"":1000)),

show=x=>x.classList.add("active"),
hide=x=>x.classList.add("hidden"),
title=(w,t)=>w.querySelector("legend").innerHTML="&nbsp;"+t+"&nbsp;",
loadfile=(name,text,h)=>{ea.value="";file={name:"",h:null};title(we,name.toUpperCase());ed.value=text,file.name=name,file.h=h,ed.focus()},
newfile=x=>loadfile(newfilename.value+'.'+af(newfiletype.querySelectorAll('input')).filter(x=>x.checked)[0].value,""),
loadexample=x=>{if(x=examplelist.value)fetch("examples/"+x).then(r=>r.text()).then(r=>loadfile(x,r,null))}

//openfile=f=>(f=openfilename.files[0],f.text().then(r=>loadfile(f.name,r)))

</script>

<div class="bordered tui-bg-blue-black" style="width:100vw;height:100vh">
 <nav class="tui-nav absolute">
  <ul>
   <li id="fmenu" tabindex="1" class="tui-dropdown">
    <span class="red-168-text">F</span>ile
    <div class="tui-dropdown-content">
    <ul>
     <li tabindex="2" onclick="show(filenew)"> <a href="#!"> <span class="red-168-text">N</span>ew </a> </li>
     <li tabindex="3" onclick="fileopen()"> <a href="#!"> <span class="red-168-text">O</span>pen...  <span class="tui-shortcut">F3</span> </a> </li>
     <li tabindex="4" > <a href="#!"> <span class="red-168-text">S</span>ave <span class="tui-shortcut">F2</span> </a> </li>
     <li tabindex="5" > <a href="#!">S<span class="red-168-text">a</span>ve as...</a> </li>
     <li tabindex="7" onclick="show(examples)"> <a href="#!">Open <span class="red-168-text">E</span>xamples...</a></li>
    </ul>
   </li>
   <li id="emenu" tabindex="6" class="tui-dropdown"> <span class="red-168-text">E</span>dit <!--Undo Redo|Cut Copy Paste Clear Copy example|Show clipboard-->
    <div class="tui-dropdown-content">
    <ul>
     <li tabindex="7"> <a href="#!"> <span class="red-168-text">C</span>ut </a> </li>
     <li tabindex="8"> <a href="#!"> C<span class="red-168-text">o</span>py </a> </li>
     <li tabindex="9"> <a href="#!"> <span class="red-168-text">P</span>aste </a> </li>
    </ul>
   </li>
   <li id="smenu" tabindex="10" class="tui-dropdown"> <span class="red-168-text">S</span>earch <!--Find Replace Search again|Go to line number... Previous error Next error Locate function...--> 
    <div class="tui-dropdown-content">
    <ul>
     <li tabindex="11"> <a href="#!"> <span class="red-168-text">F</span>ind... </a> </li>
     <li tabindex="12"> <a href="#!"> <span class="red-168-text">R</span>eplace... </a> </li>
     <li tabindex="13"> <a href="#!"> <span class="red-168-text">S</span>earch again <span class="tui-shortcut">Ctrl+L</span></a> </li>
     <div class="tui-black-divider"></div>
     <li tabindex="14"> <a href="#!"> <span class="red-168-text">G</span>oto line number...</a> </li>
     <li tabindex="15"> <a href="#!"> <span class="red-168-text">P</span>previous error <span class="tui-shortcut">Alt+F7</span></a></li>
     <li tabindex="16"> <a href="#!"> <span class="red-168-text">N</span>ext error <span class="tui-shortcut">Alt+F8</span></a></li>
     <li tabindex="17"> <a href="#!"> <span class="red-168-text">L</span>ocate function...</a> </li>
    </ul>
   </li>
   <li id="rmenu" tabindex="18" class="tui-dropdown"> <span class="red-168-text">R</span>un <!--Run Ctrl+F9 Program reset Ctrl+F2 Go to cursor F4 Trace into F7 Step over F8 Arguments...--> 
    <div class="tui-dropdown-content">
    <ul>
     <li tabindex="19" onclick="run()"> <a href="#!"> <span class="red-168-text">R</span>un <span class="tui-shortcut">Ctrl+F9</span></a> </li>
     <li tabindex="21" onclick="nyi('goto')"> <a href="#!"> <span class="red-168-text">G</span>oto cursor <span class="tui-shortcut">F4</span> </a> </li>
     <li tabindex="22" onclick="traceinto()"> <a href="#!"> <span class="red-168-text">T</span>race into<span class="tui-shortcut">F7</span> </a> </li>
     <li tabindex="23" onclick="stepover()"> <a href="#!"> <span class="red-168-text">S</span>tep over <span class="tui-shortcut">F8</span> </a> </li>
     <li tabindex="24" onclick="run(1)"> <a href="#!"> Run t<span class="red-168-text">e</span>sts <span class="tui-shortcut">F10</span> </a> </li>
     <li tabindex="25"> <a href="#!"> Start <span class="red-168-text">F</span>unction... </a> </li>
     <li tabindex="26"> <a href="#!"> <span class="red-168-text">A</span>rguments...</a> </li>
    </ul>
   </li>
   <li id="cmenu" tabindex="26" class="tui-dropdown"> <span class="red-168-text">C</span>ompile <!--Compile Alt-F9 Make F9 Link Build add|Information... Remove messages-->
    <div class="tui-dropdown-content">
    <ul>
     <li tabindex="19" onclick="compile()"> <a href="#!"> <span class="red-168-text">C</span>ompile <span class="tui-shortcut">F9</span></a> </li>
     <li tabindex="20" onclick="savewasm()"> <a href="#!"> Save <span class="red-168-text">w</span>asm</a> </li>
    </ul>
    </div>
   </li>
   <li id="dmenu" class="tui-dropdown"> <span class="red-168-text">D</span>ebug <!--Inspect... Alt-F4 Evaluate/modify... Ctrl+F4 Call stack... Ctrl-F3 Watches→ Toggle breakpoint Ctrl-F8 Breakpoints... --> <!--Add watch... Ctrl-F7 Delete watch Edit watch... Remove all watches--> </li>
   <li id="wmenu" class="tui-dropdown" style="float:right;margin-left:10px"> <span class="red-168-text">H</span>elp </li>
   <li id="hmenu" class="tui-dropdown" style="float:right;margin-left:10px"> <span class="red-168-text">W</span>indow </li>
  </ul>
 </nav>

 <div style="position:absolute;top:20px;height:calc(100% - 45px);width:100%;display:flex;flex-flow:column">

  <div id="main" class="full-width" style="display:flex;flex-grow:2">

   <div id="left" style="height:100%;width:30%;display:flex;flex-flow:column;resize:horizontal;overflow:auto">
   
    <div id="w_a" class="tui-window full-width h2 tui-no-shadow">
     <fieldset class="tui-fieldset full-height">
      <legend class="center">&nbsp;PROGRAM&nbsp;</legend>
      <!--span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span-->
      <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
      <!--span class="tui-fieldset-text top right" style="margin-right: 50px">1</span-->
      <span class="tui-fieldset-text" style="margin-left: 50px;">&nbsp;main:0&nbsp;</span>
      <!--textarea id="ea" class="tui-textarea full-width full-height" style="overflow:scroll;" spellcheck="false"></textarea-->
      <select id="ea" size="9" class="tui-textarea full-width full-height" style="overflow:scroll"></select>
     </fieldset>
    </div>
   </div>
  
  
   <div id="right" style="height:100%;width:70%;display:flex;flex-flow:column">
  
    <div id="we" class="tui-window full-width h1 tui-no-shadow">
     <fieldset class="tui-fieldset full-height">
      <legend class="center">A.K</legend>
      <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
      <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
      <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
      <span class="tui-fieldset-text" style="margin-left: 50px;">&nbsp;1:1&nbsp;</span>
      <textarea id="ed" class="tui-textarea full-width full-height" style="overflow:scroll;" spellcheck="false"></textarea>
     </fieldset>
    </div>
  
    <div id="wo" class="tui-window full-width h1 tui-no-shadow" style="background:black">
     <fieldset class="tui-fieldset full-height">
      <legend class="center">&nbsp;OUT&nbsp;</legend>
      <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
      <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
      <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
      <!--pre id="out" style="margin:0"></pre-->
      <textarea id="out" class="tui-textarea full-width full-height" spellcheck="false" readonly></textarea>
     </fieldset>
    </div>
   </div>
  </div>

  <div id="wd" class="tui-window full-width h1 tui-no-shadow cyan-168 hidden">
   <fieldset class="tui-fieldset full-height">
    <legend class="center">&nbsp;DEBUG&nbsp;</legend>
    <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
    <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
    <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
    <pre>
    </pre>
    <!--textarea class="tui-textarea full-width" style="height: 200px; overflow: scroll;" spllcheck="false">
    </textarea-->
   </fieldset>
  </div>
 </div>

 
 <div class="tui-statusbar absolute">
  <ul>
   <li><a href="#!"><span class="red-168-text">F1</span> Help</a></li>
   <li><a href="#!"><span class="red-168-text">F2</span> Save</a></li>
   <li><a href="#!"><span class="red-168-text">F3</span> Open</a></li>
   <li><a href="#!"><span class="red-168-text">Ctrl+F9</span> Run</a></li>
   <li><a href="#!"><span class="red-168-text">F9</span> Compile</a></li>
   <!--span class="tui-statusbar-divider"></span-->
   <li style="float:right;"><a href="#!"><span class="red-168-text">F10</span> Test</a></li>
  </ul>
 </div>
</div>
<a id="dl" style="display:none"></a>
 
<!-- dialogs -->
<div class="tui-overlap"></div>
<div id="filenew" class="tui-modal center" >
 <div class="tui-window">
  <fieldset class="tui-fieldset">
  <legend class="center">New File</legend>
  <fieldset id="newfiletype" class="tui-input-fieldset">
   <legend>Type</legend>
   <label class="tui-radio">a(assembly)<input type="radio" name="filetype" value="a"/><span></span></label>
   <label class="tui-radio">b(better c)<input type="radio" name="filetype" value="b" /><span></span></label>
   <label class="tui-radio">c(c royale)<input type="radio" name="filetype" value="c" /><span></span></label>
   <label class="tui-radio">k(kingkong)<input type="radio" name="filetype" value="k" checked/><span></span></label>
  </fieldset>
  <br>
  <fieldset class="tui-input-fieldset">
   <legend>Name</legend>
   <input id="newfilename" class="tui-input" value="a"></input>
  </fieldset>
  <br>
  <div class="tui-divider"></div>
  <br>
  <button class="tui-button tui-modal-close-button left white-255-text" data-modal="filenew" onclick="newfile()" >ok</button>
  <span> </span>
  <button class="tui-button tui-modal-close-button right white-255-text cyan-168" data-modal="filenew">close</button>
  </fieldset>
 </div>
</div>

<div id="examples" class="tui-modal center" >
 <div class="tui-window">
  <fieldset class="tui-fieldset">
  <legend class="center">Examples</legend>
  <fieldset id="examplefiles" class="tui-input-fieldset">
   <select id="examplelist" class="tui-input" multiple>
    <option>aray.c</option>
    <option>swtc.a</option>
   </select>
  </fieldset>
  <br>
  <div class="tui-divider"></div>
  <br>
  <button class="tui-button tui-modal-close-button left white-255-text" data-modal="examples" onclick="loadexample()" >ok</button>
  <span> </span>
  <button class="tui-button tui-modal-close-button right white-255-text cyan-168" data-modal="examples">close</button>
  </fieldset>
 </div>
</div>

<!--div id="fileopen" class="tui-modal center">
 <div class="tui-window">
  <fieldset class="tui-fieldset">
   <legend class="center">Open</legend>
   File <input id="openfilename" class="tui-input full-width" type="file"/>
  <br>
  <div class="tui-divider"></div>
  <br>
  <button class="tui-button tui-modal-close-button left white-255-text" data-modal="fileopen" onclick="openfile()">ok</button>
  <span> </span>
  <button class="tui-button tui-modal-close-button right white-255-text cyan-168" data-modal="fileopen">close</button>
  </fieldset>
 </div>
</div-->

<script>
ed.onselectionchange=e=>{e=e.target
 let l=1,p=e.selectionStart,t=e.value.slice(0,p),i=t.indexOf("\n");
 while(i>=0&&i<p){l++;i=t.indexOf("\n",1+i)};let c=p-t.lastIndexOf("\n")
 e.previousElementSibling.innerHTML="&nbsp;"+l+":"+c+"&nbsp;"}

let name=window.location.hash.slice(1);//if(name){fetch(name).then(r=>r.text()).then(t=>loadfile(name,t))}
let O=x=>{out.value+=x;out.scrollTop=out.scrollHeight},clr=_=>out.value="",
libm=Object.assign(...("acos acosh asin asinh atan atan2 atanh cbrt ceil clz32 cos cosh exp expm1 floor hypot sin cos log log10 log1p pow random round sign sin tan tanh trunc".split(" ").map(x=>({[x]:Math[x]})))),
testsok,expect=(a,b)=>{if(a!=b){throw new Error("test #"+testsok+": "+a+" got "+b)};testsok++},
D, //D=ai.parse(src,{},A)
W, //module
M={env:{expect:expect},math:libm}, //import object
help=_=>out.value="help..\n",
save=async _=>{
 if(file.h==null)return
 let w=await file.h.createWritable()
 await w.write(ed.value)
 await w.close()
 unmark(ed.closest(".tui-window"))
},
savewasm=async _=>{/*compile();*/ if(wasm)download(wasm,file.name.slice(0,-2)+".wasm")},
fileopen=async _=>{
 let[h]=await window.showOpenFilePicker({types:[{accept:{"ktye/k":".k","ktye/c":".c","ktye/asm":".a"}}]});
 let f=await h.getFile();
 let t=await f.text();
 loadfile(f.name,t,h)
},
nyi=x=>{throw new Error("nyi"+(x?" "+x:""))},
run=t=>{clr();compile();exec(t)},
stepover =_=>{(!ea.value)?compile():step(0);showstep()},
traceinto=_=>{(!ea.value)?compile():step(1);showstep()},
handle=(e,f)=>{e.preventDefault();f()},
mark=w=>e=>{e=w.querySelector("legend");if(!e.textContent.trim().endsWith("*"))e.innerHTML="&nbsp;"+e.textContent.trim()+"*&nbsp;"},
unmark=w=>{let e=w.querySelector("legend");if(e.textContent.trim().endsWith("*"))e.innerHTML="&nbsp;"+e.textContent.trim().slice(0,-1)+"&nbsp;"},
download=(u,n)=>{let x=new Blob([u],{type:"application/octet-stream"});dl.href=URL.createObjectURL(x);dl.download=n;dl.click()}

ed.onchange=mark(we)
window.onerror=e=>O("error: "+e+"\n")
window.onkeydown=e=>
 ("f"==e.key&&e.altKey)?handle(e,_=>fmenu.focus()):
 ("e"==e.key&&e.altKey)?handle(e,_=>emenu.focus()):
 ("s"==e.key&&e.altKey)?handle(e,_=>smenu.focus()):
 ("r"==e.key&&e.altKey)?handle(e,_=>rmenu.focus()):
 ("c"==e.key&&e.altKey)?handle(e,_=>cmenu.focus()):
 ("d"==e.key&&e.altKey)?handle(e,_=>dmenu.focus()):
 ("w"==e.key&&e.altKey)?handle(e,_=>wmenu.focus()):
 ("h"==e.key&&e.altKey)?handle(e,_=>hmenu.focus()):
 ("F1"==e.key)?handle(e,help):
 ("F2"==e.key)?handle(e,save):
 ("F3"==e.key)?handle(e,fileopen):
 ("F7"==e.key)?handle(e,traceinto):
 ("F8"==e.key)?handle(e,stepover):
 ("F9"==e.key&&e.ctrlKey)?handle(e,run):
 ("F9"==e.key)?handle(e,compile):
 ("F10"==e.key)?handle(e,_=>run(1)):true
 //("F10"==e.key)?handle(e,_=>{fmenu.focus()}):true

let accel={
 fmenu:{
  "n":_=>show(filenew),
  "o":fileopen,
  "s":save,
  //"a":saveas,
  "w":savewasm,
  "e":_=>show(examples),
 },
 cmenu:{
  "c":x=>compile(),
  "w":savewasm,
 },
}

//left-right
af(document.querySelectorAll(".tui-dropdown")).forEach((x,i,a)=>x.onkeydown=e=>{ 
 (e.key=="ArrowRight")?(pd(e),a[min(a.length-1,1+i)].focus()):
 (e.key=="ArrowLeft")?(pd(e),a[max(0,i-1)].focus()):
 (e.key=="ArrowDown")?(pd(e),e.target.querySelector("li").focus()):
 (e.key=="Escape")?e.target.blur():
 (e.key in accel[x.id]?handle(e,accel[x.id][e.key]):true)
 })

//up-down
af(document.querySelectorAll(".tui-dropdown-content")).forEach(x=>
 af(x.querySelectorAll("li")).forEach(x=>x.onkeydown=e=>
  (e.key=="ArrowDown")?x.nextElementSibling.focus():
  (e.key=="ArrowUp")?x.previousElementSibling.focus():
  (e.key=="Escape")?x.blur():
  true
 )
)

let exec=t=>{
 O("$"+(t?"test ./":"")+file.name.slice(0,-2)+"\n")
 let i=new WebAssembly.Instance(W,M)
 if(t){testsok=0;i.exports.test();O(testsok+" ok\n")}
 else O("exit "+i.exports.main(0)+"\n")
}
let wasm=0 //compiled binary
let compile=_=>{let x=file.name.slice(-1);wasm=0;
  (x=="a")?asm(ed.value)
 :(x=="b")?O("$ab "+file.name+"\nnyi\n")
 :(x=="c")?(O("$ac "+file.name+"\n"),asm(ac(ed.value)))
 :(x=="k")?O("$ak "+file.name+"\nnyi\n")
 :O("$compile "+file.name+"\n?\n")}

examplelist.value="aray.c";loadexample()
</script>

<script src="wa/wa.js"></script>
<script src="wa/ai.js"></script>
<script src="wa/opt.js"></script>
<script src="wa/link.js"></script>
<script src="wa/boot.js"></script>
<script src="ac/cparse.js"></script>
<script src="ac/ac.js"></script>

<script>
let ce=x=>document.createElement(x)
let ah=(x,y)=>(x.appendChild(y),y)
let ih=(t,x)=>((x.innerHTML=t.replaceAll(" ","&nbsp;")),x)

let step=o=>{try{ai.step(D,o)}catch(e){if("exit"==e.message&&1==D.S.length)O("exit "+D.S.pop()+"\n");else throw(e)}}
let showstep=_=>{ea.selectedIndex=ai.line(D)}

let asm=a=>{
 O("$as "+file.name.slice(0,-2)+".a\n")
 ea.innerHTML=""
 a=opt(a.split("\n"),new WebAssembly.Instance(A).exports).join("\n")
 a.trimEnd().split("\n").forEach(x=>ah(ea,ih(x,ce("option"))))
 wasm=wa(a)
 O(wasm.length+" bytes\n")
 W=new WebAssembly.Module(wasm)
 D=ai.parse(a,M,A)
 D.f="main";D.l=0
}

</script>

</body></html>
