<!DOCTYPE html>
<html lang="en" class="no-tui-scroll">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAABSSURBVDhPY2RgWPGfgQLASLEB/4EA3QGMjCuxuun//3AMcUaYAbg04fIdzDAaGfA/ArvFjCvg4vhdMGoAAwPFYUBE0qZ+OkC2lKSkTHFmotQAAMNiZn1JrqSvAAAAAElFTkSuQmCC">

<title>TURBO.K</title>
<script src="tuicss.min.js"></script>
<link rel="stylesheet" href="tuicss.min.css">
<style>
 textarea{resize:none}
#out{color:#ccc}
.fullscr{width:100%!important;height:100%!important;position:absolute;left:0;top:0;z-index:9}
.hidden{display:none}
.h1{flex-grow:1}
.h2{flex-grow:2.57}
.tui-dropdown:focus{background:#00a800;outline:none}
.tui-dropdown li:focus{background:#00a800;outline:none}
.tui-dropdown:focus>.tui-dropdown-content:first-of-type{display:block}
.tui-dropdown:focus-within>.tui-dropdown-content:first-of-type{display:block}
.tui-dropdown-content:focus{display:block}
</style>
</head><body>

<script>

let file={name:"",h:null,ed:null},
af=x=>Array.from(x),
pd=e=>e.preventDefault(),
max=(x,y)=>Math.max(x,y),min=(x,y)=>Math.min(x,y),
fullscr=x=>x.closest(".tui-window").classList.toggle("fullscr"),
fullcol=x=>(x=x.closest(".tui-window"),x.style.flexGrow=(x.style.flexGrow?"":1000)),

show=x=>x.classList.add("active"),
showall=_=>[w_a,w_k,w_c].forEach(x=>x.classList.remove("hidden")),
hide=x=>x.classList.add("hidden"),
title=(w,t)=>w.querySelector("legend").innerHTML="&nbsp;"+t+"&nbsp;",
loadfile=(name,text,h)=>{[ek,ec,ea].forEach(x=>{x.value="";x.readOnly=true});showall();file={name:"",h:null,ed:null}
 let n=name.slice(0,-1).toUpperCase();title(w_k,n+"K");title(w_c,n+"C");title(w_a,n+"A")
 name.endsWith(".a")?(hide(w_k),hide(w_c),ea.value=text,ea.readOnly=false,file.name=name,file.h=h,file.ed=ea):
 name.endsWith(".c")?(hide(w_k)         ,ec.value=text,ec.readOnly=false,file.name=name,file.h=h,file.ed=ec):
 name.endsWith(".k")?(                  ek.value=text,ek.readOnly=false,file.name=name,file.h=h,file.ed=ek):"?"},

newfile=x=>loadfile(newfilename.value+'.'+af(newfiletype.querySelectorAll('input')).filter(x=>x.checked)[0].value,"")

//openfile=f=>(f=openfilename.files[0],f.text().then(r=>loadfile(f.name,r)))

</script>

<div class="bordered tui-bg-blue-black" style="width:100vw;height:100vh">
 <nav class="tui-nav absolute">
  <ul>
   <li id="fmenu" tabindex="1" class="tui-dropdown">
    <span class="red-168-text">F</span>ile
    <div class="tui-dropdown-content">
    <ul>
     <li tabindex="2" onclick="show(filenew)"> <a href="#!"> <span class="red-168-text">N</span>ew </a> </li>
     <li tabindex="3" onclick="fileopen()"> <a href="#!"> <span class="red-168-text">O</span>pen...  <span class="tui-shortcut">F3</span> </a> </li>
     <li tabindex="4" > <a href="#!"> <span class="red-168-text">S</span>ave <span class="tui-shortcut">F2</span> </a> </li>
     <li tabindex="5" > <a href="#!">S<span class="red-168-text">a</span>ve as...</a> </li>
    </ul>
   </li>
   <li id="emenu" tabindex="6" class="tui-dropdown"> <span class="red-168-text">E</span>dit <!--Undo Redo|Cut Copy Paste Clear Copy example|Show clipboard-->
    <div class="tui-dropdown-content">
    <ul>
     <li tabindex="7"> <a href="#!"> <span class="red-168-text">C</span>ut </a> </li>
     <li tabindex="8"> <a href="#!"> C<span class="red-168-text">o</span>py </a> </li>
     <li tabindex="9"> <a href="#!"> <span class="red-168-text">P</span>aste </a> </li>
    </ul>
   </li>
   <li id="smenu" class="tui-dropdown"> <span class="red-168-text">S</span>earch <!--Find Replace Search again|Go to line number... Previous error Next error Locate function...--> </li>
   <li id="rmenu" class="tui-dropdown"> <span class="red-168-text">R</span>un <!--Run Ctrl+F9 Program reset Ctrl+F2 Go to cursor F4 Trace into F7 Step over F8 Arguments...--> </li>
   <li id="cmenu" class="tui-dropdown"> <span class="red-168-text">C</span>ompile <!--Compile Alt-F9 Make F9 Link Build add|Information... Remove messages--> </li>
   <li id="dmenu" class="tui-dropdown"> <span class="red-168-text">D</span>ebug <!--Inspect... Alt-F4 Evaluate/modify... Ctrl+F4 Call stack... Ctrl-F3 Watches→ Toggle breakpoint Ctrl-F8 Breakpoints... --> <!--Add watch... Ctrl-F7 Delete watch Edit watch... Remove all watches--> </li>
   <li id="wmenu" class="tui-dropdown" style="float:right;margin-left:10px"> <span class="red-168-text">H</span>elp </li>
   <li id="hmenu" class="tui-dropdown" style="float:right;margin-left:10px"> <span class="red-168-text">W</span>indow </li>
  </ul>
 </nav>

 <div style="position:absolute;top:20px;height:calc(100% - 45px);width:100%;display:flex;flex-flow:column">

  <div id="main" class="full-width" style="display:flex;flex-grow:2">

   <div id="left" style="height:100%;width:30%;display:flex;flex-flow:column;resize:horizontal;overflow:auto">
   
    <div id="w_a" class="tui-window full-width h2 tui-no-shadow">
     <fieldset class="tui-fieldset full-height">
      <legend class="center">AI.A</legend>
      <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
      <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
      <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
      <span class="tui-fieldset-text" style="margin-left: 50px;">&nbsp;1:1&nbsp;</span>
      <textarea id="ea" class="tui-textarea full-width full-height" style="overflow:scroll;" spellcheck="false"></textarea>
     </fieldset>
    </div>
   </div>
  
  
   <div id="right" style="height:100%;width:70%;display:flex;flex-flow:column">
  
    <div id="w_k" class="tui-window full-width h1 tui-no-shadow">
     <fieldset class="tui-fieldset full-height">
      <legend class="center">A.K</legend>
      <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
      <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
      <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
      <span class="tui-fieldset-text" style="margin-left: 50px;">&nbsp;1:1&nbsp;</span>
      <textarea id="ek" class="tui-textarea full-width full-height" style="overflow:scroll;" spellcheck="false"></textarea>
     </fieldset>
    </div>
  
    <div id="w_c" class="tui-window full-width h1 tui-no-shadow">
     <fieldset class="tui-fieldset full-height">
      <legend class="center">A.C</legend>
      <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
      <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
      <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
      <span class="tui-fieldset-text" style="margin-left: 50px;">&nbsp;1:1&nbsp;</span>
      <textarea id="ec" class="tui-textarea full-width full-height" style="overflow:scroll;" spellcheck="false"></textarea>
     </fieldset>
    </div>
  
    <div id="wo" class="tui-window full-width h1 tui-no-shadow" style="background:black">
     <fieldset class="tui-fieldset full-height">
      <legend class="center">&nbsp;OUT&nbsp;</legend>
      <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
      <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
      <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
      <!--pre id="out" style="margin:0"></pre-->
      <textarea id="out" class="tui-textarea full-width full-height" spellcheck="false" readonly></textarea>
     </fieldset>
    </div>
   </div>
  </div>

  <div id="wd" class="tui-window full-width h1 tui-no-shadow cyan-168 hidden">
   <fieldset class="tui-fieldset full-height">
    <legend class="center">&nbsp;DEBUG&nbsp;</legend>
    <span class="tui-fieldset-button" onclick="fullcol(this)"><span class="green-255-text">↕</span></span>
    <span class="tui-fieldset-button left" onclick="fullscr(this)"><span class="green-255-text">■</span></span>
    <span class="tui-fieldset-text top right" style="margin-right: 50px">1</span>
    <pre>
    </pre>
    <!--textarea class="tui-textarea full-width" style="height: 200px; overflow: scroll;" spllcheck="false">
    </textarea-->
   </fieldset>
  </div>
 </div>

 
 <div class="tui-statusbar absolute">
  <ul>
   <li><a href="#!"><span class="red-168-text">F1</span> Help</a></li>
   <li><a href="#!"><span class="red-168-text">F2</span> Save</a></li>
   <li><a href="#!"><span class="red-168-text">F3</span> Open</a></li>
   <li><a href="#!"><span class="red-168-text">Ctrl+F9</span> Run</a></li>
   <li><a href="#!"><span class="red-168-text">Alt+F9</span> Compile</a></li>
   <!--span class="tui-statusbar-divider"></span-->
   <li style="float:right;"><a href="#!"><span class="red-168-text">F10</span> Menu</a></li>
  </ul>
 </div>
</div>
<a id="dl" style="display:none"></a>
 
<!-- dialogs -->
<div class="tui-overlap"></div>
<div id="filenew" class="tui-modal center" >
 <div class="tui-window">
  <fieldset class="tui-fieldset">
  <legend class="center">New File</legend>
  <fieldset id="newfiletype" class="tui-input-fieldset">
   <legend>Type</legend>
   <label class="tui-radio">k<input type="radio" name="filetype" value="k" checked/><span></span></label>
   <label class="tui-radio">c<input type="radio" name="filetype" value="c" /><span></span></label>
   <label class="tui-radio">assembly<input type="radio" name="filetype" value="a"/><span></span></label>
  </fieldset>
  <br>
  <fieldset class="tui-input-fieldset">
   <legend>Name</legend>
   <input id="newfilename" class="tui-input" value="a"></input>
  </fieldset>
  <br>
  <div class="tui-divider"></div>
  <br>
  <button class="tui-button tui-modal-close-button left white-255-text" data-modal="filenew" onclick="newfile()" >ok</button>
  <span> </span>
  <button class="tui-button tui-modal-close-button right white-255-text cyan-168" data-modal="filenew">close</button>
  </fieldset>
 </div>
</div>

<!--div id="fileopen" class="tui-modal center">
 <div class="tui-window">
  <fieldset class="tui-fieldset">
   <legend class="center">Open</legend>
   File <input id="openfilename" class="tui-input full-width" type="file"/>
  <br>
  <div class="tui-divider"></div>
  <br>
  <button class="tui-button tui-modal-close-button left white-255-text" data-modal="fileopen" onclick="openfile()">ok</button>
  <span> </span>
  <button class="tui-button tui-modal-close-button right white-255-text cyan-168" data-modal="fileopen">close</button>
  </fieldset>
 </div>
</div-->

<script>
[ek,ec,ea].forEach(x=>x.onselectionchange=e=>{e=e.target
 let l=1,p=e.selectionStart,t=e.value.slice(0,p),i=t.indexOf("\n");
 while(i>=0&&i<p){l++;i=t.indexOf("\n",1+i)};let c=p-t.lastIndexOf("\n")
 e.previousElementSibling.innerHTML="&nbsp;"+l+":"+c+"&nbsp;"})

let name=window.location.hash.slice(1);if(name){fetch(name).then(r=>r.text()).then(t=>loadfile(name,t))}
let O=x=>{out.value+=x;out.scrollTop=out.scrollHeight},
help=_=>out.value="help..\n",
save=async _=>{
 if(file.h==null)return
 let w=await file.h.createWritable()
 await w.write(file.ed.value)
 await w.close()
 unmark(file.ed.closest(".tui-window"))
},
fileopen=async _=>{
 let[h]=await window.showOpenFilePicker({types:[{accept:{"ktye/k":".k","ktye/c":".c","ktye/asm":".a"}}]});
 let f=await h.getFile();
 let t=await f.text();
 loadfile(f.name,t,h)
},
compile=_=>out.value="compile..\n",
run=_=>out.value="compile&run..\n",
handle=(e,f)=>{e.preventDefault();f()},
mark=w=>e=>{e=w.querySelector("legend");if(!e.textContent.trim().endsWith("*"))e.innerHTML="&nbsp;"+e.textContent.trim()+"*&nbsp;"},
unmark=w=>{let e=w.querySelector("legend");if(e.textContent.trim().endsWith("*"))e.innerHTML="&nbsp;"+e.textContent.trim().slice(0,-1)+"&nbsp;"},
download=(u,n)=>{let x=new Blob([u],{type:"application/octet-stream"});dl.href=URL.createObjectURL(x);dl.download=n;dl.click()}

ea.onchange=mark(w_a);ek.onchange=mark(w_k);ec.onchange=mark(w_c)
window.onkeydown=e=>
 ("f"==e.key&&e.altKey)?handle(e,_=>fmenu.focus()):
 ("e"==e.key&&e.altKey)?handle(e,_=>emenu.focus()):
 ("s"==e.key&&e.altKey)?handle(e,_=>smenu.focus()):
 ("r"==e.key&&e.altKey)?handle(e,_=>rmenu.focus()):
 ("c"==e.key&&e.altKey)?handle(e,_=>cmenu.focus()):
 ("d"==e.key&&e.altKey)?handle(e,_=>dmenu.focus()):
 ("w"==e.key&&e.altKey)?handle(e,_=>wmenu.focus()):
 ("h"==e.key&&e.altKey)?handle(e,_=>hmenu.focus()):
 ("F1"==e.key)?handle(e,help):
 ("F2"==e.key)?handle(e,save):
 ("F3"==e.key)?handle(e,fileopen):
 ("F9"==e.key&&e.ctrlKey)?handle(e,run):
 ("F9"==e.key&&e.altKey)?handle(e,compile):
 ("F10"==e.key)?handle(e,_=>{fmenu.focus()}):true

let accel={fmenu:{
	"n":_=>show(filenew),
 	"o":fileopen,
}}

/*
fmenu.onkeydown=e=>console.log("fmenu key", e.key)
 ("n"==e.key)?handle(e,newfile):
 ("o"==e.key)?handle(e,open):
 ("s"==e.key)?handle(e,save):
 ("a"==e.key)?handle(e,saveas):false
 */

//left-right
af(document.querySelectorAll(".tui-dropdown")).forEach((x,i,a)=>x.onkeydown=e=>{ 
 (e.key=="ArrowRight")?(pd(e),a[min(a.length-1,1+i)].focus()):
 (e.key=="ArrowLeft")?(pd(e),a[max(0,i-1)].focus()):
 (e.key=="ArrowDown")?(pd(e),e.target.querySelector("li").focus()):
 (e.key=="Escape")?e.target.blur():
 (e.key in accel[x.id]?handle(e,accel[x.id][e.key]):true)
 })

//up-down
af(document.querySelectorAll(".tui-dropdown-content")).forEach(x=>
 af(x.querySelectorAll("li")).forEach(x=>x.onkeydown=e=>
  (e.key=="ArrowDown")?x.nextElementSibling.focus():
  (e.key=="ArrowUp")?x.previousElementSibling.focus():
  (e.key=="Escape")?x.blur():
  true
 )
)
</script>

<script src="wa/wa.js"></script>
<script src="wa/link.js"></script>
<script src="wa/boot.js"></script>

</body></html>
