<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel=icon href="kelas16.png">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1">
<title>ktye/k</title>
<style>*{font-family:monospace;margin:0;border:none;padding:0;/*font-size:xx-large*/}
body{overflow:hidden;height:100vh;display:grid;grid-template-rows:auto 1fr}
#i{flex-grow:1;min-height:4em;background-color:#ffe;/*position:absolute;*/width:100vw;/*height:50vh;*/top:0;outline:none;border:none;overflow:auto;resize:vertical}
#o{flex-grow:1;min-height:4em;background-color:#efe;/*position:absolute;*/width:100vw;/*height:50vh;top:50vh;*/;bottom:0;overflow:auto}
.b:hover{cursor:pointer}
</style>
<script src="plot.js"></script>
<script>

let K,B,lo=x=>Number(BigInt.asUintN(32,x)),C=()=>new Int8Array(K.memory.buffer),I=()=>new Uint32Array(K.memory.buffer),J=()=>new BigInt64Array(K.memory.buffer),F=()=>new Float64Array(K.memory.buffer),
KC=x=>{x=("string"===typeof x)?us(x):x;let r=K.mk(18,x.length);C().set(x,lo(r));return r},
CK=x=>(K.dx(x),su(new Uint8Array(K.memory.buffer,lo(x),K.nn(x)))),
Ks=s=>K.sc(KC(s)),sK=x=>CK(K.cs(x)),SK=x=>CL(K.Atx(17n,x)),CL=l=>{let j=J(),p=lo(l)>>>3,n=K.nn(l),r=[];for(let i=0;i<n;i++)r.push(CK(K.rx(j[p+i])));K.dx(l);return r},
LK=x=>{let n=K.nn(x),r=Array(n);for(let i=0;i<n;i++)r[i]=K.Atx(K.rx(x),K.Ki(i));K.dx(x);return r},
IK=x=>{let p=lo(x)>>>2,n=K.nn(x);let r=I().slice(p,p+n);K.dx(x);return r},iK=x=>lo(x),
FK=x=>{let p=lo(x)>>>3,n=K.nn(x);let r=F().slice(p,p+n);K.dx(x);return r},fK=x=>new Float64Array(K.memory.buffer,lo(x),1)[0],
ZK=x=>{let p=lo(x)>>>3,n=K.nn(x);let r=F().slice(p,p+2*n);K.dx(x);return r},zK=x=>new Float64Array(K.memory.buffer,lo(x),2),
su=x=>t_.decode(x),t_=new TextDecoder("utf-8"),us=x=>_t.encode(x),_t=new TextEncoder("utf-8"),
cw,

kenv={env:{ 
 Exit:  function(x      ){},
 Args:  function(       ){return 0},
 Arg:   function(x,y    ){return 0},
 Read:  function(a,b,c  ){return -1},
 //Write: function(a,b,c,d){let u=new Uint8Array(K.memory.buffer),v=u.slice(c,c+d);o.textContent+=su(v)+"\n";if(a)o.textContent+="\n";return 0},
 Write: function(a,b,c,d){let u=new Uint8Array(K.memory.buffer),v=u.slice(c,c+d),f=u.slice(a,a+b);a?down(su(f),v):o.textContent+=su(v)+"\n";return 0},
 ReadIn:function(x,y    ){return 0},
 Native:function(x,y  ,i){return[kplt,klns][lo(x)](y)}}},
kreg=(s,a,i,x)=>{x=K.l2(i,KC(s));
I()[(lo(x)>>>2)-3]=a;
K.dx(K.Asn(Ks(s),(14n<<59n)+BigInt(lo(x))))},
kinit=s=>{let n,nk=x=>{n=x.byteLength;return x}
 fetch("k.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(nk(r),kenv)).then(r=>{
 K=r.instance.exports;K.kinit();plots=0;pid=0;cnv.style.zIndex=-1
 kreg("plot",1,0n);kreg("LINES",1,1n);plots=0;pid=0;
 cw=measure.getBoundingClientRect().width/10
 if(!s)o.textContent="ktye/k "+n+"\n "+help;
 window.onresize() //K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cols()+" 20")))))
 argv().forEach(a=>{
  if(a.endsWith(".k"))K.repl(KC(fs[a].text))
  else if(a.endsWith(":.."))   K.dx(K.Asn(Ks(a.slice(0,-3)),KC(fs[a].text/*uint8array*/)))
  else if(a.endsWith("(json)"))K.dx(K.Asn(Ks(a.slice(0,-6)),kjson(fs[a].json)))
  else console.log("ignore",a)
 })
 if(s&&s.length<1000)window.location.hash="#"+encodeURIComponent(s)
 if(s)K.repl(KC(s))
 if(plots){scaleplot(plots);cnv.style.zIndex=10}
})},
cols=()=>Math.floor(document.body.getBoundingClientRect().width/cw),
klns=x=>K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cols()+" "+lo(K.Atx(x,K.Ki(0))))))),
kplt=x=>{x=K.Atx(x,K.Ki(0));let pn=x=>{if(plots.length<=x)plots[x]={};return x},pt=x=>{plots[pid].type=("square"==x)?"xy":x;plots[pid].square=x=="square"},ri=x=>{x=ZK(x);return[x.filter((_,i)=>i&1),x.filter((_,i)=>~i&1)]},la=x=>{x.push("","");[plots[pid].xlabel,plots[pid].ylabel,plots[pid].title]=x}
 let ln=x=>{if(!("lines"in plots[pid]))plots[pid].lines=[];let t=K.tp(x[0]),X;if(x.length>1&&22>t){X=(3==t)?iK(x[0]):(5==t)?fK(x[0]):(19==t)?IK(x[0]):FK(x[0]);x.shift()};x.forEach(y=>{let t=K.tp(y),v=(22==t)?ri(y):(19==t)?IK(y):FK(y);plots[pid].lines.push({x:X,y:(22==t)?v[0]:v,z:(22==t)?v[1]:undefined})})}
 if(plots===0){pid=0;plots=[]};if(undefined===plots[pid])plots[pid]={}
 let t=K.tp(x);
 (2==t)?plots[pid].styles=cK(x):(3==t)?pid=pn(lo(x)):(4==t)?pt(sK(x)):(18==t)?plots[pid].styles=CK(x):(20==t)?la(SK(x)):(19==t)?axis(IK(x)):(21==t)?axis(FK(x)):(22==t)?(pt("polar"),ln([x])):(23==t)?ln(LK(x)):K.dx(x)
 return K.Ki(pid)},
axis=x=>plots[pid].limits=Array.from(x),
scaleplot=a=>{
 let fs=x=>((x?0.8:1)*parseFloat(getComputedStyle(document.body).fontSize)*devicePixelRatio)+"px monospace"
 let p={plots:a,font1:fs(0),font2:fs(1)/*,cols:1*/}
 plotjs.plots(p,cnv,undefined/*{b:bac,f:fwd}*/,undefined/*pcap*/,x=>o.textContent=x)},
kjson=x=>{let r=0n,i,cat=(x,y)=>K.Cal(13n,K.l2(x,K.Atx(13n,y))),key=(x,y)=>K.Cal(12n,K.l2(x,y)),t=typeof x
 if(Array.isArray(x)){r=K.mk(23,0);x.forEach(x=>r=cat(r,kjson(x)));return r}
 return("number"==t)?K.Kf(x):(("boolean"==t)||(null===x))?K.Ki(+x):("string"==t)?KC(x):key(kjson(Object.keys(x)),kjson(Object.values(x)))},
csvhead=(f,x)=>{x=x.split("\n");if(x.length&&!x[x.length-1].length)x=x.slice(0,-1);x=x.map(y=>(y.endsWith("\r")?y.slice(0,-1):y));let r=f+": "+(x.length?x.length+"(lines)":"empty");if(!x.length)return r
 let x0=x[0].split(""),nc=x0.filter(x=>x==",").length,ns=x0.filter(x=>x==";").length,nt=x0.filter(x=>x=="\t").length,m=Math.max(nc,ns,nt),s=(nt==m)?"\t":(ns==m)?";":","
 r+=" "+m+"(cols) sep("+((s=="\t")?"tab":s)+")\n"
 x0=x[0].split(s);x0.forEach((x,i)=>r+=i+" "+x+"\n");return r},
csvform=f=>{ //",3if" => r:{h:0,s:",",3:'i',4:'f',..}
 let r={h:0},i=-1;r.s=32 // /[ \t]+/
 if(f.length&&!"h0123456789ifsz@z".includes(f[0])){r.s=f.charCodeAt();f=f.slice(1)}
 for(const m of f.matchAll(/([0-9]*)(.)/g)){
  if(m[1]=="h")r.h=(m[1]=="")?1:(+m[0])
  else{let n=(m[0]=="")?1+i:(+m[0]);i=n;r[n]=m[1]}};return r},
csvsplit=(f,u,ml)=>{let i,j=0,c=[],r=[],s=f.s,l=0,q=0,b=new Uint8Array(128),
 p=_=>{if(s!=32||j>0)c.push(su(b.slice(0,j)));j=0}
 for(i=0;i<u.length;i++){let v=u[i];q^=v==34;
  if(q){if(j<128)b[j++]=v}
  else if(v==s){if(s!=32||j>0)p()}
  else if(v==10){p();r.push(c);c=[];if(ml==len(r))return r}
  else if(v!=13&&j<128)b[j++]=v};return r}


/*
kcsv=x=>{let Q=x=>{o.textContent=x;throw(x)},f=CK(K.Atx(K.rx(x),K.Ki(0)));x=CK(K.Atx(K.rx(x),K.Ki(0)));if(!f.length)return K.mk(23,0);
 let s=/[ \t]+/;if(!"0123456789ifsa@zh".includes(f[0])){s=s[0];f=f.slice(1)}                         ;if(!f.length)return K.mk(23,0);
 let h,i=f.indexOf("h");h=(!i)?1:(-1==i)?0:parseFloat(h);if(i>=0)f=f.slice(1+i)                       ;if(!f.length)return K.mk(23,0);
 let c=[];i=-1;for(const m of f.matchAll(/([0-9]*)(.)/g)){let e=[(m[1]=="")?1+i:(+m[1]),m[2]];i=e[0];c.push(e);if(e[1]=="z")i++}
 x=x.split("\n").slice(h).map(x=>x.endsWith("\r")?x.slice(0,-1):x)                                    ;if(!x.length)return K.mk(23,0);
 let r=[],m={i:21,s:22,f:23,z:23,a:23};m["@"]=23;r=c.map(x=>{if(!(x[1]in m))Q("illegal csv column format: +"+x[1]);return K.mk(m[x[1]],0)})
 /*todo..*/ return K.mk(23,0)
}
*/

document.addEventListener('keydown',e=>{if(e.key=="Escape")cnv.style.zIndex=-1;false})



window.init=()=>{kinit()
 let f=window.location.hash;if(f)i.innerText=decodeURIComponent(f.slice(1))
 i.onblur=e=>{if(!o.textContent)kinit(i.innerText.replace(/^\\(.*)$/mg,"`<`k@$1"))}
 i.oninput=e=>o.textContent=""
}
window.onresize=e=>{K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cols()+" 20")))))}

let fs=[],
s=e=>{e=e.textContent;let x=fs[e].text;o.textContent=fs[e].csv?csvhead(e,x):("string"===typeof x)?x:e.slice(0,-3)+"("+x.length+" bytes)\n"+((x.length>100)?x.slice(0,100)+"..":x)},
l=x=>{fs[x.nextSibling.nextSibling.textContent].sel=x.checked},
argv=_=>Object.keys(fs).filter(x=>fs[x].sel),
ref=_=>fetch("klib/ref").then(r=>r.text()).then(r=>o.textContent=r),
suf=(x,i)=>(i=x.indexOf("."),x=x.endsWith(".k")?x:x.endsWith(".json")?x.slice(0,-5)+"(json)":x.endsWith(".csv")?x.slice(0,-4)+"(csv)":(((i>0)?x.slice(0,i):x)+":.."),x),
addfile=(name,s,fe)=>{let csv=name.endsWith(".csv");name=suf(name);
 fs[name]={name:name,text:fe?"":s,sel:false,csv:csv};
 if(name.endsWith("(json)")){try{fs[name].json=JSON.parse(s)}catch(e){console.log(e);o.textContent=name+":\n"+e.message}}
 if(csv)o.textContent=csvhead(name.slice(0,-4)+".csv",s)
 first.insertAdjacentHTML('beforebegin','\n<input type="checkbox" onchange="l(this)"> <label class="b" id="'+name+'" onclick="s(this,true)">'+name+'</label>' );
 if(csv)first.insertAdjacentHTML('beforebegin',':<label contenteditable="true" style="background:#ffe;border:none;outline:none">,hss</label>')
 if(fe)fetch("klib/"+name).then(r=>r.text()).then(r=>fs[name].text=r)},
addfiles=l=>{for(let i=0;i<l.length;i++){let f=l.item(i)
 if(suf(f.name).endsWith(":.."))f.arrayBuffer().then(s=>{addfile(f.name,new Uint8Array(s),false);mark(f.name)})
 else                           f.text(       ).then(s=>{addfile(f.name,s                ,false);mark(f.name)})};o.textContent=""},
mark=x=>{let l=Array.from(menu.querySelectorAll("label")).filter(y=>y.innerText==suf(x));if(1==l.length){l[0].previousElementSibling.checked=true;fs[suf(x)].sel=true} },
down=(f,u)=>{let x=new Blob([u],{type:"application/octet-stream"});dl.href=URL.createObjectURL(x);dl.download=f;dl.click()}


window.ondragover=e=>{e.preventDefault();e.stopPropagation()}
window.ondrop=e=>{e.preventDefault();e.stopPropagation();addfiles(e.dataTransfer.files)}

var help=`\n\nthe yellow field above is the input editor.
edit and click elsewhere to execute.

select k-libs from the menu. click on the name to see them.
they are executed before the input.

load files from the filesystem, or drop them into the window.
.k files appear as libraries, .json&.csv files are parsed
and other files are assigned a variable by their name as bytes.
`

var json=`drop a json file, e.g. a.json and it appears as
 a(json) 
in the file list.
it is converted and assigned to variable a in k.

conversion
 string:   chars
 object:   dict (symbol keys)
 number:   float
 bool,null:int
`

var csv=`drop a csv file on the window and select it from the file panel.
e.g. a.csv appears as a(csv):,h?? then edit the format (see below).

a summary of the first line with guessed delimiter is shown in the output.

in k, the parsed csv file is assigned to 'a' as a list of columns.
to get a table, do:
 t:+\`x\`y\`z!a

format:
 ;2hifs   /use semicolon, remove 2 header lines
          /use columns 0 1 2 as ints, floats, symbols 
 ,3i10ff  /use columns 3 as ints, 10 and 11 as floats
          /by default the columns separator is blanks
 i int
 f float
 s symbol
 a complex 1a30 
 @ complex 1@30
 z complex 2 columns: abs degree
 
`
var io=`only the last expression is displayed automatically
by default in matrix format (\`l@x)
to switch to single line k  (\`k@x) prepend a space

matrix format uses 20 lines by default. this can be changed with
 LINES 100 

for debugging, prepend a backslash before a line
\\x:1+!10
or within an expression after space:
 x:1+ \\!10
you can add a label to the left:
 x:1+\`a \\!10

write to stdout with:
\`<"chars.."

or to a file (which triggers a download):
\`"file.txt"<"abc.."
`
</script>
</head>

<body onload="window.init()">
<pre id="i" contenteditable="true" spellcheck="false" autofocus>plot(!100;?100)
plot`alpha`beta`gamma
</pre>
<pre id="o">a
b
c</pre>
<canvas id="cnv" style="position:absolute;left:0;bottom:0;width:80vw;height:60vh;z-index:-1"></canvas>
<pre id="menx" class="b"          style="position:absolute;z-index:-1;right:0px;bottom:20px;background:#eef" onclick='menx.style.zIndex=-1;menu.style.display=""'> ? </pre>
<pre id="menu" spellcheck="false" style="position:absolute;z-index:10;right:0;bottom:0;background:#eef">
<label for="f" class="b">load/drop file</label><input id="f" type="file" onchange="addfiles(this.files)", style="display:none"><label id="first"></label>
<label class="b" onclick="ref()">ref</label> <a target="_blank" href="https://github.com/ktye/i/blob/master/intro.md">intro.md</a> <label class="b" title="close" onclick='menu.style.display="none";menx.style.zIndex=10'>x</label>
</pre>
<span id="measure" style="position:absolute;top:0;z-index:-1">0123456789</span>
<a id="dl" style="display:none"></a>


<script>
i.addEventListener('paste',e=>{e.preventDefault();
 let t=e.clipboardData.getData("text/plain"),s=window.getSelection()
 if(s.rangeCount){s.deleteFromDocument();s.getRangeAt(0).insertNode(document.createTextNode(t))};o.textContent=""})

let 
addhelp=(e,h)=>document.getElementById(e).insertAdjacentHTML("afterend",h)
showhelp=x=>{o.textContent=x}
addfile("qr.k","",true);addhelp("qr.k","<label class='b' onclick='showhelp(help)'>   help</label>")
addfile("lu.k","",true);addhelp("lu.k","<label class='b' onclick='showhelp(json)'>   json</label>")
addfile("svd.k","",true);addhelp("svd.k","<label class='b' onclick='showhelp(csv)'>   csv</label>")
addfile("fft.k","",true);addhelp("fft.k","<label class='b' onclick='showhelp(io)'>    io</label>")
addfile("plot.k","",true)
addfile("stats.k","",true)
addfile("interp.k","",true)
</script>

</body></html>
