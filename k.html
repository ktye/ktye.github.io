<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel=icon href="kelas16.png">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1">
<title>ktye/k</title>
<style>*{font-family:monospace;margin:0;border:none;padding:0;font-size:xx-large}
body{overflow:hidden;height:100vh;display:grid;grid-template-rows:auto 1fr}
#i{flex-grow:1;min-height:3em;background-color:#ffe;/*position:absolute;*/width:100vw;/*height:50vh;*/top:0;outline:none;border:none;overflow:auto;resize:vertical}
#o{flex-grow:1;min-height:3em;background-color:#efe;/*position:absolute;*/width:100vw;/*height:50vh;top:50vh;*/;bottom:0;overflow:auto}
.b:hover{cursor:pointer}
</style>
<script>

let K,B,lo=x=>Number(BigInt.asUintN(32,x)),C=()=>new Int8Array(K.memory.buffer),U=()=>new Uint32Array(K.memory.buffer),KC=x=>{x=("string"===typeof x)?us(x):x;let r=K.mk(18,x.length);C().set(x,lo(r));return r},Ks=s=>K.sc(KC(s)),
su=x=>t_.decode(x),t_=new TextDecoder("utf-8"),us=x=>_t.encode(x),_t=new TextEncoder("utf-8"),
save=()=>{B=C().slice(0,1<<U()[32])},restore=()=>{C().set(B)},cw,

kenv={env:{ 
 Exit:  function(x      ){},
 Args:  function(       ){return 0},
 Arg:   function(x,y    ){return 0},
 Read:  function(a,b,c  ){return -1},
 Write: function(a,b,c,d){let u=new Uint8Array(K.memory.buffer),v=u.slice(c,c+d);o.textContent+=su(v);if(a)o.textContent+="\n";return 0},
 ReadIn:function(x,y    ){return 0},
 Native:function(x,y    ){return 0}}},
kinit=s=>{let n,nk=x=>{n=x.byteLength;return x}
 fetch("k.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(nk(r),kenv)).then(r=>{
 K=r.instance.exports;K.kinit()
 cw=measure.getBoundingClientRect().width/10
 if(!s)o.textContent="ktye/k "+n+"\n "+help;
 window.onresize() //K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cols()+" 20")))))
 argv().forEach(a=>{
  if(a.endsWith(".k"))K.repl(KC(fs[a].text))
  else if(a.endsWith(".csv"))console.log("todo csv") // e.g.with input "iiff"
  else if(a.endsWith(":.."))K.dx(K.Asn(Ks(a.slice(0,-3)),KC(fs[a].text/*uint8array*/)))
  else console.log("ignore",a)
 })
 if(s)K.repl(KC(s))
})},
cols=()=>Math.floor(document.body.getBoundingClientRect().width/cw)

window.init=()=>{kinit()
 let f=window.location.hash;if(f)fetch(f.slice(1)).then(r=>r.text()).then(r=>i.textContent=r)
 i.onblur=e=>{if(!o.textContent)kinit(i.innerText.replace(/^\\(.*)$/mg,"`o<`k@$1"))}
 i.oninput=e=>o.textContent=""
}
window.onresize=e=>{K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cols()+" 20")))))}

let fs=[],
s=e=>o.textContent=fs[e.textContent].text,
l=x=>{fs[x.nextSibling.nextSibling.textContent].sel=x.checked},
argv=_=>Object.keys(fs).filter(x=>fs[x].sel),
ref=_=>fetch("klib/ref").then(r=>r.text()).then(r=>o.textContent=r),
suf=(x,i)=>(i=x.indexOf("."),x=x.endsWith(".k")?x:x.endsWith(".csv")?x:(((i>0)?x.slice(0,i):x)+":.."),x),
addfile=(name,s,fe)=>{name=suf(name);fs[name]={name:name,text:fe?"":s,sel:false};first.insertAdjacentHTML('beforebegin','\n<input type="checkbox" onchange="l(this)"> <label class="b" onclick="s(this,true)">'+name+'</label>' );if(fe)fetch("klib/"+name).then(r=>r.text()).then(r=>fs[name].text=r) },
addfiles=l=>{for(let i=0;i<l.length;i++){let f=l.item(i);
 if(suf(f.name).endsWith(":.."))f.arrayBuffer().then(s=>addfile(f.name,new Uint8Array(s),false))
 else                           f.text(       ).then(s=>addfile(f.name,s,false))
}}

window.ondragover=e=>{e.preventDefault();e.stopPropagation()}
window.ondrop=e=>{console.log(e);e.preventDefault();e.stopPropagation();addfiles(e.dataTransfer.files)}

const help=`\n\nthe yellow field above is the input editor.
if you click elsewhere, it is executed.

select k-libs from the menu. click on the name to see them.
they are executed before the input.

load files from the filesystem, or drop them into the window.
.k files appear as libraries, .csv file(todo)
and other files are assigned a variable by their name as bytes.

todo csv,plot
`
</script>
</head>

<body onload="window.init()">
<pre id="i" contenteditable="true" spellcheck="false" autofocus>!1</pre>
<pre id="o">a
b
c</pre>
<pre id="menu" spellcheck="false" style="position:absolute;z-index:10;right:0;bottom:0;background:#eef">
<label for="f">load/drop/kcsv</label><input id="f" type="file" onchange="addfiles(this.files)", style="display:none"><label id="first"></label>
<label class="b" onclick="ref()">ref</label> <a target="_blank" href="https://github.com/ktye/i/blob/master/intro.md">intro.md</a> <label class="b" title="close" onclick='menu.style.display="none"'>x</label>
</pre>
<span id="measure" style="position:absolute;top:0;z-index:-1">0123456789</span>

<!--
<input type="checkbox" onchange="l(this)"> <label class="b" onclick="s(this)">qr.k</label>
<input type="checkbox" onchange="l(this)"> <label class="b" onclick="s(this)">lu.k</label>
<input type="checkbox" onchange="l(this)"> <label class="b" onclick="s(this)">svd.k</label>
<input type="checkbox" onchange="l(this)"> <label class="b" onclick="s(this)">fft.k</label>
<input type="checkbox" onchange="l(this)"> <label class="b" onclick="s(this)">stats.k</label>
<input type="checkbox" onchange="l(this)"> <label class="b" onclick="s(this)">interp.k</label>
-->

<script>
"qr lu svd fft stats interp".split(" ").forEach(s=>addfile(s+".k","",true))
</script>

</body></html>
