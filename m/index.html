<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel="icon" href='data:;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAACVBMVEX/AAAAAAD////KksOZAAAAMElEQVR4nGJYtWrVKoYFq1ZxMSyYhkZMgxNRXAwLpmbBCDAXSRZEgAwAGQUIAAD//+QzHr+8V1EyAAAAAElFTkSuQmCC'>
<link rel="manifest" href="k.webmanifest">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="theme-color" content="#fff"/>
<title>k</title>

<style>
*{font-family:monospace;font-size:large}
html{height:100%}
body{height:100%;overflow-y:hidden;display:block;margin:0;overflow:hidden}
pre{margin:0}
.invisible{display:none}
#inp{color:darkred;height:1em;width:100%;padding-left:0.5em;margin-top:1em;margin-bottom:0.2em}
#tty{height:40%;border-bottom:1px solid}
#edt{width:100%;height:40%;resize:none;color:darkred;border:none;border-bottom:1px solid;outline:none;white-space:nowrap;overflow:auto}
#mono{position:absolute;left:100;top:100;visibility:hidden}
.buttons{display:flex;justify-content:space-between}
[contenteditable]{outline:0px solid transparent;}
</style></head>

<body onload="window.init()">
<pre id="inp" contenteditable="true" autocapitalize="off">!10</pre>
<pre id="tty"></pre>
<textarea id="edt" class="invisible" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
<div class="buttons">
 <button id="edtbut" onclick="edit()">edit</button>
 <button id="runbut" onclick="run()" class="invisible">run</button>
 <button id="shrbut" onclick="share()">share</button>
 <button id="dwnbut" onclick="download()" class="invisible">save</button>
 <button id="rstbut" onclick="kinit()">reset</button>
 <button id="filbut" onclick="lfile()" class="invisible">load</button>
 <input  id="filebut" type="file" onchange="loadfile()" style="display:none"/>
</div>
<pre id="mono">M 0 1 2 3 4 5 6 7 8 9 0</pre>
<a id="dl" style="display:none"></a>

<script> 
//navigator.serviceWorker.register("k.sw.js")

let ge=x=>document.getElementById(x)
let ce=x=>document.createElement(x)
let ct=x=>document.createTextNode(x)
let rm=(p)=>{while(p.firstChild)p.removeChild(p.firstChild);return p}
let te_=new TextEncoder("utf-8"),us=x=>te_.encode(x)
let td_=new TextDecoder("utf-8"),su=x=>td_.decode(x)
let tty=ge("tty"),inp=ge("inp"),edt=ge("edt"),edtbut=ge("edtbut"),runbut=ge("runbut"),shrbut=ge("shrbut"),dwnbut=ge("dwnbut"),rstbut=ge("rstbut"),filbut=ge("filbut")

let O=s=>{tty.textContent=(tty.textContent+s).split("\n").slice(-rows).join("\n")}
ttysize=()=>{let mono=ge("mono");let n=mono.textContent.length
 return{cols:Math.floor(n*tty.clientWidth/mono.clientWidth),
        rows:Math.floor(tty.clientHeight/mono.clientHeight)}}


window.onerror=(m,s,l,c,e)=>O(m+e)

let K,rows
let kinit=(x)=>{
 let cs=ttysize();rows=cs.rows
 focus()
 fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(r,env)).then(r=>{
  K=r.instance.exports;K.kinit();
  K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cs.cols+" 20")))))
  tty.textContent="ktye/k\n"
  if(x)K.dx(K.Val(KC(x)))
})}
window.init=()=>{
 let s=decodeURIComponent(window.location.hash.substr(1))
 if(s){edt.value=s;edit();return}
 kinit()
 if("launchQueue"in window)launchQueue.setConsumer(async(x)=>{
  let f=await x.files[0].getFile()
  edt.value=await f.text()
  edit()
 })
}

let env={env:{
 Exit:x=>{},
 Args:()=>{return 0},
 Arg:(x,y)=>{return 0},
 Read:(x,y,z)=>{return 0},
 Write:(x,y,z,n)=>{let d=new Uint8Array(n);d.set(new Uint8Array(K.memory.buffer,z,n));O(su(d));return 0},
 ReadIn:(x,y)=>{return 0},
 Native:(x,y)=>{return 0},
}}

let lo=x=>Number(BigInt.asUintN(32,x))
let C=()=>new Int8Array(K.memory.buffer)
let KC=x=>{x=("string"==typeof x)?us(x):x;let r=K.mk(18,x.length);C().set(x,lo(r));return r}
let CK=x=>{let n=K.nn(x);K.dx(x);return su(U().slice(lo(x),lo(x)+n))}
let Ks=x=>K.sc(KC(x))

tty.onclick=()=>focus()
inp.onkeydown=(e)=>{
 if(e.key=="Enter"){e.preventDefault();let s=e.target.textContent;if("\\e"==s)return edit();if("\\s"==s)return share();if("\\r"==s)return kinit();if(s.startsWith("\\"))return help();keval(s)}
}
let keval=s=>{tty.textContent+=" "+s+"\n";K.repl(KC(us(s)))}

let screens=[edtbut,runbut,rstbut,inp,tty,edt,dwnbut,filbut]
let edit=()=>{
 for(let i=0;i<screens.length;i++)screens[i].classList.toggle("invisible")
 edt.focus()}
let run=()=>{
 for(let i=0;i<screens.length;i++)screens[i].classList.toggle("invisible")
 kinit(edt.value);focus()}

let download=()=>{
 let x=new Blob([us(edt.value)],{type:"application/octet-stream"})
 dl.href=URL.createObjectURL(x);dl.download="a.k";dl.click()}
let lfile=(e)=>ge("filebut").click()
let loadfile=async (e)=>edt.value=await ge("filebut").files[0].text()

let focus=()=>{inp.focus()
 let r=document.createRange();r.selectNodeContents(inp);r.collapse(false)
 let s=window.getSelection();s.removeAllRanges();s.addRange(r)}

async function share(){let t=edt.value;await navigator.share({
 title:"share k file",
 url:"https://ktye.github.io/m/index.html#"+encodeURI(t),
 text:t,
 //files:[new File([t],"a.k",{type:"text/plain"})],
})}

let help=()=>{tty.textContent="\\e(edit)\n\\s(share)\n\\r(reset)"}

</script>

</body></html>
