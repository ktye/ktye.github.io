<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel=icon href='data:;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAACVBMVEX/AAAAAAD////KksOZAAAAMElEQVR4nGJYtWrVKoYFq1ZxMSyYhkZMgxNRXAwLpmbBCDAXSRZEgAwAGQUIAAD//+QzHr+8V1EyAAAAAElFTkSuQmCC'>
<link rel="manifest" href="k.webmanifest">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="theme-color" content="#fff"/>
<title>k</title>

<style>
.flex{display:flex}
.hidden{display:none}
.invisible{display:none}
*{font-family:monospace}
html{height:100%}
body{height:100%;overflow-y:hidden;display:block}
#tty{height:50%}
#mono{position:absolute;left:100;top:100;visibility:hidden}
[contenteditable]{outline:0px solid transparent;}
</style></head>

<body onload="window.init()">
<pre id="tty"></pre>
<pre id="mono">M 0 1 2 3 4 5 6 7 8 9 0</pre>

<script> 
//navigator.serviceWorker.register("k.sw.js")

let ge=x=>document.getElementById(x)
let ce=x=>document.createElement(x)
let ct=x=>document.createTextNode(x)
let rm=(p)=>{while(p.firstChild)p.removeChild(p.firstChild);return p}
let te_=new TextEncoder("utf-8"),us=x=>te_.encode(x)
let td_=new TextDecoder("utf-8"),su=x=>td_.decode(x)
let tty=ge("tty")

let O=s=>tty.appendChild(ct(s))
clip=()=>{
 let cs=ttysize()
 let v=tty.textContent.split("\n")
 tty.textContent=v.slice(-(cs.rows+tty.textContent.endsWith("\n"))).join("\n")},
ttysize=()=>{let mono=ge("mono");let n=mono.textContent.length
 return{cols:Math.floor(n*tty.clientWidth/mono.clientWidth),
        rows:Math.floor(tty.clientHeight/mono.clientHeight)}}


window.onerror=(m,s,l,c,e)=>O(m+e)

/*
inp.onchange=e=>{O(" "+e.target.value+"\n");
 let rc=consize(),[w,h]=cnvsize()
 worker.postMessage({m:"repl",t:e.target.value,r:rc.rows,c:rc.cols,w:w,h:h})}
*/

let K
window.init=function(){
 let cs=ttysize()
 fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>WebAssembly.instantiate(r,env)).then(r=>{
  K=r.instance.exports;K.kinit();
  K.dx(K.Asn(Ks("l."),K.Atx(Ks("lxy"),K.Val(KC(cs.cols+" "+cs.rows)))))
  keval("!100")
})}

let env={env:{
 Exit:x=>{},
 Args:()=>{return 0},
 Arg:(x,y)=>{return 0},
 Read:(x,y,z)=>{return 0},
 Write:(x,y,z,n)=>{let d=new Uint8Array(n);d.set(new Uint8Array(K.memory.buffer,z,n));O(su(d));return 0},
 ReadIn:(x,y)=>{return 0},
 Native:(x,y)=>{return 0},
}}

let lo=x=>Number(BigInt.asUintN(32,x))
let C=()=>new Int8Array(K.memory.buffer)
let KC=x=>{x=("string"==typeof x)?us(x):x;let r=K.mk(18,x.length);C().set(x,lo(r));return r}
let CK=x=>{let n=K.nn(x);K.dx(x);return su(U().slice(lo(x),lo(x)+n))}
let Ks=x=>K.sc(KC(x))

let keval=(s)=>{rm(tty);tty.appendChild(ce("br"));tty.appendChild(ct(" "))
 let sp=ce("span");sp.contentEditable=true;sp.style.color="darkred";sp.textContent=s;tty.appendChild(sp)
 sp.onkeydown=(e)=>{if(e.key=="Enter"){e.preventDefault();keval(sp.textContent)}}
 tty.appendChild(ce("br"))
 K.repl(KC(us(s)))
}

//click on share button
//share.onclick=async e=>{await navigator.share({title:"share k file",text:edt.value})}

</script>

</body></html>
