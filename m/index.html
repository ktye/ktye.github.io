<!DOCTYPE html>
<head><meta charset="utf-8">
<link rel=icon href='data:;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAACVBMVEX/AAAAAAD////KksOZAAAAMElEQVR4nGJYtWrVKoYFq1ZxMSyYhkZMgxNRXAwLpmbBCDAXSRZEgAwAGQUIAAD//+QzHr+8V1EyAAAAAElFTkSuQmCC'>
<link rel="manifest" href="/k.webmanifest">
<title>k/mobile</title>

<style>
.flex{display:flex}
.hidden{display:none}
.invisible{display:none}
*{font-family:monospace;font-size:20pt}
html{height:100%}
body{height:100%;overflow-y:hidden;display:block}
@media only screen and (min-width:1024px){            /*2columns on desktop*/
 .flex{width:50%}
 .hidden{display:flex}
 body{display:flex}
 #edit{margin-left:.5em}
 #edbut{display:none}
}
#repl{flex-direction:column;height:100%}
#edit{flex-direction:column;height:100%}
#inp {width:100%}
#edt {resize:none;margin-bottom:1em;margin-top:.5em}
#file{width:100%}
#kver{}
#out{font-size:17pt;margin-bottom:0;flex:auto;overflow:hidden}
#cnv{margin-top:.5em;margin-bottom:0;flex:auto;background:#efe}
#edt{font-size:17pt;flex:auto}
#stat{font-size:14pt;background:#eee}
.link{color:#0000EE}
.link:hover{cursor:pointer}
#brow{display:flex;flex-direction:column}
#mono{font-size:17pt;position:absolute;left:100;top:100;visibility:hidden}
</style></head>

<script src="plot.js"></script>

<body onload="window.init()">
<div id="repl" class="flex">
 <div style="display:flex;flex-direction:row">
  <input id="inp" value="+/1 2 3" spellcheck="off" autocomplete="off" spellcheck="false" autocorrect="off">
  <select id="kver"><option>atw</option><option>ktye</option><option>ngn</option></select>
  <button id="edbut" onclick="changescreen()">edit</button>
 </div>
 <pre    id="out"></pre>
 <canvas id="cnv" class="invisible"></canvas>
 <pre id="stat">offline</pre>
 </div>
 
</div>
<div id="edit" class="hidden flex">
 <div style="display:flex;flex-direction:row">
  <button id="save">save</button>
  <button id="open">open</button>
  <input  id="file" value="-"></input>
  <button id="dir">dir</button>
  <button id="share">share</button>
  <button id="run">run</button>
 </div>
 <textarea id="edt" spellcheck="false" autocorrect="off" wrap="off">x:1+ \!10
 1+`s
 2*x
 </textarea>
</div>
<div id="brow" class="hidden,flex"></div>
<pre id="mono">M 0 1 2 3 4 5 6 7 8 9 0</pre> <!--to measure console size-->



<script> 
//navigator.serviceWorker.register("./m.sw.js")

let ge=x=>document.getElementById(x)
let ce=x=>document.createElement(x)
let kver=ge("kver"),inp=ge("inp"),run=ge("run"),out=ge("out"),stat=ge("stat"),repl=ge("repl"),file=ge("file"),dir=ge("dir"),edit=ge("edit"),edt=ge("edt"),brow=ge("brow"),worker
inp.onchange=e=>{O(" "+e.target.value+"\n");
 let rc=consize(),[w,h]=cnvsize()
 worker.postMessage({m:"repl",t:e.target.value,r:rc.rows,c:rc.cols,w:w,h:h})}

window.onerror=function(m,s,l,c,e){console.log("windowonerror",m,e)}


window.init=function(){
 out.textContent=""
 let h=window.location.hash.slice(1)
 let p=h.indexOf(":")
 kver.value=(p>0)?h.slice(0,p):kver.value
 edt.value=(p>0)?decodeURIComponent(h.slice(1+p)):""
 start({f:"-",t:""},kfs)
}

let start=(f,fs)=>{if(worker)worker.terminate();worker=undefined;worker=new Worker(kver.value+".js",{name:kver.value})
 worker.onmessage=function(e){let d=e.data
  switch(d.m){
  case"write":    O(d.t);                  break
  case"stat":     setstat(d.t);            break
  case"filepos":  editat(d.f,d.l,d.c,d.p); break
  case"writefile":writefile(d.f,d.u);      break
  case"image":    cnvimage(d.u);           break
  case"plot":     plot(d.p);               break
  default: console.log("unknown message",d)
 }}
 worker.onerror=e=>O("worker "+e.message,"\n"+e.filename+":"+e.lineno)
 
 let [w,h]=cnvsize(),rc=consize()
 inp.value="!0"
 out.textContent=""
 worker.postMessage({m:"start",f,fs:fs,r:rc.rows,c:rc.cols,w:w,h:h})
}
let interrupt=()=>{} //todo

let O=s=>{out.textContent+=s;clip()},
clip=()=>{
 let cs=consize()
 let v=out.textContent.split("\n")
 out.textContent=v.slice(-(cs.rows+out.textContent.endsWith("\n"))).join("\n")},
consize=()=>{let mono=ge("mono");let n=mono.textContent.length
 return{cols:Math.floor(n*out.clientWidth/mono.clientWidth),
        rows:Math.floor(out.clientHeight/mono.clientHeight)}}


function setstat(s){     stat.classList.remove("link");stat.textContent=s;stat.f=undefined}
function editat(f,l,c,p){stat.classList.add   ("link");stat.textContent=f+":"+(1+l)+":"+(1+c);stat.f=f;stat.p=p}

run.onclick=e=>{ //click on run button
 changescreen()
 start({f:file.value,t:edt.value},kfs)
 let u=kver.value+":"+encodeURIComponent(edt.value)
 window.location.hash=(u.length<1000)?u:""
}

//change k version dropdown
kver.onchange=e=>{start({f:"-",t:""},kfs)}

//click on statusbar (jump to file position)
stat.onclick=e=>{if(("f"in stat)&&("string"==typeof stat.f)){
 changescreen()
 if(file.value==stat.f){ //todo or if file has been written open new file
  edt.setSelectionRange(stat.p,1+stat.p);edt.focus() //scrollIntoView?
 }
}}

//longpress on statusbar or doubleclick (restart)
stat.touch=null
stat.addEventListener("touchstart",e=>{stat.touch=e.timeStamp},{passive:true})
stat.addEventListener("touchend",e=>{
 dt=(stat.touch===null)?0:e.timeStamp-stat.touch
 if(dt>500){start({f:"-",t:""},kfs)}
},{passive: true})
stat.ondblclick=e=>{start({f:"-",t:""},kfs)}

//swipe out/editor (change screen)
let swipe=null
let swipestart=e=>{console.log("swipestart")
 let t=e.changedTouches[0];swipe={t:e.timeStamp,x:t.screenX,y:t.screenY}}
let swipeend=e=>{console.log("swipeend",swipe)
 let t=e.changedTouches[0];if(swipe!==null){
 let dx=t.screenX-swipe.x,dy=t.screenY-swipe.y;let a=Math.abs(dx)
  console.log("dx/dy",dx,dy)
 if((a>Math.abs(dy))&&(a>0.2*screen.width))changescreen()
}}
out.addEventListener("touchstart",swipestart,{passive:true})
out.addEventListener("touchend"  ,swipeend  ,{passive:true})

function changescreen(){
 repl.classList.toggle("hidden")
 edit.classList.toggle("hidden")
}


//click on open (open file from filesystem api)
let currentfile={name:"",h:null}                  //name/handle
ge("open").onclick=async e=>{
 let o={types:[{accept:{'text/plain':['.k']}}]}  //multiple:false,
 let[h]=await window.showOpenFilePicker(o)
 let f= await h.getFile()
 file.value=f.name;currentfile.name=f.name;currentfile.h=h
 edt.value= await f.text()
}
ge("save").onclick=async e=>{
 if(currentfile.name=file.value&&currentfile.h!==null){ //write directly
  const w=await currentfile.h.createWritable()
  await w.write(edt.value)
  await w.close();
 }else{                                                 //file save dialog
  let h=await self.showSaveFilePicker({
   suggestedName:file.value,
   types:[{accept:{'text/plain':['.k']}}]})
  let f=await h.getFile()
  currentfile.h=h;currentfile.name=f.name;file.value=f.name
  const w=await currentfile.h.createWritable()
  await w.write(edt.value)
  await w.close();
}}
file.onchange=e=>{currentfile={name:"",h:null}}    //invalidate direct save

//click on dir to preload all files (k has synchronous access to them and writes to this dir)
let kfs={}
dir.onclick=async e=>{kfs={},dir.h=null
 const dh=await window.showDirectoryPicker({mode:'readwrite'})
 dir.h=dh
 for await(const x of dh.values()){
  if(x.kind==="file"){
   x.getFile().then((f)=>{
    f.arrayBuffer().then(b=>{kfs[f.name]=new Uint8Array(b)})
})}}}

let writefile=async(name,u)=>{                     //write file to disk from k (async)
 if(("h"in dir)&&(dir.h!==null)){
  const h=await dir.h.getFileHandle(name,{create:true})
  const w=await h.createWritable()
  await w.write(u)
  await w.close();
}}

//click on share button
share.onclick=async e=>{await navigator.share({title:"share k file",text:edt.value})}

let showcnv=t=>{
 cnv.classList[["add","remove"][+t]]("invisible")
 out.classList[["remove","add"][+t]]("invisible")
}
let cnvsize=()=>{showcnv(true);let r=[cnv.clientHeight,cnv.clientWidth];showcnv(false);return r}
let cnvimage=u=>{showcnv(true);cnv.width=cnv.clientHeight;cnv.height=cnv.clientWidth;
 let c=cnv.getContext("2d");
 let d=c.createImageData(cnv.width,cnv.height)
 let m=new Uint8Array(d.data.buffer)
 for(let i=3;i<u.length;i+=4)u[i]=255; //no-alpha
 m.set(u)
 c.putImageData(d,0,0)
}

let plot=p=>{showcnv(true);plotjs.plots(p,cnv)}
</script>

</body></html>
