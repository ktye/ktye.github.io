<!DOCTYPE html><head><meta charset="utf-8"><link rel=icon href="../kelas16.png"><title>new</title><style>
/*body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;background:#f0f0f0;}*/
*{font-family:monospace;font-size:24px}
canvas{background:grey}
textarea{width:100%}
</style></head><body>

<select id="chs" onchange="(ch=this.value,draw(0))"></select><br/>
<canvas id="cnv" width="800" height="450"></canvas><br/>
<input type="text" id="re"></input>
<button onclick="add()">add</button>
<hr/>
<textarea rows="12" id="out"></textarea>

<script>
let ctx=cnv.getContext("2d");
let ch=location.hash.slice(1)?location.hash.slice(1):"linatina"
let im

if(ch!=""){im="m/"+ch+".webp";let img=new Image();img.onload=_=>{im=img;draw(0)};img.src=im;document.title=ch;
}else alert("missing hash");



let X=0,Y=0;
cnv.onmousedown=e=>{X=e.offsetX;Y=e.offsetY;}
cnv.onmouseup=e=>{let x=e.offsetX;y=e.offsetY;console.log("up",X,Y); if(x-X>10&&y-Y>10){addrect(X,Y,x,y);add()} }
let addrect=(x,y,xx,yy)=>{let w=xx-x,h=yy-y;re.value=[x,y,xx,yy].join(" "); };

let add=_=>{ let r=re.value.split(" "); clip(ch+"|"+r.join(",")+"|"); out.value+=ch+"|"+r+"|\n"; drawrect(r,out.value.split("\n").length-1) }

let uniq=x=>x.filter((x,i,a)=>a.indexOf(x)==i)
let draw=q=>{
 fetch("story").then(r=>r.text()).then(r=>{ 
	let all=uniq(r.split("\n").map(x=>x.split("|")[0]))
	if(chs.innerHTML=="")chs.innerHTML=all.map(x=>`<option>${x}</option>`).join("");
	chs.value=ch;
	let u=all.filter(x=>r.indexOf(">"+x)<0);
	console.log("unreach:",u.join(" "));
 	im=new Image();im.onload=_=>{
		ctx.drawImage(im,0,0); 
		let a=r.split("\n").filter(x=>x.startsWith(ch+"|"))
		out.textContent=a.join("\n")+"\n"
		a.forEach((v,i)=>{
			let r=v.split("|");
			drawrect(r[1].split(","),i)
		})
	}
	im.src="m/"+ch+".webp"
 })
}
let drawrect=(r,i)=>{
	let[x,y,xx,yy]=r.map(Number);
	ctx.strokeWidth=2;
	ctx.strokeStyle="green";ctx.strokeRect(x-0.5,y-0.5,xx-x,yy-y)
	ctx.strokeStyle="white";ctx.strokeRect(x-4.5,y-4.5,8+xx-x,8+yy-y)
	ctx.fillStyle="white"
	ctx.fillRect(x,y,40,30)
	ctx.fillStyle="black"
	ctx.font="20px monospace";ctx.fillText(i,x+5,y+25)
}

let clip=t=>navigator.clipboard.writeText(t);

</script></body></html>
