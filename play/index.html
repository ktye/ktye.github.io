<!DOCTYPE html><head><meta charset="utf-8"><link rel=icon href="../kelas16.png"><title>play</title><style>
body{margin:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:space-around}
img{width:min(100vw,16 / 9 * 100vh)}
*{font-family:monospace;font-size:24px}
#txt{background:#ffffff;padding:20px;font-size:30px;position:absolute;display:none;font-weight:bold;border:2px solid yellow}
</style></head><body>

<img id="img" usemap="#map">
<map id="map" name="map"></map>
<pre id="txt"></pre>

<script>

let ch
let showpage=_=>{ // >(img) *(audio) @(full-link) else(text) 
 fetch("story").then(r=>r.text()).then(r=>{
  ch=document.location.hash.slice(1);ch=ch?ch.split(":")[0]:"linatina";
  document.title=ch;
  txt.style.display="none"
  img.src="m/"+ch+".webp";
  img.href="#"+ch;
  let p=""
  img.onload=_=>{let sc=x=>(Math.floor(x*img.width/800))
   r.split("\n").filter(x=>x.startsWith(ch+"|")).map(x=>x.split("|")).forEach(x=>{let a=x[2];
    
    let h=a.startsWith("@")?a.slice(1):a.startsWith(">")?"#"+a.slice(1):"#"+ch+(a?":"+encodeURIComponent(a):"")
    p+=`<area shape="rect" coords="${x[1].split(",").map(x=>sc(+x))}" href="${h}" />`
   })
   p+=`<area shape="default" href="#${ch}">`
   map.innerHTML=p;
   }})}

let showtext=t=>{if(t=="fullscreen"){t="";document.body.requestFullscreen()}
	if(!t)return txt.onclick();txt.style.display="block"; 
 txt.textContent=t.replaceAll("/","\n");
 let h=txt.innerHTML,i=0,r="";
 while(i=h.indexOf("("),i>=0){
	 r+=h.slice(0,i)
	 h=h.slice(1+i)
	 i=h.indexOf("&gt;")
	 let a=h.slice(0,i)
	 h=h.slice(4+i)
	 i=h.indexOf(")")
	 let href="#"+h.slice(0,i)
	 r+=`<a href="${href}">${a}</a>`
	 h=h.slice(1+i)
 }
 r+=h
 txt.innerHTML=r
 if(Math.random()>0.97)window.location.href="calc.html"
 //txt.innerHTML="";t=t.split("/").forEach(t=>{let s=document.createElement("span");s.textContent=t;txt.appendChild(s)})
}
txt.onclick=()=> txt.style.display="none"

let au;var snd=[]
let play=x=>{if(typeof au=='undefined')au=new AudioContext();
 let p=b=>{let s=au.createBufferSource();s.buffer=b;s.connect(au.destination);s.start()}
 fetch("a/"+x+".m4a").then(r=>r.arrayBuffer()).then(a=>au.decodeAudioData(a)).then(b=>p(b))}

window.onhashchange=e=>{
 let x=decodeURIComponent(new URL(e.newURL).hash).slice(1);
 let c=x.split(":")[0],s=x.slice(1+c.length)
 ch!=c?(ch=c,showpage()):s.startsWith("*")?play(s.slice(1)):showtext(s)
}
showpage()

/*
let xt=0,yt=0
let xytouch=(e, r)=>(r=img.getBoundingClientRect(),[e.touches[0].clientX-window.pageXOffset-r.left,e.touches[0].clientY-window.pageYOffset-r.top]);
img.ontouchstart=e=>{xt=0,yt=0;if(1==e.touches.length){[xt,yt]=xytouch(e)}}
img.ontouchend=e=>{if(1==e.touches.length){
		let[x,y]=xytouch(e);x-=xt;y-=yt;
		if((Math.abs(xt-x)<20)&&Math.abs(yt-x)<20){
			//?
		}
	}
	xt=0;yt=0
}
*/
</script></body></html>
