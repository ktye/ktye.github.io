NB. Copyright (c) 1989 1990, Roger K.W. Hui & K.E. Iverson
NB. Copyright (c) 1990-1992, Iverson Software Inc.
NB. All Rights Reserved.


NB. f/. f\  f\. models --------------------------------------------------

id     =. [.+

en     =. #@]
em     =. (en >.@% 1&>.@|@[)`(en 0&>.@>:@- [) @. (0&<:@[)
kay    =. en`em @. (0&<@[)
omask  =. (em,en) $ ($&0@|@[ , $&1@kay)

base   =. 1&>.@-@[ * i.@em
iind   =. base ,. |@[ <. en - base
seg    =. ((+i.)/@[ { ])"1 _

infix  =. (@seg) (iind `) (`]) \ ("0 _)
outfix =. (@#  ) (omask`) (`]) \ ("0 _)
prefix =. (@{.) (>:@,.@i.@#`) (`]) \
suffix =. (@}.) (   ,.@i.@#`) (`]) \

key    =. (@#) (=@[`) (`]) \

osub   =. >@]`(>@[ >@:{ ]) @. (*@#@])
oind   =. (+/&i./ </.&, i.)@(2&{.)@(,&1 1)@$
ob     =. (@(osub"0 1)) (oind`) (`(,@(<"_2))) \

bs     =. id (prefix : infix )
bsd    =. id (suffix : outfix)
sd     =. id (ob     : key   )


NB. f\y -----------------------------------------------------------------

NB. Boolean
a=.1=?10 5$2
(<\ -: < bs) a
(<\ -: < bs) ,a
(]\ -: ] bs) a
(+./\ -: +./ bs) a

NB. literal
a=.a.{~32+?10 5$95
(<\a)   -: < bs a
(<\,a)  -: < bs ,a
(]\a)  -: ] bs a

NB. integer
a=.?10 5$100
(<\ -: < bs) a
(<\ -: < bs) ,a
(]\ -: ] bs) a
(+/\ -: +/ bs) a

NB. floating point
a=.o._4e6+?10 5$1e7
(<\ -: < bs) a
(<\ -: < bs) ,a
(]\ -: ] bs) a
(+/\ -: +/ bs) a

NB. complex
a=.^0j0.01*_400+?10 5$1000
(<\ -: < bs) a
(<\ -: < bs) ,a
(]\ -: ] bs) a
(+/\ -: +/ bs) a

NB. boxed
t=.(1=?70$3)<;.1 ?70$100
a=.t{~?10 3$#t
(<\ -: < bs) a
(<\ -: < bs) ,a
(]\ -: ] bs) a

'' -: <\ i.0
'' -: <\ i.0 2 3 4


NB. f/\y ----------------------------------------------------------------

(= /\ -: = / bs) ?20$2
(< /\ -: < / bs) ?20$2
(<./\ -: <./ bs) ?20$2
(<:/\ -: <:/ bs) ?20$2
(> /\ -: > / bs) ?20$2
(>./\ -: >./ bs) ?20$2
(>:/\ -: >:/ bs) ?20$2
(+ /\ -: + / bs) ?20$2
(+./\ -: +./ bs) ?20$2
(+:/\ -: +:/ bs) ?20$2
(* /\ -: * / bs) ?20$2
(*./\ -: *./ bs) ?20$2
(*:/\ -: *:/ bs) ?20$2
(- /\ -: - / bs) ?20$2
(% /\ -: % / bs) ?20$2
(^ /\ -: ^ / bs) ?20$2
(~:/\ -: ~:/ bs) ?20$2
(| /\ -: | / bs) ?20$2
(! /\ -: ! / bs) ?20$2

*./(= /\ -: = / bs)"1 #:i.32
*./(< /\ -: < / bs)"1 #:i.32
*./(<./\ -: <./ bs)"1 #:i.32
*./(<:/\ -: <:/ bs)"1 #:i.32
*./(> /\ -: > / bs)"1 #:i.32
*./(>./\ -: >./ bs)"1 #:i.32
*./(>:/\ -: >:/ bs)"1 #:i.32
*./(+ /\ -: + / bs)"1 #:i.32
*./(+./\ -: +./ bs)"1 #:i.32
*./(+:/\ -: +:/ bs)"1 #:i.32
*./(* /\ -: * / bs)"1 #:i.32
*./(*./\ -: *./ bs)"1 #:i.32
*./(*:/\ -: *:/ bs)"1 #:i.32
*./(- /\ -: - / bs)"1 #:i.32
*./(% /\ -: % / bs)"1 #:i.32
*./(^ /\ -: ^ / bs)"1 #:i.32
*./(~:/\ -: ~:/ bs)"1 #:i.32
*./(| /\ -: | / bs)"1 #:i.32
*./(! /\ -: ! / bs)"1 #:i.32

*./(= /\ -: = / bs) |:#:i.32
*./(< /\ -: < / bs) |:#:i.32
*./(<./\ -: <./ bs) |:#:i.32
*./(<:/\ -: <:/ bs) |:#:i.32
*./(> /\ -: > / bs) |:#:i.32
*./(>./\ -: >./ bs) |:#:i.32
*./(>:/\ -: >:/ bs) |:#:i.32
*./(+ /\ -: + / bs) |:#:i.32
*./(+./\ -: +./ bs) |:#:i.32
*./(+:/\ -: +:/ bs) |:#:i.32
*./(* /\ -: * / bs) |:#:i.32
*./(*./\ -: *./ bs) |:#:i.32
*./(*:/\ -: *:/ bs) |:#:i.32
*./(- /\ -: - / bs) |:#:i.32
*./(% /\ -: % / bs) |:#:i.32
*./(^ /\ -: ^ / bs) |:#:i.32
*./(~:/\ -: ~:/ bs) |:#:i.32
*./(| /\ -: | / bs) |:#:i.32
*./(! /\ -: ! / bs) |:#:i.32

(i.1+n) -: 0,+/\n$1 [ n=.?1000
(n$1)   -: +/\n{.1  [ n=.?1000

(-/\b)  -: +/\b*($b)$1 _1 [ b=.?1000$2
(-/\b)  -: ($b)$1 0       [ b=.2000$1

f =. # ($&0 1@] , - $ 2&|@>:@]) i.&1
*./(f -: >:/\)"1 #:i.32

f =. # ($&1 0@] , - $ 2&|   @]) i.&0
*./(f -: > /\)"1 #:i.32

(<./\ -: <./bs) 5e5-~20$1e6
(>./\ -: >./bs) 5e5-~?20$1e6
(+ /\ -: + /bs) 5e5-~?20$1e6
(* /\ -: * /bs) 5e5-~?20$1e6
(- /\ -: - /bs) 5e5-~?20$1e6
(% /\ -: % /bs) 5e5-~?20$1e6

(<./\ -: <./bs) 5e5-~?10 17$1e6
(>./\ -: >./bs) 5e5-~?10 17$1e6
(+ /\ -: + /bs) 5e5-~?10 17$1e6
(* /\ -: * /bs) 5e5-~?10 17$1e6
(- /\ -: - /bs) 5e5-~?10 17$1e6
(% /\ -: % /bs) 5e5-~?10 17$1e6

(<./\ -: <./bs) o.5e5-~?20$1e6
(>./\ -: >./bs) o.5e5-~?20$1e6
(+ /\ -: + /bs) o.5e5-~?20$1e6
(* /\ -: * /bs) o.5e5-~?20$1e6
(- /\ -: - /bs) o.5e5-~?20$1e6
(% /\ -: % /bs) o.5e5-~?20$1e6

(<./\ -: <./bs) o.5e5-~?10 17$1e6
(>./\ -: >./bs) o.5e5-~?10 17$1e6
(+ /\ -: + /bs) o.5e5-~?10 17$1e6
(* /\ -: * /bs) o.5e5-~?10 17$1e6
(- /\ -: - /bs) o.5e5-~?10 17$1e6
(% /\ -: % /bs) o.5e5-~?10 17$1e6

(+ /\ -: + /bs) j./?2 20$1e6
(* /\ -: * /bs) j./?2 20$1e6
(- /\ -: - /bs) j./?2 20$1e6
(% /\ -: % /bs) j./?2 20$1e6

(+ /\ -: + /bs) r.?10 17$1e6
(* /\ -: * /bs) r.?10 17$1e6
(- /\ -: - /bs) r.?10 17$1e6
(% /\ -: % /bs) r.?10 17$1e6


NB. inverses of scans ---------------------------------------------------

inv=.^:_1

w -:  +/\  inv  +/\  w=._20+?20 3$50
w -:  -/\  inv  -/\  w=._20+?30 3$50
w -:  */\  inv  */\  w=.w+0=w=.0.5*_20+?25 4$50
w -:  %/\  inv  %/\  w=.w+0=w=.0.5*_20+?25 4$50
w -:  =/\  inv  =/\  w=.1=?40 2$3
w -: ~:/\  inv ~:/\  w=.1=?40 2$3

w -:  +/\. inv  +/\. w=._20+?20 3$50
w -:  -/\. inv  -/\. w=._20+?30 3$50
w -:  */\. inv  */\. w=.w+0=w=.0.5*_20+?25 4$50
w -:  %/\. inv  %/\. w=.w+0=w=.0.5*_20+?25 4$50
w -:  =/\. inv  =/\. w=.1=?40 2$3
w -: ~:/\. inv ~:/\. w=.1=?40 2$3


NB. x f\y ---------------------------------------------------------------

NB. Boolean
a=.1=?11 5$2
k (<\   -: < bs) a   [ k=._4+?11
k (<\   -: < bs) ,a  [ k=._4+?11
k (]\   -: ] bs) a   [ k=._4+?11
k (+./\ -: +./ bs) a [ k=._4+?11
k (<\   -: < bs) a   [ k=.0
k (<\   -: < bs) a   [ k=.1+#a
a=.1
k (<\   -: < bs) a   [ k=.0
k (<\   -: < bs) a   [ k=.4

NB. literal
a=.a.{~32+?11 5$95
k (<\ -: < bs) a     [ k=._4+?11
k (<\ -: < bs) ,a    [ k=._4+?11
k (]\ -: ] bs) a     [ k=._4+?11
k (<\ -: < bs) a     [ k=.0
k (<\ -: < bs) a     [ k=.1+#a
a=.'d'
k (<\ -: < bs) a     [ k=.0
k (<\ -: < bs) a     [ k=.4

NB. integer
a=.?11 5$110
k (<\  -: < bs) a    [ k=._4+?11
k (<\  -: < bs) ,a   [ k=._4+?11
k (]\  -: ] bs) a    [ k=._4+?11
k (+/\ -: +/ bs) a   [ k=._4+?11
k (<\  -: < bs) a    [ k=.0
k (<\  -: < bs) a    [ k=.1+#a
a=.12
k (<\  -: < bs) a    [ k=.0
k (<\  -: < bs) a    [ k=.4

NB. floating point
a=.o._40+?11 5$110
k (<\  -: < bs) a    [ k=._4+?11
k (<\  -: < bs) ,a   [ k=._4+?11
k (]\  -: ] bs) a    [ k=._4+?11
k (+/\ -: +/ bs) a   [ k=._4+?11
k (<\  -: < bs) a    [ k=.0
k (<\  -: < bs) a    [ k=.1+#a
a=.2.71828
k (<\  -: < bs) a    [ k=.0
k (<\  -: < bs) a    [ k=.4

NB. complex
a=.^0j0.01*_400+?11 5$1100
k (<\  -: < bs) a    [ k=._4+?11
k (<\  -: < bs) ,a   [ k=._4+?11
k (]\  -: ] bs) a    [ k=._4+?11
k (+/\ -: +/ bs) a   [ k=._4+?11
k (<\  -: < bs) a    [ k=.0
k (<\  -: < bs) a    [ k=.1+#a
a=.3j4
k (<\  -: < bs) a    [ k=.0
k (<\  -: < bs) a    [ k=.4

NB. boxed
t=.(1=?70$3)<;.1 ?70$110
a=.t{~?11 3$#t
k (<\ -: < bs) a     [ k=._4+?11
k (<\ -: < bs) ,a    [ k=._4+?11
k (]\ -: ] bs) a     [ k=._4+?11
k (<\ -: < bs) a     [ k=.0
k (<\ -: < bs) a     [ k=.1+#a
a=.<'Ivanhoe'
k (<\ -: < bs) a     [ k=.0
k (<\ -: < bs) a     [ k=.4
