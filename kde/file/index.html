<!DOCTYPE html>
<head><meta charset="utf-8"><title>kde/file</title>
<link rel=icon href="../../k.png">
<style>
 body{font-family:georgia,serif}
 h2{border-top:1px solid black}
 th{font-family:monospace}
 pre{margin-left:1em}
 .lnk{color:blue}
 .lnk:hover{text-decoration:underline}
 
</style>
</head>

<body onload="init()">
<a id="dl" style="display:none"></a>

<h1>kde/file</h1>
<h2></h2>
<pre>
   ki
  jsam
 cssall
htmlfive
</pre>

<p>kde/file is a single-file application &ldquo;file.html&rdquo; that runs from a file-url,
e.g. <code>file:///path/to/file.html</code> (or open by double-click).<br>
As such it has does not need an http server or network connection.</p>
<p>Bundled with the single-file-application there is a development environment (edit/repl/debug)
combined with the application payload (html/css/js/k) and the runtime k.wasm.</p>
<p>At start the application runs without showing the ide. In case of a trap, it switches to the debugger.<br>
The error can be corrected in the editor and a new application bundle is rewritten and downloaded.</p>

<p>it's a self-modifying single-file application</p>

<h2>examples</h2>
<p>examples are generated by <i>this</i> file (index.html)</p>

<p>click open to execute it on the fly, or download and open it from a file url</p>
<p>
<table id="tab">
</table></p>



<script>


function ge(x){return document.getElementById(x)}
function ce(x){return document.createElement(x)}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}}
function rm(p){while(p.firstChild)p.removeChild(p.firstChild);return p}
function xu(u){return [...new Uint8Array(u)].map(x=>x.toString(16).padStart(2,'0')).join('')}
const te_=new TextEncoder("utf-8"),us=x=>te_.encode(x)
const td_=new TextDecoder("utf-8"),su=x=>td_.decode(x)


function fetchall(l,f){let x=[],F={}
 l.forEach(function(u,i){x.push(fetch(u).then(r=>r.arrayBuffer()).then(r=>F[l[i]]=r))})
 Promise.all(x).then(function(){f(F)})
}


function build(F,id,desc){let f //build example application (fill file.h template)
 let re=function(s,x,y){let i=s.indexOf(x);if((i<0)||(y.length==0))throw("replace "+x);return s.slice(0,i)+y+s.slice(i+x.length)}
 f=su(F["file.h"])
 f=re(f,"{{title}}"    ,id)
 f=re(f,"{{k}}"        ,su(F[id+".k"]))
 f=re(f,"{{js}}"       ,su(F[id+".js"]))
 f=re(f,"{{css}}"      ,su(F[id+".css"]))
 f=re(f,"{{html}}"     ,su(F[id+".html"]))
 f=re(f,"{{kde.js}}"   ,su(F["../kde.js"]))
 f=re(f,"{{z.k}}"      ,JSON.stringify(F["../z.k"]))
 f=re(f,"{{src.map}}"  ,su(F["../../src.map"]))
 f=re(f,"{{kwork.js}}" ,su(F["../kwork.js"]))
 f=re(f,"{{d.hx.wasm}}",xu(F["../../d.wasm"]))
 
 let cmdir="../../codemirror/"
 f=re(f,"{{k.mode.css}}"        ,su(F["../k.mode.css"]))
 f=re(f,"{{codemirror.min.css}}",su(F[cmdir+"/codemirror.min.css"]))
 f=re(f,"{{foldgutter.css}}"    ,su(F[cmdir+"/foldgutter.css"]))
 f=re(f,"{{show-hint.css}}"     ,su(F[cmdir+"/show-hint.css"]))
 
 f=re(f,"{{jquery.min.js}}"     ,su(F[cmdir+"/jquery.min.js"]))
 f=re(f,"{{codemirror.min.js}}" ,su(F[cmdir+"/codemirror.min.js"]))
 f=re(f,"{{matchbrackets.js}}"  ,su(F[cmdir+"/matchbrackets.js"]))
 f=re(f,"{{foldcode.js}}"       ,su(F[cmdir+"/foldcode.js"]))
 f=re(f,"{{foldgutter.js}}"     ,su(F[cmdir+"/foldgutter.js"]))
 f=re(f,"{{brace-fold.js}}"     ,su(F[cmdir+"/brace-fold.js"]))
 f=re(f,"{{fullscreen.js}}"     ,su(F[cmdir+"/fullscreen.js"]))
 f=re(f,"{{show-hint.js}}"      ,su(F[cmdir+"/show-hint.js"]))
 f=re(f,"{{k.mode.js}}"         ,su(F["../k.mode.js"]))
 f=re(f,"{{plot.js}}"           ,su(F["../plot.js"]))
 
 let r=ce("tr")
 let a=ce("th");a.textContent=id
 let b=ce("td");b.textContent="open";b.classList.add("lnk")
 let c=ce("td");c.textContent="download";c.classList.add("lnk")
 let d=ce("td");d.textContent=desc
 b.onclick=function(e){let w=open("", "_blank");w.document.open();w.document.write(f);w.document.close()}
 c.onclick=function(e){download(us(f),id+".html")}
 r.appendChild(a);r.appendChild(b);r.appendChild(c);r.appendChild(d);ge("tab").appendChild(r)
}

function init(){
 let desc={empty:"skeleton"}
 let examples=Object.keys(desc)
 //for(let i=0,row;row=ge("tab").rows[i];i++)examples.push(row.cells[0].textContent.slice(0,-5))
 

 let allfiles=["file.h","../kwork.js","../z.k","../kde.js","../../src.map","../../d.wasm"]
 let cmdir="../../codemirror/"
 allfiles.push(...["../k.mode.css",cmdir+"/codemirror.min.css",cmdir+"/foldgutter.css",cmdir+"/show-hint.css"])
 allfiles.push(...[cmdir+"/jquery.min.js",cmdir+"/codemirror.min.js",cmdir+"/matchbrackets.js",cmdir+"/foldcode.js",cmdir+"/foldgutter.js",cmdir+"/brace-fold.js",cmdir+"/fullscreen.js",cmdir+"/show-hint.js","../k.mode.js","../plot.js"])
 
 let extensions=["k","js","css","html"]
 for(let i=0;i<examples.length;i++)for(let j=0;j<4;j++)allfiles.push(examples[i]+"."+extensions[j])
 fetchall(allfiles,function(F){for(let i=0;i<examples.length;i++)build(F,examples[i],desc[examples[i]])})
}

function download(u,name){
 var dl=ge("dl");var b=new Blob([u],{type:"application/octet-stream"})
 dl.href=URL.createObjectURL(b);dl.download=name;dl.click()
}

</script>
</body>
