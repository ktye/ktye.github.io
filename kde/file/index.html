<!DOCTYPE html>
<head><meta charset="utf-8"><title>kde/file</title>
<link rel=icon href="../../k.png">
<style>
 body{font-family:georgia,serif}
 h2{border-top:1px solid black}
 th{font-family:monospace}
 pre{margin-left:1em}
 .lnk{color:blue}
 .lnk:hover{text-decoration:underline}
 
</style>
</head>

<body onload="init()">
<a id="dl" style="display:none"></a>

<h1>kde/file</h1>
<h2></h2>
<pre>
   ki
  jsam
 cssall
htmlfive
</pre>

<p>kde/file is a single-file application &ldquo;file.html&rdquo; that runs from a file-url,
e.g. <code>file:///path/to/file.html</code> (or open by double-click).<br>
As such it has does not need an http server or network connection.</p>
<p>Bundled with the single-file-application there is a development environment (edit/repl/debug)
combined with the application payload (html/css/js/k) and the runtime k.wasm.</p>
<p>At start the application runs without showing the ide. In case of a trap, it switches to the debugger.<br>
The error can be corrected in the editor and a new application bundle is rewritten and may be downloaded.</p>

<p>The application can also store data in it's filesystem (e.g. computed or dropped files), together with program and runtime.</p>

<p>it's a self-modifying single-file application</p>

<h2>examples</h2>
<p>examples are generated by <i>this</i> file (index.html)</p>

<p>click open to execute it on the fly, or download and open it from a file url</p>
<p>cntrl-k toggles between kde and the application.</p>
<p>
<table id="tab">
</table></p>


<script src="compress.js"></script>
<script>



function ge(x){return document.getElementById(x)}
function ce(x){return document.createElement(x)}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}}
function rm(p){while(p.firstChild)p.removeChild(p.firstChild);return p}
function s64u(u){let c=function(x){let r='';for(let i=0;i<x.length;i++)r+=String.fromCharCode(x[i]);return r};return btoa(c(u))}
function zu(u){return s64u(compress(new Uint8Array(u)))}
const te_=new TextEncoder("utf-8"),us=x=>te_.encode(x)
const td_=new TextDecoder("utf-8"),su=x=>td_.decode(x)


function fetchall(l,f){let x=[],F={}
 l.forEach(function(u,i){x.push(fetch(u).then(r=>r.arrayBuffer()).then(r=>F[l[i]]=r))})
 Promise.all(x).then(function(){f(F)})
}

function build(F,id,desc){let f //build example application (fill file.h template)
 let re=function(s,x,y){let i=s.indexOf(x);if((i<0)||(y.length==0))throw("replace "+x);return s.slice(0,i)+y+s.slice(i+x.length)}
 f=su(F["file.h"])
 f=re(f,"{{title}}"    ,id)
 f=re(f,"{{fs}}", JSON.stringify(kdesplit(su(F[id+".kde"]))))
 f=re(f,"{{kde.js}}"  ,su(F["../kde.js"]))
 f=re(f,"{{z.k}}"     ,JSON.stringify(su(F["../z.k"])))
 f=re(f,"{{src.map}}" ,su(F["../../src.map"]))
 f=re(f,"{{kwork.js}}",su(F["../kwork.js"]))
 f=re(f,"{{d.wasm.z}}",zu(F["../../d.wasm"]))
 //f=re(f,"{{plot.js}}" ,su(F["../plot.js"]))
 f=re(f,"{{compress.js}}",su(F["compress.js"]))
 f=re(f,"{{uncompress.js}}",su(F["uncompress.js"]))
 
 let r=ce("tr")
 let a=ce("th");a.textContent=id
 let b=ce("td");b.textContent="open"    ;b.classList.add("lnk")
 let c=ce("td");c.textContent="download";c.classList.add("lnk")
 let d=ce("td");d.textContent=desc
 b.onclick=function(e){let w=open("", "_blank");w.document.open();w.document.write(f);w.document.close()}
 c.onclick=function(e){download(us(f),id+".html")}
 r.appendChild(a);r.appendChild(b);r.appendChild(c);r.appendChild(d);ge("tab").appendChild(r)
}

function init(){
 let desc={simple:"basic example",error:"debug errors",sing:"audio spectrogram",fs:"in-app file system"}
 let examples=Object.keys(desc)
 //for(let i=0,row;row=ge("tab").rows[i];i++)examples.push(row.cells[0].textContent.slice(0,-5))
 

 let allfiles=["file.h","../kwork.js","../z.k","../kde.js","../../src.map","../../d.wasm","../plot.js","compress.js","uncompress.js"]
 let extensions=["k","js","css","html"]
 for(let i=0;i<examples.length;i++)allfiles.push(examples[i]+".kde") //for(let j=0;j<4;j++)allfiles.push(examples[i]+"."+extensions[j])
 fetchall(allfiles,function(F){for(let i=0;i<examples.length;i++)build(F,examples[i],desc[examples[i]])})
}

function download(u,name){
 var dl=ge("dl");var b=new Blob([u],{type:"application/octet-stream"})
 dl.href=URL.createObjectURL(b);dl.download=name;dl.click()
}

function kdesplit(s){
 let fs={},v=s.split("\n");let f="";fs[f]=[]
 for(let i=0;i<v.length;i++){let l=v[i]
  if((l.length>6)&&l.startsWith("///")&&l.endsWith("///")){f=l.slice(3,l.length-3);fs[f]=[]}
  else fs[f].push(l)
 };delete fs[""];
 let k=Object.keys(fs);for(let i=0;i<k.length;i++)fs[k[i]]=fs[k[i]].join("\n")
 return fs
}
</script>
</body>
