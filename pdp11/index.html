<!DOCTYPE html>
<head><meta charset="utf-8">
<!--link rel="icon" type="image/png" sizes="32x32" href="../db/kelas32.png"-->
<!--link rel="icon" type="image/png" sizes="16x16" href="../db/kelas16.png"-->
<!--title>pdp11</title-->
<title>pd</title>
<style>
body{margin:0}
* {font-family:monospace;box-sizing:border-box}
.b{font-weight:bold}
#terminal{font-family:monospace;width:100%;height:10cm;/*background:#920e5a;color:white*/;outline:none;resize:none}
#debug{font-family: monospace;width:100%;height:5cm;background:/*#ce082c;color:white*/;outline:none;resize:none}
#lights{border:2px solid black;border-radius:10px;display:flex;justify-content:center}
legend{text-align:center}
button{flex-grow:1;background:#333;color:white;height:2em}button:disabled{background:#888}
</style>
<!--
<script src="k.js" type="text/javascript"></script>
<script src="cons.js" type="text/javascript"></script>
-->
<script src="pdp11.js" type="text/javascript"></script>
<script src="disas.js" type="text/javascript"></script>
<script>

let ge=x=>document.getElementById(x)
let ce=x=>document.createElement(x)
let ctx,bold=null
let lights=()=>{let cnv=ge("cnv")
 ctx=cnv.getContext("2d")
 ctx.clearRect(0,0,cnv.width,cnv.height)
 ctx.fillStyle="#ce082c";ctx.fillRect(5,0,455,10)
 ctx.fillStyle="#920e5a";ctx.fillRect(40,0,85,10);ctx.fillRect(210,0,85,10);ctx.fillRect(375,0,85,10)
 ctx.font="16px monospace";ctx.fillStyle="black";ctx.fillText("A",460,32);ctx.fillText("I",460,58)
 blink(0,0);blink(0,1)
}
let blink=(u,y)=>{let x=470;y*=25
 for(let i=0;i<16;i++){x-=25;ctx.beginPath()
  ctx.fillStyle=["#ccc",["#920e5a","#ce082c"][Math.floor(i/3)%2]][+(!!(u&(1<<i)))]
  ctx.arc(x, y+25, 10, 0, 2*Math.PI)
  ctx.fill();if(!((1+i)%3))x-=10
}}
let show=x=>{blink(x,0);blink(M[x>>1],1);
 let b=ge(x.toString(8));if(!x){trap((x==0)?"halt":"addr? "+Oct(x));return}
 if(bold)bold.classList.remove("b");bold=b
 let o=x=>{let r=x.toString(8);return"000000".slice(0,6-r.length)+r}
 let t=bold.textContent,s=Array.from(M.slice(0,4)).map(o).join(" ")+"]["+Array.from(M.slice(4,8)).map(o).join(" ")
 bold.textContent=t.slice(0,16)+s+t.slice(72)
 bold.classList.add("b")
}
let stack=()=>{let d=ge("debug"),o=x=>d.textContent+=x,sp=M[6]
 if(sp==011776)     {o("empty stack")    ;return}
 if(sp >011776)     {o("stack underflow");return}
 if(sp <011774-1000){o("stack overflow") ;return}
 for(let i=sp;i<01774;i+=2)o(Oct(i)+" "+Oct(M[i>>1]))+((sp==i)?" <- sp":"")
}
let trap=x=>{blink(0177777,1);ge("stepbut").disabled=true ;ge("runbut").disabled=true;ge("debug").textContent=x+"\n";wait=true;stack()}
let reset=()=>{lights()      ;ge("stepbut").disabled=false;ge("runbut").disabled=false;wait=false
 ge("debug").textContent=""
 let h=document.location.hash.slice(1),asm=ge("asm")
 asm.textContent=" addr    inst     r0     r1     r2     r3      r4     r5     sp     pc\n"
 fetch((h.length?h:"x.out")).then(r=>r.text()).then(r=>{
  rst(eval("["+r+"]"));disasm((x,y)=>{let t=ce("span");t.textContent=x;t.id=y;asm.appendChild(t)})
 })
}
 
</script>
</head>
<body onload="reset()">
 <div id="lights" >
  <canvas id="cnv" width="470" height="65"></canvas>
 </div>
 <span id="ips"> </span>
 <textarea id="terminal" readonly="readonly" onkeypress="addchar(event.which)" onkeyup="specialchar(event.which)"> </textarea>
  <div style="display:flex">
  <button id="resetbut" onclick="reset()">reset</button>
  <button id="stepbut"  onclick="step()">step</button>
  <button id="runbut"   onclick="run()">run</button>
  <button id="stopbut"  onclick="stop()" disabled>stop</button>
 </div>
 <textarea id="debug" readonly="readonly"> </textarea>
 <pre id="asm"></pre>
</body>
</html>
