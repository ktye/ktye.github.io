<!DOCTYPE html>
<head><meta charset="utf-8">
<!--link rel="icon" type="image/png" sizes="16x16" href="../kelas16.png"-->
<!--title>pdp11</title-->
<title>pd</title>
<style>
body{margin:0;height:100vh;display:flex;flex-flow:column;overflow:hidden}
* {font-family:monospace;box-sizing:border-box}
.b{font-weight:bold}
.l{color:blue}.l:hover{cursor:pointer}
.brk{border-left:1ch solid black}
#tty{font-family:monospace;width:100%;height:7em;/*background:#920e5a;color:white;*/outline:none;resize:none}
#stk{font-family: monospace;width:100%;height:7em;/*background:#ce082c;color:white;*/outline:none;overflow:auto}
#asm{overflow:auto}
#lights{border:2px solid black;border-radius:10px;display:flex;justify-content:center}
legend{text-align:center}
button{flex-grow:1;background:#333;color:white;height:2em}button:disabled{background:#888}
</style>
<!--
<script src="k.js" type="text/javascript"></script>
<script src="cons.js" type="text/javascript"></script>
-->
<script src="pdp11.js" type="text/javascript"></script>
<script src="disas.js" type="text/javascript"></script>
<script src="tests.js" type="text/javascript"></script>
<script>

let ge=x=>document.getElementById(x)
let ce=x=>document.createElement(x)
let rm=x=>{while(x.firstChild)x.removeChild(x.firstChild)}
let ctx,bold=null,prg="k"
let lights=()=>{let cnv=ge("cnv")
 ctx=cnv.getContext("2d")
 ctx.clearRect(0,0,cnv.width,cnv.height)
 ctx.fillStyle="#ce082c";ctx.fillRect(5,0,455,10)
 ctx.fillStyle="#920e5a";ctx.fillRect(40,0,85,10);ctx.fillRect(210,0,85,10);ctx.fillRect(375,0,85,10)
 ctx.font="16px monospace";ctx.fillStyle="black";ctx.fillText("A",460,32);ctx.fillText("I",460,58)
 blink(0,0);blink(0,1)
}
let blink=(u,y)=>{let x=470;y*=25
 for(let i=0;i<16;i++){x-=25;ctx.beginPath()
  ctx.fillStyle=["#ccc",["#920e5a","#ce082c"][Math.floor(i/3)%2]][+(!!(u&(1<<i)))]
  ctx.arc(x, y+25, 10, 0, 2*Math.PI)
  ctx.fill();if(!((1+i)%3))x-=10
}}
let show=x=>{blink(x,0);blink(M[x>>1],1);
 stack()
 let b=ge(x.toString(8));if((!x)||(!b)){trap((x==0)?"halt":"illegal addr "+Oct(x));return}
 if(bold)bold.classList.remove("b");bold=b
 let o=x=>{let r=x.toString(8);return"000000".slice(0,6-r.length)+r}
 let t=bold.textContent,s=Array.from(M.slice(0,4)).map(o).join(" ")+"]["+Array.from(M.slice(4,8)).map(o).join(" ")+" "+flag()
 bold.textContent=t.slice(0,16)+s+t.slice(76)
 bold.classList.add("b");bold.scrollIntoView({block:"center"})
}
let flag=()=>(zero?"z":"-")+(sign?"n":"-")+(carry?"c":"-")
let stack=()=>{let sp=M[6],stk=ge("stk");if(0==sp)return
 let a=Array.from(Array((011776-sp)>>1)).map((x,i)=>Oct(011774-2*i)+": "+Oct(M[D+(011774>>1)-i]))
 stk.textContent=a.join("\n")
 stk.scrollTop=stk.scrollHeight}
let trap=x=>{blink(0177777,1);ge("stepbut").disabled=true ;ge("runbut").disabled=true;ge("stk").textContent+="\n"+x;wait=true}
let setbrk=(e)=>{let x=e.target,y=parseInt(x.id,8);if("SPAN"!=x.nodeName)return;brk=(brk==y)?0:y
 Array.from(ge("asm").children).forEach(x=>x.classList.remove("brk"));if(brk)x.classList.add("brk")
}
let reset=(x)=>{lights()      ;ge("stepbut").disabled=false;ge("runbut").disabled=false;wait=false
 x=x.replace(/:.*/,"");prg=(""==x)?"k":x
 let asm=ge("asm")
 asm.textContent=" addr    inst     r0     r1     r2     r3      r4     fp     sp     pc\n"
 fetch("t/"+prg+".out").then(r=>r.text()).then(r=>{
  rst(eval("["+r+"]"));disasm((x,y)=>{let t=ce("span");t.textContent=x;hi(t);t.id=y;link(t);asm.appendChild(t)})
  asm.ondblclick=setbrk
})}
let fnum=0,hi=t=>{if(t.textContent.endsWith("mov fp,-(sp)\n")){fnum++;t.style.borderTop="1px solid";t.textContent=t.textContent.slice(0,-1)+"  /"+fnum+"\n"}}

let link=x=>{
 let s=x.textContent.replace(/jsr #([0-9]+),pc/,"jsr <span class='l' onclick='jmp(this)'>#$1</span>,pc")
 s=s.replace(/ \+([0-9]+)/," <span class='l' onclick='jmp(this)'>+$1</span>")
 s=s.replace(/ \-([0-9]+)/," <span class='l' onclick='jmp(this)'>-$1</span>")
 x.innerHTML=s;return x}
let jmp=x=>{let a=x.parentElement.id
 let r1=(parseInt(a,8)+2+parseInt(x.textContent.slice(1),8)).toString(8)
 let r0=(parseInt(a,8)+2-parseInt(x.textContent.slice(1),8)).toString(8)
 let s=x.textContent,t=ge((s[0]=="#")?(s.slice(1)):(s[0]=="+")?r1:r0)
 t.textContent=t.textContent.slice(0,-1) //todo: this clears links
 let b=ce("span");b.textContent="  â†’#"+a+"\n";b.classList.add("l")
 b.onclick=()=>{let u=ge(a),p=b.parentElement
  b.remove();p.textContent+="\n"
  if(bold)bold.classList.remove("b");bold=u;u.classList.add("b")
  bold.scrollIntoView({block:"center"})}
 t.appendChild(b)
 if(bold)bold.classList.remove("b");bold=t;t.classList.add("b")
 bold.scrollIntoView({block:"center"})}

</script>
</head>
<body onload="reset(location.hash.slice(1))">
 <div id="lights" >
  <canvas id="cnv" width="470" height="65"></canvas>
 </div>
 <div>
  <textarea id="tty" readonly="readonly" onkeypress="addchar(event.which)" onkeyup="specialchar(event.which)"> </textarea>
 </div>
 <div style="display:flex">
  <button id="resetbut" onclick="reset(location.hash.slice(1))">reset</button>
  <button id="stepbut"  onclick="step()">step</button>
  <button id="runbut"   onclick="run(location.hash.slice(1))">run</button>
 </div>
 <div>
  <pre id="stk"></pre>
 </div>
 <pre id="asm"></pre>
</body>
</html>
