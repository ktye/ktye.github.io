<!DOCTYPE html>
<head><meta charset="utf-8">
<!--link rel="icon" type="image/png" sizes="16x16" href="../kelas16.png"-->
<!--title>pdp11</title-->
<title>pd</title>
<style>
body{margin:0;height:100vh;display:flex;flex-flow:column;overflow:hidden}
* {font-family:monospace;box-sizing:border-box}
.b{font-weight:bold}
.l{color:blue}.l:hover{cursor:pointer}
.brk{border-left:1ch solid black}
#tty{font-family:monospace;width:100%;height:7em;/*background:#920e5a;color:white;*/outline:none;resize:none}
#stk{font-family: monospace;width:100%;height:7em;/*background:#ce082c;color:white;*/outline:none;overflow:auto}
#asm{overflow:auto}
#fun{position:absolute;right:20px;bottom:10px}
#lights{border:2px solid black;border-radius:10px;display:flex;justify-content:center}
legend{text-align:center}
button{flex-grow:1;background:#333;color:white;height:2em}button:disabled{background:#888}
</style>
<!--
<script src="k.js" type="text/javascript"></script>
<script src="cons.js" type="text/javascript"></script>
-->
<script src="pdp11.js" type="text/javascript"></script>
<script src="disas.js" type="text/javascript"></script>
<script src="tests.js" type="text/javascript"></script>
<script>

let ge=x=>document.getElementById(x)
let ce=x=>document.createElement(x)
let rm=x=>{while(x.firstChild)x.removeChild(x.firstChild)}
let ctx,bold=null,prg="k"
let lights=()=>{let cnv=ge("cnv")
 ctx=cnv.getContext("2d")
 ctx.clearRect(0,0,cnv.width,cnv.height)
 ctx.fillStyle="#ce082c";ctx.fillRect(5,0,455,10)
 ctx.fillStyle="#920e5a";ctx.fillRect(40,0,85,10);ctx.fillRect(210,0,85,10);ctx.fillRect(375,0,85,10)
 ctx.font="16px monospace";ctx.fillStyle="black";ctx.fillText("A",460,32);ctx.fillText("I",460,58)
 blink(0,0);blink(0,1)
}
let blink=(u,y)=>{let x=470;y*=25
 for(let i=0;i<16;i++){x-=25;ctx.beginPath()
  ctx.fillStyle=["#ccc",["#920e5a","#ce082c"][Math.floor(i/3)%2]][+(!!(u&(1<<i)))]
  ctx.arc(x, y+25, 10, 0, 2*Math.PI)
  ctx.fill();if(!((1+i)%3))x-=10
}}
let show=x=>{blink(x,0);blink(M[x>>1],1);play(M[x>>1])
 if(0104==M[x>>1])fpop(+x.toString(8))
 if(012623==M[x>>1])showheap()
 if(016101==M[x>>1])showgeti()
 if(016301==M[x>>1])showgetk()
 if((010346==M[x>>1])&&(012703==M[1+(x>>1)])){showGet(x)}
 if((010044==M[x>>1])&&(1)){showSet(x)}
 //if((M[D+2588]!=0)&&(M[D+2588]!=5392))throw("corruption")
 stack()
 let b=ge(x.toString(8));
 if(b===null)page(x);b=ge(x.toString(8))
 if((!x)||(!b)){trap((x==0)?"halt":"illegal addr "+Oct(x));return}
 if(bold)bold.classList.remove("b");bold=b
 let o=x=>{let r=x.toString(8);return"000000".slice(0,6-r.length)+r}
 let t=bold.textContent,s=Array.from(M.slice(0,4)).map(o).join(" ")+"]["+Array.from(M.slice(4,8)).map(o).join(" ")+" "+flag()
 bold.textContent=t.slice(0,16)+s+t.slice(77)
 bold.classList.add("b");bold.scrollIntoView({block:"center"})
}
let flag=()=>(zero?"z":"-")+(sign?"n":"-")+(over?"v":"-")+(carry?"c":"-")
let stack=()=>{let sp=M[6],stk=ge("stk");if(0==sp)return
 let a=Array.from(Array((011776-sp)>>1)).map((x,i)=>Oct(011774-2*i)+": "+Oct(M[D+(011774>>1)-i]))
 stk.textContent=a.join("\n")
 stk.scrollTop=stk.scrollHeight}
let trap=x=>{blink(0177777,1);ge("stepbut").disabled=true ;ge("runbut").disabled=true;ge("stk").textContent+="\n"+x;wait=true}
let setbrk=(e)=>{let x=e.target,y=parseInt(x.id,8);if("SPAN"!=x.nodeName)return;brk=(brk==y)?0:y
 Array.from(ge("asm").children).forEach(x=>x.classList.remove("brk"));if(brk)x.classList.add("brk")
}
let reset=(x)=>{lights()      ;ge("stepbut").disabled=false;ge("runbut").disabled=false;wait=false
 x=x.replace(/:.*/,"");prg=(""==x)?"k":x;test=prg!="k"
 ge("stk").textContent=""
 ge("tty").value="";ge("tty").onkeydown=key
 let asm=ge("asm")
 fetch("t/gc").then(   r=>r.text()).then(r=>{calls=r.split("\n")})
 fetch("t/k.off").then(r=>r.text()).then(r=>{fargs=eval("({"+r+"})")})
 //fetch("t/k.img").then(r=>r.arrayBuffer()).then(r=>M.set(r,D))
 fetch("t/k.map").then(r=>r.text()).then(r=>{fnames(eval(r))})
 fetch("t/"+prg+".out").then(r=>r.text()).then(r=>{
  rst(eval("["+r+"]"));
  page(01000)
  asm.ondblclick=setbrk
})}
let fnum=0

let page=pc=>{let asm=ge("asm")
 let o=+pc.toString(8);if(o in fileoff){fstack.unshift(fileoff[o]);fshow();showcall()}
 asm.textContent=" addr    inst     r0     r1     r2     r3      r4     fp     sp     pc\n"
 disasm(pc,(x,y)=>{let t=ce("span");t.textContent=x;/*hi(t)*/;t.id=y;/*link(t)*/;asm.appendChild(t)})
}

let instructions=0
let track=x=>{instructions++
 switch(M[x>>1]){
 //case 0104:   if(x<=laddr)fpop(x);return
 /*
 case 000207: 
 case 000104: let b=fstack.pop(),c=fstack.pop();
  if((b>addr0)&&(b<=laddr)){
	  let f=fmap[b]
	  if( M[6]-c != 8*fargs[f]-8 )
 	   console.log("r",c-M[6],f,M[6],c)
  }
  return
 */
 case 000127:
 case 004727: let a=M[1+(x>>1)]; //fstack.push(M[6]); fstack.push(a)
  if((a>addr0)&&(a<=laddr))showcall(fmap[a],+M[x>>1]==0127);return
 case 012623: showheap();return
 case 016101: showgeti();return
 case 016301: showgetk();return
 case 010346: if(012703==M[1+(x>>1)])showGet(x);return
 case 010044: showSet(x);return
 }}

let fargs={}
let fileoff={},faddr=[],fname=[],laddr=0,addr0=1e10,fmap={}
let fnames=d=>{for(const f in d){let a=parseInt(""+d[f],8);fmap[a]=f;fileoff[a]=f;faddr.push(a);if(a<addr0)addr0=a;if(a>laddr)laddr=a;fname.push(f)}}
let fstack=[]
let fshow=()=>{ge("fun").textContent=fstack.join("\n")}
let fpop=x=>{if(test)return;
 fstack.shift()//;fshow()
}
let showhist=()=>{
 ge("fun").textContent=Object.entries(hist).sort(([,a],[,b])=>b-a).map(x=>x[0]+" "+x[1]).join("\n")
}

let showcall=(x,y)=>{
 let a=fargs[x],sp=D+(M[6]>>1)+4*(a-2)+y
 if(a==1){ x+=" "+(M[ 0]|(M[   1]<<16))+" "+(M[   2]|(M[   3]<<16)) }
 if(a> 1){ x+=" "+(M[sp]|(M[sp+1]<<16))+" "+(M[sp+2]|(M[sp+3]<<16)) }
 ccall(x)}

let showicall=()=>{ /*console.log("icall", M[4], M[D+(M[6]>>1)]) */ }

let total=0
let ccall=x=>{  /*console.log("stack", M[6]);*/ if(M[6]<1000) throw("stack")
 return
 let c=calls[total];total++
 if(x.startsWith(c))console.log(x, "ok", total)
 else              {console.log(x, "expected", c); throw("calls")}
}

let showheap=()=>{if(test)return
 if(      M[(M[7]-2)>>1]==010003){let sp=D+(M[6]>>1);
  if(     M[(M[7]+4)>>1]==062706){ ccall("SetI32 "+M[3]+" "+(M[sp]|(M[1+sp]<<16))) }
  else if(M[(M[7]+4)>>1]==012623){ ccall("SetI64 "+M[3]+" "+(M[sp]|(M[1+sp]<<16))+" "+(M[2+sp]|(M[3+sp]<<16))) }
 }}
let showgeti=()=>{if(test)return
 ccall("I32 "+M[1]+" "+M[0])
}
let showgetk=()=>{if(test)return;let p=D+(M[3]>>1)
 ccall("I64 "+M[3]+" "+(M[p]|(M[1+p]<<16))+" "+(M[2+p]|(M[3+p]<<16)))
}

let showGet=(x)=>{ console.log("Get", M[2+(x>>1)]); }
let showSet=(x)=>{ console.log("Set", M[4].toString(8)+":", M[0]|(M[1]<<16), M[2]|(M[3]<<16)) }

let oc,fr=0.334*22050/0177777
let player=()=>{// return
 let au=new AudioContext()
 oc=au.createOscillator();oc.frequency=440;oc.start(0)
 let g=au.createGain();oc.connect(g);g.gain.value=0.1
 g.connect(au.destination)}
let play=x=>{if(oc!==undefined)oc.frequency.value=x*fr}

/*
let hi=t=>{if(t.textContent.endsWith("mov fp,-(sp)\n")){fnum++;t.style.borderTop="1px solid";t.textContent=t.textContent.slice(0,-1)+"  /"+fnum+"\n"}}
let link=x=>{
 let s=x.textContent.replace(/jsr #([0-9]+),pc/,"jsr <span class='l' onclick='jmp(this)'>#$1</span>,pc")
 s=s.replace(/ \+([0-9]+)/," <span class='l' onclick='jmp(this)'>+$1</span>")
 s=s.replace(/ \-([0-9]+)/," <span class='l' onclick='jmp(this)'>-$1</span>")
 x.innerHTML=s;return x}
let jmp=x=>{let a=x.parentElement.id
 let r1=(parseInt(a,8)+2+parseInt(x.textContent.slice(1),8)).toString(8)
 let r0=(parseInt(a,8)+2-parseInt(x.textContent.slice(1),8)).toString(8)
 let s=x.textContent,t=ge((s[0]=="#")?(s.slice(1)):(s[0]=="+")?r1:r0)
 t.textContent=t.textContent.slice(0,-1) //todo: this clears links
 let b=ce("span");b.textContent="  â†’#"+a+"\n";b.classList.add("l")
 b.onclick=()=>{let u=ge(a),p=b.parentElement
  b.remove();p.textContent+="\n"
  if(bold)bold.classList.remove("b");bold=u;u.classList.add("b")
  bold.scrollIntoView({block:"center"})}
 t.appendChild(b)
 if(bold)bold.classList.remove("b");bold=t;t.classList.add("b")
 bold.scrollIntoView({block:"center"})}
*/


</script>
</head>
<body onload="reset(location.hash.slice(1))">
 <div id="lights" >
  <canvas id="cnv" width="470" height="65"></canvas>
 </div>
 <div>
  <textarea id="tty"></textarea>
 </div>
 <div style="display:flex">
  <button id="resetbut" onclick="reset(location.hash.slice(1))">reset</button>
  <button id="stepbut"  onclick="step()">step</button>
  <button id="runbut"   onclick="run(location.hash.slice(1))">run</button>
  <button id="Runbut"   onclick="Run()">Run</button>
 </div>
 <div>
  <pre id="stk"></pre>
 </div>
  <pre id="asm"></pre>
  <pre id="fun"></pre>
</body>
</html>
