<!DOCTYPE html>
<head><meta charset="utf-8"><link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAE0lEQVR42mNk+M+AFzCOKhhJCgBrLxABLz0PwwAAAABJRU5ErkJggg=="><title>rotor</title>
<style>
*{margin:0;overflow:hidden;font-family:monospace}
body{overflow-y:auto}
svg{display:block;margin:auto}
svg:focus{outline:none}
.ln:hover{cursor:pointer}
.ul{border-bottom:1px solid}
table{border-collapse:collapse}
textarea{background:#efe;border:none;outline:none}
input,select{width:5em}
th{text-align:left}
dialog::backdrop{background-color:grey;opacity:0.75}


</style>
<body>
<select id="selex" onchange="chex(this)" style="width:auto"></select> <span id="extitle" style="color:#0000ee" class="ln" onclick="hlp.showModal()"></span><br/>
<svg id="svg" width="800" height="200" xmlns="http://www.w3.org/2000/svg" onkeydown="svgkey(event)" tabindex="0"></svg>

<div style="display:inline">
 <input type="radio" id="butmod" name="modelradios" style="width:20px"         onchange="showmod()"/><label for="butmod">model</label>
 <input type="radio" id="butsim" name="modelradios" style="width:20px" checked onchange="showsim()"/><label for="butsim">simulation</label>
</div>

<div id="modpanel" style="display:none">
 <pre id="massprop" ></pre>
 <div  style="display:flex;flex-direction:row;justify-content:space-between">
 <div>units&nbsp;&nbsp;&nbsp;:<select id="units" onchange="changeunits()"><option>iso</option><option>large</option><option>medium</option><option>small</option></select><br/>
 
 </div>
 <table id="nodeedit" data-i="0" style="display:none">
  <caption id="nodecaption" data-i="0">node</caption>
  <tr><th>disc Da</th><td><input type="number"    id="edDa" onchange='ed(this,"D","L")' /></td><td class="unitL">m</td></tr>
  <tr><th>disc Di</th><td><input type="number"    id="edDi" onchange='ed(this,"d","L")' /></td><td class="unitL">m</td></tr>
  <tr><th>disc thickness</th><td><input type="number"    id="edT" onchange='ed(this,"t","L")' /></td><td class="unitL">m</td></tr>
  <tr class="ul"><th>mass</th><td><input type="number"       id="edM"  onchange='ed(this,"m","M")' /></td><td class="unitM">kg</td></tr>
  <tr><th>support cx</th><td><input type="number" id="edCx" onchange='ed(this,"cx","C")' /></td><td class="unitC">N/m</td></tr>
  <tr class="ul"><th>support cy</th><td><input type="number" id="edCy" onchange='ed(this,"cy","C")' /></td><td class="unitC">N/m</td></tr>
  <tr><th>unbalance</th><td><input type="number"  id="edU"  onchange='ed(this,"u","U")' /></td><td class="unitU">kgm</td></tr>
  <tr class="ul"><th>angle</th><td><input type="number"      id="edA"  onchange='ed(this,"a","")' min="0" max="360" /></td><td>deg</td></tr>
  <tr><th>sensor direction</th><td><select        id="edSen" onchange='ed(this,"sen","dir")'><option>none</option><option>x</option><option>y</option><option>xy</option></select></td></tr>
 </table>
 <table id="shaftedit" data-i="0" style="display:none">
  <caption id="shaftcaption">shaft</caption>
  <tr><th>length</th><td><input type="number"  id="edl"   onchange='ed(this,"L","L")' /></td><td class="unitL">m</td></tr>
  <tr><th>Da</th><td><input type="number"      id="edda"  onchange='ed(this,"D","L")' /></td><td class="unitL">m</td></tr>
  <tr><th>Di</th><td><input type="number"      id="eddi"  onchange='ed(this,"d","L")' /></td><td class="unitL">m</td></tr>
  <tr><th>E </th><td><input type="number"      id="ede"   onchange='ed(this,"E","P")' /></td><td>GPa</td></tr>
  <tr><th>density</th><td><input type="number" id="edrho" onchange='ed(this,"rho","R")' /></td><td class="unitR">kg/m^3</td></tr>
  <tr><th>mass</th><td><input type="number"    id="edm"   onchange='ed(this,"m","M")' /></td><td class="unitM">kg</td></tr>
  <tr><td><button onclick="splitshaft()">split into</button></td><td><input id="splitinto" type="number" min="2" max="20" value="2"></td></tr>
 </table>
 <textarea id="ta" style="resize:none" onchange="modelT(this.value)" spellcheck="false"></textarea>
 <table style="display:block"><caption>legend</caption>
  <tr><th>●</th><td>node</td></tr>
  <tr><th>○</th><td>center of mass</td></tr>
  <tr><th style="color:blue">()</th><td>radius of inertia</td></tr>
  <tr><th>¦</th><td>mass/disc element</td></tr>
  <tr><th>■</th><td>unbalance</td></tr>
  <tr><th>▲</th><td>isotropic bearing</td></tr>
  <tr><th>△</th><td>anisotropic bearing</td></tr>
  <tr><th>◺</th><td>support (x-only)</td></tr>
  <tr><th>◿</th><td>support (y-only)</td></tr>
  <tr><th>⧅</th><td>sensor x-direction</td></tr>
  <tr><th>⧄</th><td>sensor y-direction</td></tr>
  <tr><th style="color:red">|</th><td>sensor for monitor only</td></tr>
  <tr class="ul"><th style="color:green">|</th><td>sensor for balancing</td></tr>
  <tr><th>length</th><td id="rotorlength"></td></tr>
  <tr><th>mass</th><td id="rotormass"></td></tr>
  <tr><th>center of mass</th><td id="rotorcom"></td></tr>
  <tr><th>rotatorial inertia</th><td id="rotorjr"></td></tr>
  <tr><th>equatorial inertia</th><td id="rotorjq"></td></tr>
  <tr><th>x-bearing critical</th><td id="xbearing"></td></tr>
  <tr><th>y-bearing critical</th><td id="ybearing"></td></tr>
 </table>
 </div>
</div>

<div id="simpanel">
 <div style="display:flex;justify-content:space-around">
 <table id="utab">
 <tr><td></td><td colspan="2">initial</td><td colspan="3">correction</td></tr>
 <tr><th>node</th><th class="unitU">kgm</th><th>deg</th><th>cor</th><th class="unitU">kgm</th><th>deg</th></tr>
 </table>
 <table><caption>speed range</caption>
 <tr><th>min</th><td><input id="minspeed" type="number" onchange="calculate()"/></td><td class="unitN">rpm</td></tr>
 <tr><th>max</th><td><input id="maxspeed" type="number" onchange="calculate()"/></td><td class="unitN">rpm</td></tr>
 <tr><th>steps</th><td><input id="steps" type="number" min="2" max="1000" onchange="calculate()"/></td></tr>
 </table>
 <div>
  <label for="angle">angle </label><br/><input type="number" id="angle" min="0" max="360" onchange="anim(this.value)" title="clear to animate"/><br/><br/>
  <span id="time"></span><input type="checkbox" id="fastsim" style="margin-left:1em;width:20px" onchange="calculate()" checked /><label for="fastsim">fast</label>
 </div>
 <div><input id="asp" type="range" min="0" max="13" style="writing-mode:vertical-lr;direction:rtl;width:20px" /><label for="asp" style="position:fixed">fast</label><label for="asp">slow</label></div>
 </div>
 
 <canvas id="cnv" style="width:100%;height:30vh;background:#aaa"></canvas>
 
 <span id="bac" class="ln" style="display:none" title="speed down"> ◀ </span><span id="fwd" class="ln" style="display:none" title="speed up">▶ </span><span id="legend" style="background:#efe"></span>
 
 <div style="display:flex;justify-content:space-between">
  <div><input type="radio" id="butdis" name="radios" onchange="plotdis()" style="width:20px" checked/><label for="butdis">displacement</label></div>
  <div><input type="radio" id="butifc" name="radios" onchange="plotifc()" style="width:20px"/><label for="butifc">ic</label></div>
  <div><input type="radio" id="butunb" name="radios" onchange="plotunb()" style="width:20px"/><label for="butunb">unbalance</label></div>
  <div><input type="radio" id="butprm" name="radios" onchange="plotprm()" style="width:20px"/><label for="butprm">unbalance(perm)</label></div>
  <div><input type="checkbox" id="polar"             onchange="showplot()" style="width:20px"/><label for="polar">polar</label></div>
 </div>
 <canvas id="pcnv" style="width:100%;height:30vh;background:grey"></canvas>
 <select id="pcap" style="width:100%;min-height:50px;outline:none;border:none;border-radius:0;overflow:auto" multiple></select>
</div>

<dialog id="hlp" style="margin:auto"><pre id="hlptxt">help text..</pre><form method="dialog"><button style="margin-left:45%">ok</button></form></dialog>

<script src="../plot.js" id="pjs"></script>
<script>
const pi=Math.PI
let sqrt=Math.sqrt,cos=Math.cos,sin=Math.sin,min=Math.min,max=Math.max,floor=Math.floor,hypot=Math.hypot,abs=Math.abs,atan2=Math.atan2,
ge=x=>document.getElementById(x),ce=x=>document.createElement(x),ac=(x,y)=>{y.appendChild(x);return x},rm=(p)=>{while(p.firstChild)p.removeChild(p.firstChild);return p},af=x=>Array.from(x),tc=(t,e)=>{e.textContent=t;return e},lo=x=>Number(BigInt.asUintN(32,x)),gc=x=>af(document.getElementsByClassName(x)),
cE=x=>document.createElementNS("http://www.w3.org/2000/svg",x),sA=(x,...y)=>{for(let i=0;i<y.length;i+=2)x.setAttributeNS(null,y[i],y[1+i]);return x},
su=x=>t_.decode(x),t_=new TextDecoder("utf-8"),us=x=>_t.encode(x),_t=new TextEncoder("utf-8"),u64s=s=>{let c=function(x){const r=new Uint8Array(x.length);for(let i=0;i<x.length;i++)r[i]=x.charCodeAt(i);return r};return c(atob(s))},


tamod=_=>{ let v=fmt(model.map(x=>JSON.stringify(x).slice(1,-1).replaceAll(`"`,"").replaceAll(","," "))) ;ta.cols=2+max(...v.map(x=>x.length));ta.rows=v.length;ta.value=v.join("\n")},
modelT=x=>{try{model=JSON.parse("["+x.split("\n").map(x=>"{"+x.trim().replace(/ +/g,",").replace(/[a-zA-Z]+/g,x=>'"'+x+'"')+"}").join(",")+"]")}catch(e){};update(0)},
fmt=v=>{v.forEach((x,i)=>{v[i]=x.split(" ");v[i].push(..." ".repeat(10-v[i].length).split(""))});let col=j=>v.map(x=>x[j]);for(let j=0;j<v[0].length;j++){let c=col(j),m=max(...c.map(x=>x.length));v.forEach((x,i)=>v[i][j]+=" ".repeat(m-x[j].length)) };return v.map((x,i)=>v[i]=x.join(" "))},

shafts=m=>m.filter((_,i)=>i%2),nodes =m=>m.filter((_,i)=>(1+i)%2),
discs=m=>nodes(m).filter(x=>x.D!=0),
ipln=()=>nodes(model).map((x,i)=>(x.u!=0||x.a!=0)?i:-1).filter(x=>x>=0),
isen=()=>{let n=nodes(model);return Array(4*n.length).fill(0).map((_,i)=>i).filter(i=>n[floor(i/4)].sen.includes((0==i%4)?"x":(1==i%4)?"y":"never"))},
absang=(x,y)=>[hypot(x,y),(y=atan2(y,x)*180/pi,(y<0)?y+360:y)],

svgmod=(m,a)=>{let D=0,L=0,X=[0],r="",rig=rigid(m);let sh=shafts(m);svg.dataset.i=a
 sh.forEach((x,i)=>{let st=(a==1+2*i)?"darkorange":"black"; let xi=L;
  r+=`<rect x="${xi}" y="${-x.D/2}"   width="${x.L}" height="${(x.D-x.d)/2}" fill="grey" class="ln" onclick="clickshaft(${1+2*i})"/>`
  r+=`<rect x="${xi}" y="${x.d/2}"    width="${x.L}" height="${(x.D-x.d)/2}" fill="grey" class="ln" onclick="clickshaft(${1+2*i})"/>`
  r+=`<rect x="${xi}" y="${(-x.d)/2}" width="${x.L}" height="${x.d}"    fill="lightgrey" class="ln" onclick="clickshaft(${1+2*i})"/>`
  r+=`<rect x="${xi}" y="${-x.D/2}"   width="${x.L}" height="${x.D}" fill="none" stroke="${st}" stroke-width="2px" vector-effect="non-scaling-stroke" />`;
  D=max(D,x.D);L+=x.L;X.push(X[i]+x.L)})
 
 sh.forEach((x,i)=>{
  r+=`<circle cx="${X[i]}" cy="0" r="${D/10}" fill="black" stroke="${(a==(    2*i    ))?"darkorange":"black"}" stroke-width="2px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${   2*i     })"/>`})
  r+=`<circle cx="${  L }" cy="0" r="${D/10}" fill="black" stroke="${(a==(2*sh.length))?"darkorange":"black"}" stroke-width="2px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*sh.length})"/>`
 
 r+=`<circle cx="${rig.Z}" cy="0" r="${D/14}" fill="white" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke"/>` //com
 
 D=(8*D<L)?L/4:2*D
 nodes(m).forEach((x,i)=>{let xi=X[i],xr=max(x.D,i?m[2*i-1].D:0,(2*i+1<m.length)?m[2*i+1].D:0)/2;
  if(x.m!=0){ //discs
   //r+=`<line x1="${xi}" y1="${-x.D/2}" x2="${xi}" y2="${-x.d/2}" stroke="black" stroke-width="7px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*i})"/>`
   //r+=`<line x1="${xi}" y1="${ x.D/2}" x2="${xi}" y2="${ x.d/2}" stroke="black" stroke-width="7px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*i})"/>`}
   r+=`<rect x="${xi-x.t/2}" y="${-x.D/2}" width="${x.t}" height="${(x.D-x.d)/2}" fill="black" class="ln" onclick="clicknode(${2*i})"/>`
   r+=`<rect x="${xi-x.t/2}" y="${x.d/2}"  width="${x.t}" height="${(x.D-x.d)/2}" fill="black" class="ln" onclick="clicknode(${2*i})"/>`}
  if(x.sen!="none"){ //sensors
   r+=`<line x1="${xi}" y1="${-D/2}" x2="${xi}" y2="${-1.1*xr}"" stroke="red" stroke-width="2px" vector-effect="non-scaling-stroke" />`
   r+=`<rect x="${xi-D/20}" y="${-D/2}" width="${D/10}" height="${D/10}" fill="lightgrey" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*i})"/>`
   if(x.sen.includes("x"))r+=`<line x1="${xi-D/20}" y1="${-D/2}" x2="${xi+D/20}" y2="${D/10-D/2}" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" />`
   if(x.sen.includes("y"))r+=`<line x1="${xi+D/20}" y1="${-D/2}" x2="${xi-D/20}" y2="${D/10-D/2}" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" />`}
  if(x.cx!=0||x.cy!=0){ //springs 
   let st=((x.cx==x.cy)?'fill="black"':'fill="none" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke"')
   if(x.cx!=0)r+=`<polygon points="${xi},${xr} ${xi+D/20},${xr+D/10} ${xi},${xr+D/10}" ${st} class="ln" onclick="clicknode(${2*i})"/>`
   if(x.cy!=0)r+=`<polygon points="${xi},${xr} ${xi},${xr+D/10} ${xi-D/20},${xr+D/10}" ${st} class="ln" onclick="clicknode(${2*i})"/>`}
  if(x.u!=0)r+=`<rect x="${xi-D/20}" y="${-xr-D/10}" width="${D/10}" height="${D/10}" fill="black" class="ln" onclick="clicknode(${2*i})"/>` //unbals
 })
 
 r+=`<circle cx="${rig.Z}" cy="0" r="${rig.iJ}" stroke="blue" fill="none" stroke-width="${D/40}" stroke-dasharray="${0.2*pi*rig.iJ} ${0.8*pi*rig.iJ}" stroke-dashoffset="${0.6*pi*rig.iJ}"/>` // radius of inertia
 r+=`<circle cx="${rig.Z}" cy="0" r="${rig.iQ}" stroke="blue" fill="none" stroke-width="${D/40}" stroke-dasharray="${0.1*pi*rig.iQ} ${0.9*pi*rig.iQ}" stroke-dashoffset="${0.05*pi*rig.iQ}"/>` // radius of inertia
 
 
 X=L+D/5
 r+=`<line x1="${X}" x2="${X+D/5}" y1="0" y2="0" stroke-width="3px" stroke="black" vector-effect="non-scaling-stroke" class="ln" onclick="addshaft()"/>`
 X+=D/10
 r+=`<line x1="${X}" x2="${X}" y1="${-D/10}" y2="${D/10}" stroke-width="3px" stroke="black" vector-effect="non-scaling-stroke" class="ln" onclick="addshaft()"/>`
 X+=D/5
 
 svg.innerHTML=r
 sA(svg,"viewBox",`${-D/12} ${-D/2} ${X+D/12} ${D}`,"preserveAspectRatio","xMidYMid")
 
 rotorlength.textContent=`${scL(L).toPrecision(6)} ${uni("L")[0]}`
 rotormass.textContent  =`${scM(rig.M).toPrecision(6)} ${uni("M")[0]}`
 rotorcom.textContent   =`${scL(rig.Z).toPrecision(6)} ${uni("L")[0]}`
 rotorjr.textContent    =`${scL(rig.iJ).toPrecision(6)} ${uni("L")[0]}`
 rotorjq.textContent    =`${scL(rig.iQ).toPrecision(6)} ${uni("L")[0]}`
 xbearing.textContent   =`${scN(rig.nx[0]).toPrecision(5)}, ${scN(rig.nx[1]).toPrecision(6)} ${uni("N")[0]}`
 ybearing.textContent   =`${scN(rig.ny[0]).toPrecision(5)}, ${scN(rig.ny[1]).toPrecision(6)} ${uni("N")[0]}`
},
area=x=>0.25*pi*(x.D*x.D-x.d*x.d),mass=x=>area(x)*x.rho*x.L,moiQ=(m,R,r,t)=>m*(3*R*R+3*r*r+t*t)/12,

emptynode=_=>{return{m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,sen:"none"}},
clicknode=i=>{showmod();shaftedit.style.display="none";nodeedit.style.display="block";nodecaption.textContent="element "+i+" (node)";nodeedit.dataset.i=i;svgmod(model,i)
 af([edDa,edDi,edM,edCx,edCy,edU,edA]).forEach(x=>x.value=null);edSen.value="none"
 let e=model[i];edDa.value=scL(e.D);edDi.value=scL(e.d);edM.value=scM(e.m);edT.value=scL(e.t),edCx.value=scC(e.cx);edCy.value=scC(e.cy);edU.value=scU(e.u);edA.value=e.a;edSen.value=e.sen},
clickshaft=i=>{showmod();shaftedit.style.display="block";nodeedit.style.display="none"; shaftcaption.textContent="element "+i+" (shaft)";shaftedit.dataset.i=i;svgmod(model,i)
 let e=model[i];edl.value=scL(e.L);edda.value=scL(e.D);eddi.value=scL(e.d);ede.value=scP(e.E),edrho.value=scR(e.rho);edm.value=scM(mass(e))},
changeunits=()=>{if(shaftedit.style.display=="block")clickshaft(+shaftedit.dataset.i);else clicknode(+nodeedit.dataset.i);"LMRCUNE".split("").forEach(x=>gc("unit"+x).forEach(e=>e.textContent=uni(x)[0]))},
addshaft=_=>{let n=model.length; model.push({...model[n-2]},emptynode());clickshaft(model.length-2)},
delelem=i=>{ if(0==i%2){model[i]=emptynode();return update(i)};if(i==0||model.length<4)return; model.splice(i-1,2); update(model.length-2)},
ed=(inp,s,u,j)=>{let t=inp.closest("table"),i=((j==undefined)?+t.dataset.i:j)
 if(u=="dir"){model[i][s]=inp.value;update(i);return};if(s=="cor"){model[i][s]=inp.checked;update(i);return}
 let c=1/((""!=u)?uni(u)[1]:1),v=c*(+inp.value),e=model[i];if("shaftedit"==t.id){if(s=="m"){s="rho";v*=e.rho/mass(e)};e[s]=v}else{e[s]=v}update(i)},

showmod=()=>{butmod.checked=true;modpanel.style.display="block";simpanel.style.display="none"                                  },modshown=()=>butmod.checked,
showsim=()=>{butsim.checked=true;modpanel.style.display="none" ;simpanel.style.display="block";calculate();animate(angle.value)},simshown=()=>butsim.checked,

splitshaft=_=>{let i=+shaftedit.dataset.i,n=+splitinto.value;if(n<2||n>100)return;let sh=model[i];sh.L/=n;while(--n>0){model.splice(i,0,{L:sh.L,D:sh.D,d:sh.d,E:sh.E,rho:sh.rho},emptynode()  )};update(i)},
svgkey=e=>{if(e.key=="Delete")delelem(+svg.dataset.i)},
urow=(u,a,c,i)=>utab.innerHTML+=`<tr><td>${i}</td><td><input type="number" value="${scU(u)}" onchange='ed(this,"u","U",${i});calculate()'/></td><td><input type="number" value="${a}" onchange='ed(this,"a","",${i});calculate()' min="0" max="360"/></td><td><input type="checkbox" ${c} style="width:1em" onchange='ed(this,"cor","",${i});calculate()'/></td><td id='${"coru"+i/2}'></td><td id='${"cora"+i/2}'></td></tr>`,
ubmod=m=>{while(utab.rows.length>2)utab.deleteRow(2);nodes(model).forEach((x,i)=>{if(x.u!=0||x.a!=0)urow(x.u,x.a,(x.cor?"checked":""),2*i)})},

rigid=m=>{ //rigid rotor properties
 let z=[0];shafts(m).forEach((x,i)=>z.push(z[i]+x.L))
 let M=shafts(m).reduce((s,e)=>s+mass(e),0)+nodes(m).reduce((s,e)=>s+e.m,0),
     Z=shafts(m).reduce((s,e,i)=>s+0.5*(z[i]+z[1+i])*mass(e)/M,0)+nodes(m).reduce((s,e,i)=>s+z[i]*e.m/M,0),
     J=shafts(m).reduce((s,e,i)=>s+mass(e)*(e.D*e.D+e.d*e.d)/8,0)                            +nodes(m).reduce((s,e,i)=>s+e.m*(e.D*e.D+e.d*e.d)/ 8,                0),
     Q=shafts(m).reduce((s,e,i)=>s+moiQ(mass(e),e.D/2,e.d/2,e.L)+mass(e)*(0.5*(z[i]+z[1+i])-Z)**2,0)+nodes(m).reduce((s,e,i)=>s+moiQ(e.m,e.D/2,e.d/2,e.t)+e.m*(z[i]-Z)**2,0),
     //Q=shafts(m).reduce((s,e,i)=>s+mass(e)*((0.75*(e.D*e.D+e.d*e.d)+e.L*e.L)/12+(0.5*(z[i]+z[1+i])-Z)**2),0)+nodes(m).reduce((s,e,i)=>s+e.m*(e.D*e.D+e.d*e.d)/16+e.m*(z[i]-Z)**2,0), //thin, without t
     nx=crit(m,M,Z,z,Q,"cx"),ny=crit(m,M,Z,z,Q,"cy")
 return{M:M,Z:Z,J:J,Q:1,iJ:sqrt(J/M),iQ:sqrt(Q/M),nx:nx,ny:ny}},
crit=(m,M,Z,z,Q,dir)=>{let c0=nodes(m).reduce((s,e,i)=>s+e[dir],0),c1=nodes(m).reduce((s,e,i)=>s+e[dir]*(z[i]-Z),0),c2=nodes(m).reduce((s,e,i)=>s+e[dir]*(z[i]-Z)**2,0),a=c0/M,b=c1/M,c=c1/Q,d=c2/Q,me=0.5*(a+d),det=a*d-b*c,rpm=30/pi;return[rpm*sqrt((me-sqrt(me*me-det))),rpm*sqrt(me+sqrt(me*me-det))]},

speedrange=_=>{let c=1/uni("N")[1],a=c*(+minspeed.value),b=c*(+maxspeed.value),n=+steps.value,d=(b-a)/(n-1);return new Array(n).fill(0).map((_,i)=>a+i*d)},
update=x=>{if(modshown()){if(x%2)clickshaft(x);else clicknode(x)};tamod(model);ubmod(model);svgmod(model)},

//changespeed=x=>{let s=+x.value,t=Infinity; console.log("s,t",s,t); if(isNaN(s)){x.value=minspeed.value}else{speedrange().forEach(x=>{if(abs(x-s)<abs(t-s))t=x});x.value=t;console.log("new t",t)}},

speedidx=0,phi=0,

calculate=_=>{
 if(speedidx>(+steps.value)-1)speedidx=(+steps.value)-1;
 if(kw&&rk)kinit(1);else setTimeout(calculate,500)},


uni=x=>{let t={
  iso:   {M:["kg",1],  L:["m",1],   R:["kg/m^3",1],U:["kgm",1],   C:["N/m",1],    P:["GPa",1e-9],N:["rpm",1]    ,dir:["",1]},
  large: {M:["t",1e-3],L:["mm",1e3],R:["kg/m^3",1],U:["kgmm",1e3],C:["N/µm",1e-6],P:["GPa",1e-9],N:["rpm",1]    ,dir:["",1]},
  medium:{M:["kg",1],  L:["mm",1e3],R:["kg/m^3",1],U:["gmm",1e6], C:["N/µm",1e-6],P:["GPa",1e-9],N:["rpm",1]    ,dir:["",1]},
  small: {M:["g",1e3], L:["mm",1e3],R:["kg/m^3",1],U:["mgmm",1e9],C:["N/µm",1e-6],P:["GPa",1e-9],N:["krpm",1e-3],dir:["",1]}
 };return t[units.value][x]},
scL=x=>x*uni("L")[1],scM=x=>x*uni("M")[1],scR=x=>x*uni("R")[1],scU=x=>x*uni("U")[1],scC=x=>x*uni("C")[1],scP=x=>x*uni("P")[1],scN=x=>x*uni("N")[1],

animate=(ang)=>{cancelAnimationFrame(req);if(0==shaftline.length)return
 let h;if(ang="")phi=(+ang)/180*pi
 
 //L=[0.1,0.5,0.2],R=[0.4,0.1,0.6],VX=[0.01,0.8,0.7,0.1],VY=[0,-0.05,0.05,0],WX=[0,0.05,-0.05,0],WY=VX.slice(),UI=[1,2,3],UA=[30,60,90].map(x=>x*pi/180),
 //X=new Array(1+L.length).fill(0);X.forEach((_,i)=>{if(i)X[i]=X[i-1]+L[i-1]})
 L=shafts(model).map(e=>e.L),suml=1.1*L.reduce((x,y)=>x+y,0),
 R=shafts(model).map(e=>e.D/2),rmax=1.5*max(...R),
 VX=shaftline[0],VY=shaftline[1],WX=shaftline[2],WY=shaftline[3],wmax=max(max(...VX.map((x,i)=>hypot(x,VY[i]))), max(...WX.map((x,i)=>hypot(x,WY[i]))))
 UI=nodes(model).map((e,i)=>(e.u>0)?i:-1).filter(x=>x>=0),
 UA=nodes(model).map((e,i)=>(e.u>0)?e.a*pi/180:NaN).filter(x=>!isNaN(x)),
 X=new Array(1+L.length).fill(0);X.forEach((_,i)=>{if(i)X[i]=X[i-1]+L[i-1]})
 
 L.forEach((x,i)=>L[i]=x/suml)
 X.forEach((x,i)=>X[i]=x/suml)
 R.forEach((x,i)=>R[i]=x/rmax)
 VX.forEach((x,i)=>VX[i]=x/wmax)
 VY.forEach((x,i)=>VY[i]=x/wmax)
 WX.forEach((x,i)=>WX[i]=x/wmax)
 WY.forEach((x,i)=>WY[i]=x/wmax)
 
 let frame=()=>{h=floor(cnv.clientHeight)
  let w=cnv.clientWidth,o=min(w/4,h/2),xo=w-o,yo=o,l=w-o,r=o/2,A=0.95,B=-0.1,C=0.7,D=0.4,E=-1;cnv.width=w;cnv.height=h
  let c=cnv.getContext("2d")
  c.clearRect(0,0,w,h);
   
  c.fillStyle="#eee";c.beginPath();c.moveTo(xo,yo);c.lineTo(xo,0);c.lineTo(w,0);c.lineTo(w,yo+o*D/C);c.closePath();c.fill()
  c.fillStyle="#fff";c.beginPath();c.moveTo(xo,yo);c.lineTo(xo-A*w,yo-B*w);c.lineTo(0,0);c.lineTo(xo,0);c.closePath();c.fill()
  let fg=x=>c.strokeStyle=x,lw=x=>c.lineWidth=x,an=(x,y,z)=>("number"==typeof x)?new Array(("number"==typeof y)?z.length:y.length).fill(x):x
  
  c.translate(xo,yo);c.translate(-A*l+C*r,-B*l+D*r+E*r)
  let L0=(x,y,z)=>{x=an(x,y,z);y=an(y,x,z);z=an(z,x,y);c.beginPath();c.moveTo(A*x[0]+C*y[0],B*x[0]+D*y[0]+E*z[0]);for(let i=1;i<x.length;i++)c.lineTo(A*x[i]+C*y[i],B*x[i]+D*y[i]+E*z[i]);c.stroke()},
  L1=(x,y,z)=>L0(l,y,z),L2=(x,y,z)=>L0(x,-r,z),L3=(x,y,z)=>L0(x,y,-r),L23=(x,y,z)=>{L2(x,y,z);L3(x,y,z)},L123=(x,y,z)=>{L1(x,y,z);L2(x,y,z);L3(x,y,z)}
  
  let xp,Q=(l,r)=>{L3(xp,[-r,r],-r);L3(xp+l,[-r,r],-r);L23([xp,xp+l],-r,-r);L23([xp,xp+l],r,r);L2(xp,-r,[-r,r]);L2(xp+l,-r,[-r,r])}
  
  lw(1)
  fg("#ddd");L1(0,-r,[-r,r]);L1(0,0,[-r,r]);L1(0,r,[-r,r]);L1(0,[-r,r],-r);L1(0,[-r,r],0);L1(0,[-r,r],r)
  fg("#ccc");xp=l*X[0];L.forEach((v,i)=>{Q(l*L[i],r*R[i]);xp+=l*v}) 
  
  let cs=cos(phi),sn=sin(phi),vx=VX.map((x,i)=>r*(x*cs+VY[i]*sn)),vy=WX.map((x,i)=>r*(x*cs+WY[i]*sn)),xx=X.map(x=>l*x),
  uu=UI.map(i=>[xx[i],xx[i]])
  ux=UI.map((i,j)=>[vx[i],vx[i]+20*cos(phi-UA[j])]),
  uy=UI.map((i,j)=>[vy[i],vy[i]+20*sin(phi-UA[j])]),
  
  fg("#000");lw(5);L0(xx,vx,vy);lw(1);L123(xx,vx,vy)
  fg("#f00");lw(3);ux.forEach((_,i)=>L0(uu[i],ux[i],uy[i]))
  lw(2);ux.forEach((_,i)=>L123(uu[i],ux[i],uy[i]))
  
  phi+=(0.001*1.5**Number(asp.value))-((phi>2*pi)?2*pi:0)
  if(simshown()&&angle.value=="")req=requestAnimationFrame(frame)
 };frame()},anim=animate,

examples={
 shaft:{model:[
  {m:0,D:0,d:0,t:0,cx:10000,cy:10000,u:0,a:0,cor:false,sen:"x"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:1e-6,a:0,cor:true,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:1e-6,a:90,cor:true,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:1e-6,a:180,cor:true,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:10000,cy:10000,u:0,a:0,cor:false,sen:"x"}
 ],speed:{min:100,max:2000,steps:100},title:"uniform shaft",help:`
┌─────────────────────────────────────────────────────────────────┐
│                       uniform shaft                             │
├─────────────────────────────────────────────────────────────────┤
│the example shows a shaft of 1m length and a diameter of 10cm.   │
│it has springs on both ends which are relatively soft:           │
│                                                                 │
│                    cL³/EI is 1%                                 │
│                                                                 │
│which is a measure between support and shaft stiffness.          │
│                                                                 │
│the rigid rotor critical speeds are at 172 and 297 rpm, click    │
│on 'model' to see the exact values from an analytic solution.    │
│                                                                 │
│verify the peaks in the displacment curves:                      │
│double-click on the blue displacement curve.                     │
│                                                                 │
│now increase the 'max speed' until you see the first bending     │
│critical. it appears at around 30krpm.                           │
│click into the displacement curve close to the critical to see   │
│the deformed mode shape in the animation.                        │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘`},
 resonance:{model:[
  {m:0,D:0,d:0,t:0,cx:10000,cy:10000,u:0,a:0,cor:false,sen:"x"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:1e-6,a:0,cor:true,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:10000,cy:10000,u:0,a:0,cor:false,sen:"x"}
 ],speed:{min:200,max:400,steps:400},title:"resonance",help:`
┌─────────────────────────────────────────────────────────────────┐
│                            resonance                            │
├─────────────────────────────────────────────────────────────────┤
│the rotor has a single unbalance at the center.                  │
│                                                                 │
│at low speed the unbalance points outwards.                      │
│increase the speed (click on the diagram or on ▶) until it       │
│approaches the resonance at 270 rpm.                             │
│the animation is always scaled to max but the actual orbits      │
│are large.                                                       │
│                                                                 │
│                                                                 │
│observe how the unbalance (short red line) turns forwards.       │
│at the peak of the critical speed it has an angle of 90 degree.  │
│look at the right wall projection to see the angle.              │
│                                                                 │
│increase further to high speeds.                                 │
│the unbalance points inwards now and the displacement reaches    │
│a small constant value.                                          │
│                                                                 │
│this is called self-centering.                                   │
│                                                                 │
│at high speed the body rotates around it's principal axis of     │
│inertia. the force distribution of the springs is negligible.    │
│the center of mass is displaced (excentric) by the unbalance by  │
│                                                                 │
│                        e = u / m                                │
│                                                                 │
│where m is the mass of the rotor.                                │
│                                                                 │
│this is typically a small value, measured in µm                  │
│                                                                 │
│  1 µm (excentricity)  =  1 gmm (unbalance) / 1kg (rotor mass)   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘`},
 anisotropic:{model:[
  {m:0,D:0,d:0,t:0,cx:10000,cy:40000,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:1e-6,a:0,cor:true,sen:"xy"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.1,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:10000,cy:40000,u:0,a:0,cor:false,sen:"none"}
 ],speed:{min:100,max:1000,steps:400},title:"anisotropic bearings",help:`
┌─────────────────────────────────────────────────────────────────┐
│                    anisotropic bearings                         │
├─────────────────────────────────────────────────────────────────┤
│if the bearings have a different stiffness in their principal    │
│directions, e.g. horizontal and vertial, the system is called    │
│anisotropic.                                                     │
│                                                                 │
│in this example the stiffness in x direction is 4 times smaller  │
│than in y direction.                  (x:horizontal, y:vertical) │
│                                                                 │
│observe the orbit at low speed:                                  │
│it is elliptic now: small in vertical but large in horizontal    │
│direction.                                                       │
│                                                                 │
│the displacements are measured at the center in both directions. │
│you can see in the displacement curves that the resonance in x   │
│direction comes first, at 270 rpm vs 540 rpm in y direction.     │
│                                                                 │
│increase the speed:                                              │
│just before 270 rpm the orbit is very thin: the horizontal       │
│oscillation dominates.                                           │
│                                                                 │
│between the two criticals the orbit moves backwards.             │
│                                                                 │
│at high speed after the second critical the unbalance points     │
│inwards again as in the isotropic case.                          │
│the forces of the springs (and their differences) are no longer  │
│relevant.                                                        │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
`},
 gyroscopic:{model:[
  {m:0,D:0,d:0,t:0,cx:100000,cy:100000,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:true,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:100000,cy:100000,u:0,a:0,cor:true,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:true,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"x"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:false,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:0,D:0,d:0,t:0,cx:0,cy:0,u:0,a:0,cor:true,sen:"none"},
  {L:0.1,D:0.02,d:0,E:2e11,rho:7850},
  {m:5,D:0.1,d:0,t:0.05,cx:0,cy:0,u:1e-6,a:0,cor:false,sen:"x"}
 ],speed:{min:10,max:4000,steps:400},title:"gyroscopic effect",help:`
┌─────────────────────────────────────────────────────────────────┐
│                      gyroscopic effect                          │
├─────────────────────────────────────────────────────────────────┤
│  tbd..                                                          │
│                                                                 │
│  - eigenfrequencies change with rotational speed                │
│  - ratio J/Q of disc element is important                       │
│  - in one case the change of eigenfrequencies is small          │
│    and cut by the speed ramp                                    │
│  - in the other case, eigenfrequency increases faster           │
│    and never reached by the rotor speed                         │
│  - most critical is the intermediate case:                      │
│    the disc element is close to spherical: J/Q about 1          │
│    - eigenfrequencies increase with speed with same slope       │
│    - the system is always in resonance                          │
│    - huge vibrations for a wide speed range                     │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘`},
},model,chex=x=>{let e=examples[x.value];extitle.textContent=e.title;hlptxt.textContent=e.help;model=e.model;minspeed.value=scN(e.speed.min);maxspeed.value=scN(e.speed.max);steps.value=e.speed.steps;update(0);changeunits();showsim()},

req,shaftline=[],ic=[],

setspeed=()=>{
 let w=speedrange()[speedidx]*pi/30,no=nodes(model).length,n=Array(4*no).fill(0).map((_,i)=>(i%4<2)?i:-1).filter(x=>x>=0) //0 1 4 5 8 9..
 let r=ZK(kxy(Ks("sh"),K.Kf(w),KI(n)));for(let i=0;i<4;i++){shaftline[i]=new Array(no).fill(0);for(let j=0;j<no;j++)shaftline[i][j]=r[i+4*j]}
 animate("")},
cors=()=>nodes(model).map((x,i)=>(x.u!=0||x.a!=0)?+x.cor:-1).filter(x=>x>=0), //1 0 1

re=v=>v.filter((_,i)=>~i&1),im=v=>v.filter((_,i)=>i&1),
showplot=()=>af(document.getElementsByName("radios")).filter(x=>x.checked)[0].onchange(),
plotdis=()=>{
 let r=ZK(kxy(Ks("dis"),KZ(ic),KI(cors()))),ini=r.slice(0,r.length/2),res=r.slice(r.length/2),sr=speedrange(),si=isen(),p=Array(si.length).fill([]),stride=ini.length/si.length
 p.forEach((_,i)=>{let r0=ini.slice(i*stride,(1+i)*stride),r1=res.slice(i*stride,(1+i)*stride),lines=[{x:sr,y:re(r0),z:im(r0)},{x:sr,y:re(r1),z:im(r1)}]
  p[i]={type:["ampang","polar"][+polar.checked],title:"displacement node"+si[i],xlabel:"speed "+uni("N")[0],ylabel:"µm",lines:lines}
 })
 plotcaption(["initial","residual"])
 plotjs.plots({plots:p,hi:{plot:0,lines:[0],point:speedidx}},pcnv,{b:bac,f:fwd},pcap,setlegend)
},
plotifc=()=>{ //pnode
 let pl=ipln(),nse=isen().length,sr=speedrange(),nsr=sr.length,stride=ic.length/pl.length
 let p=[],t=pl.map(x=>"plane at node "+x),y=[],z=[],sc=1e6/uni("U")[1]
 pl.forEach((pnode,i)=>{let r=ic.slice(i*stride,(1+i)*stride),s=r.length/nse,lines=[]
  for(let j=0;j<nse;j++){let rj=r.slice(j*s,(1+j)*s).map(x=>x*sc);lines.push({x:sr.slice(),y:re(rj),z:im(rj)})}
  p.push({type:["ampang","polar"][+polar.checked],title:"plane node"+pnode,xlabel:"speed "+uni("N")[0],ylabel:"µm/"+uni("U")[0],lines:lines})
 })
 plotcaption(isen().map(i=>("xy"[i%2])+" node "+floor(i/2)))
 plotjs.plots({plots:p,hi:{plot:0,lines:[0],point:speedidx}},pcnv,{b:bac,f:fwd},pcap,setlegend)
},
plotunb=()=>{
 let r=ZK(kxy(Ks("unb"),KZ(ic),KI(cors()))),ip=ipln(),stride=r.length/ip.length,sc=uni("U")[1]
 let p=[];for(let i=0;i<ip.length;i++){let ri=r.slice(i*stride,(1+i)*stride).map(x=>sc*x),lines=[{y:[ri[0]],z:[ri[1]]},{y:[ri[2]],z:[ri[3]]}]
  p.push({type:"polar",title:"plane node "+ip[i],ylabel:uni("U")[0],lines:lines})
 }
 plotcaption(["initial","correction"])
 plotjs.plots({plots:p},pcnv,undefined,pcap,setlegend)
},
plotprm=()=>{
 let ip=IK(kx(Ks("pln"),K.Ki(0)));if(ip[0]==ip[1])return perr("perm needs at least 2 unbalance planes")
 let ix=nodes(model).map((x,i)=>x.sen.includes('x')?i:-1).filter(x=>x>=0)
 let iX=nodes(model).map((x,i)=>(x.cx!=0)?i:-1).filter(x=>x>=0)
 if(2!=ix.length||2!=iX.length||ix[0]!=iX[0]||ix[1]!=iX[1])return perr("perm needs 2 sensors in x direction and springs with cx>0 at the same nodes")
 let si=isen().map((x,i)=>(~x&1)?i:-1).filter(x=>x>=0),sr=speedrange(),sc=uni("U")[1]
 let r=ZK(kxyz(Ks("prm"),KZ(ic),KI(si),KF(sr.map(x=>x*pi/30)))),stride=r.length/3,t=["plane node "+ip[0],"static","plane node "+ip[1]]
 let p=[0,0,0].map((_,i)=>{let ri=r.slice(i*stride,(1+i)*stride).map(x=>x*sc)
  return{type:["ampang","polar"][+polar.checked],title:t[i],xlabel:"speed "+uni("N")[0],ylabel:uni("U")[0],lines:[{x:sr,y:re(ri),z:im(ri)}]}
 })
 rm(pcap);plotjs.plots({plots:p,hi:{plot:0,lines:[0],point:speedidx}},pcnv,{b:bac,f:fwd},undefined,setlegend)
},
plotcaption=x=>{rm(pcap);x.forEach((s,i)=>tc(s,ac(ce("option"),pcap)).dataset.i=i)},
perr=s=>{let c=pcnv.getContext("2d");c.clearRect(0,0,pcnv.width,pcnv.height);rm(pcap);c.fillText(s,20,20)},

setlegend=(s,idx)=>{legend.textContent=s;if(s.startsWith("z:"))return;speedidx=idx;legend.textContent=s.replace(/.*;/,"")+"  speed:"+(speedrange()[idx]).toPrecision(6)+" "+uni("N")[0];setspeed()},

kw=null,lw=null,rk=null, //embed
K,LU,C=()=>new Int8Array(K.memory.buffer),I=()=>new Int32Array(K.memory.buffer),J=()=>new BigInt64Array(K.memory.buffer),F=()=>new Float64Array(K.memory.buffer),
KC=x=>{x=("string"===typeof x)?us(x):x;let r=K.mk(18,x.length);C().set(x,lo(r));return r},Ks=x=>K.sc(KC(x)),
KI=x=>{let r=K.mk(19,x.length);I().set(x,lo(r)>>>2);return r},KF=x=>{let r=K.mk(21,x.length);F().set(x,lo(r)>>>3);return r},KZ=x=>{let r=K.mk(22,x.length/2);F().set(x,lo(r)>>>3);return r},
IK=x=>{let p=lo(x)>>>2,n=K.nn(x);let r=I().slice(p,p+n);K.dx(x);return r},ZK=x=>{let p=lo(x)>>>3,n=K.nn(x);let r=F().slice(p,p+2*n);K.dx(x);return r},l3=(x,y,z)=>K.Cal(13n,K.l2(K.l2(x,y),K.Atx(13n,z))),asn=(s,y)=>K.dx(K.Asn(Ks(s),y)),
kx=(f,x)=>K.Atx(K.Val(f),x),
kxy=(f,x,y)=>K.Cal(K.Val(f),K.l2(x,y)),
kxyz=(f,x,y,z)=>K.Cal(K.Val(f),l3(x,y,z)),
kut=(n,x)=>K.Cal(14n,K.l2(K.Ki(n),x)),

kenv={env:{ 
 Exit:  function(x      ){},
 Args:  function(       ){return 0},
 Arg:   function(x,y    ){return 0},
 Read:  function(a,b,c  ){return -1},
 Write: function(a,b,c,d){let u=new Uint8Array(K.memory.buffer),v=u.slice(c,c+d);console.log("k:",su(v));return 0},
 ReadIn:function(x,y    ){return 0},
 Native:function(x,y    ){K.dx(x);return lucal(y)}}},
lucal=x=>{let j=J(),f=F(),lp=lo(x)>>>3,A=j[lp],an=K.nn(A),ap=lo(A)>>>3,n=lo(j[lp+1]),b=j[lp+2],bp=lo(b)>>>3,bn=K.nn(b),m=bn/n,r=K.mk(22,bn),rp=lo(r)>>>3
 j=J();let M=new Float64Array(LU.memory.buffer),p;M.set(f.subarray(ap,ap+2*an));p=LU.lu(n)>>>3
 for(let i=0;i<m;i++){M.set(f.subarray(bp,bp+2*n),p);let x=LU.solve(n)>>>3;f.set(M.subarray(x,x+2*n),rp+i*2*n);bp+=2*n}
 K.dx(x);return r},
kinit=(x)=>{
 WebAssembly.instantiate(lw,{env:{}}).then(r=>{LU=r.instance.exports;
  WebAssembly.instantiate(kw,kenv).then(r=>{K=r.instance.exports;
  let t0=Date.now()
  K.kinit()
  
  let f=K.l2(1n,Ks("LU"));I()[(lo(f)>>>2)-3]=3 //arity
  asn("LU",(BigInt(14)<<BigInt(59))+BigInt(lo(BigInt(f))))
  
  let no=nodes(model),n=no.length,p=no.map(x=>x.a*pi/180),ur=no.map((x,i)=>x.u*cos(p[i])),ui=no.map((x,i)=>x.u*sin(p[i])),
  J=no.map(x=>x.m*(x.D*x.D+x.d*x.d)/8),Q=no.map(x=>moiQ(x.m,x.D/2,x.d/2,x.t)),
  U=new Array(2*no.length).fill(0);for(let i=0;i<no.length;i++){U[2*i]=ur[i];U[1+2*i]=ui[i]}
 
  "L D d E rho".split(" ").forEach(s=>asn(s,KF(shafts(model).map(x=>x[s]))))
  "m cx cy".split(" ").forEach(s=>asn(s,KF(no.map(x=>x[s]))))
  asn("J",KF(J));asn("Q",KF(Q));asn("U",KZ(U))
  K.dx(K.Val(KC(rk)))
  if(!fastsim.checked)asn("LU",K.Val(KC("{[A;n;b],/lusolve/[lu k^A;((#b)%n)^b]}"))) //overwrite LU with k version
  LU.mk(4*n)
  if(x){
   ic=ZK(kxyz(Ks("IC"),KI(ipln()),KI(isen()),KF(speedrange().map(x=>x*pi/30))))
   let co=cors(),cor=(co.some(x=>x)?ZK(kxy(Ks("cor"),KZ(ic),KI(co))):[]),ip=ipln()
   for(let i=0;i<cor.length/2;i++){let[r,a]=absang(cor[2*i],cor[2*i+1]);tc(co[i]?scU(r).toPrecision(4):"",ge("coru"+ip[i]));tc(co[i]?(a.toFixed()+"°"):"",ge("cora"+ip[i]))}
   setspeed();showplot()}
  time.textContent="t: "+(Date.now()-t0)+" ms"
 })})}

Object.keys(examples).forEach(x=>selex.appendChild(tc(x,ce("option"))))
if(!lw)fetch("lu/lu.wasm").then(r=>r.arrayBuffer()).then(r=>lw=new Uint8Array(r))
if(!kw)fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>kw=new Uint8Array(r))
if(!rk)fetch("r.k").then(r=>r.text()).then(r=>rk=r)
units.value="medium";selex.value="shaft";chex(selex)


examples

</script>
</body></html>
