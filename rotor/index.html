<!DOCTYPE html>
<head><meta charset="utf-8"><link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAE0lEQVR42mNk+M+AFzCOKhhJCgBrLxABLz0PwwAAAABJRU5ErkJggg=="><title>rotor</title>
<style>
*{margin:0;overflow:hidden;font-family:monospace}
svg{display:block;margin:auto}
svg:focus{outline:none}
.ln:hover{cursor:pointer}
.ul{border-bottom:1px solid}
table{border-collapse:collapse}
textarea{background:#efe;border:none;outline:none}
input,select{width:5em}
th{text-align:left}



</style>
<body>
<svg id="svg" width="800" height="200" xmlns="http://www.w3.org/2000/svg" onkeydown="svgkey(event)" tabindex="0"></svg>

<pre id="massprop" ></pre>
<details id="rotordetails" ontoggle="togrotor(this)"><summary>rotor</summary><div  style="display:flex;flex-direction:row;justify-content:space-between">
<div>units&nbsp;&nbsp;&nbsp;:<select id="units" onchange="changeunits()"><option>iso</option><option>large</option><option>medium</option><option>small</option></select><br/>
example&nbsp;:<select id="selex" onchange="chex(this)"><option>empty</option><option>resonance</option><option>anisotropic</option><option>lpt</option><option>gyroscopic critical</option><option>turbocharger</option></select><br/><br/>speed range<br/>
min&nbsp;&nbsp;:<input type="number" min="0" value="1"/><label class="unitN">rpm</label><br/>
max&nbsp;&nbsp;:<input type="number" min="0" value="100"/><label class="unitN">rpm</label><br/>
steps:<input type="number" min="2" max="10000" value="100"/><br/>
</div>
<table id="nodeedit" data-i="0" style="display:none">
 <caption id="nodecaption" data-i="0">node</caption>
 <tr><th>disc Da</th><td><input type="number"    id="edDa" onchange='ed(this,"D","L")' /></td><td class="unitL">m</td></tr>
 <tr><th>disc Di</th><td><input type="number"    id="edDi" onchange='ed(this,"d","L")' /></td><td class="unitL">m</td></tr>
 <tr class="ul"><th>mass</th><td><input type="number"       id="edM"  onchange='ed(this,"M","M")' /></td><td class="unitM">kg</td></tr>
 <tr><th>support cx</th><td><input type="number" id="edCx" onchange='ed(this,"cx","C")' /></td><td class="unitC">N/m</td></tr>
 <tr class="ul"><th>support cy</th><td><input type="number" id="edCy" onchange='ed(this,"cy","C")' /></td><td class="unitC">N/m</td></tr>
 <tr><th>unbalance</th><td><input type="number"  id="edU"  onchange='ed(this,"u","U")' /></td><td class="unitU">kgm</td></tr>
 <tr class="ul"><th>angle</th><td><input type="number"      id="edA"  onchange='ed(this,"a","")' min="0" max="360" /></td><td>deg</td></tr>
 <tr><th>sensor direction</th><td><select        id="edSen" onchange='ed(this,"sen")'><option>none</option><option>x</option><option>y</option><option>xy</option></select></td></tr>
 <tr><th>cal direction</th><td><select           id="edCal" onchange='ed(this,"cal")'><option>none</option><option>x</option><option>y</option><option>xy</option></select></td></tr>
</table>
<table id="shaftedit" data-i="0" style="display:none">
 <caption id="shaftcaption">shaft</caption>
 <tr><th>length</th><td><input type="number"  id="edl"   onchange='ed(this,"L","L")' /></td><td class="unitL">m</td></tr>
 <tr><th>Da</th><td><input type="number"      id="edda"  onchange='ed(this,"D","L")' /></td><td class="unitL">m</td></tr>
 <tr><th>Di</th><td><input type="number"      id="eddi"  onchange='ed(this,"d","L")' /></td><td class="unitL">m</td></tr>
 <tr><th>E </th><td><input type="number"      id="ede"   onchange='ed(this,"E","")'  /></td><td>GPa</td></tr>
 <tr><th>density</th><td><input type="number" id="edrho" onchange='ed(this,"rho","R")'  /></td><td class="unitR">kg/m^3</td></tr>
 <tr><th>mass</th><td><input type="number"    id="edm"   onchange='ed(this,"M","M")' /></td><td class="unitM">kg</td></tr>
 <tr><td><button onclick="splitshaft()">split into</button></td><td><input id="splitinto" type="number" min="2" max="20" value="2"></td></tr>
</table>
<textarea id="ta" style="resize:none" onchange="modelT(this.value)" spellcheck="false"></textarea>
<table><caption>legend</caption>
 <tr><th>●</th><td>node</td></tr>
 <tr><th>○</th><td>center of mass</td></tr>
 <tr><th style="color:blue">()</th><td>radius of inertia</td></tr>
 <tr><th>¦</th><td>mass/disc element</td></tr>
 <tr><th>■</th><td>unbalance</td></tr>
 <tr><th>▲</th><td>isotropic bearing</td></tr>
 <tr><th>△</th><td>anisotropic bearing</td></tr>
 <tr><th>◺</th><td>support (x-only)</td></tr>
 <tr><th>◿</th><td>support (y-only)</td></tr>
 <tr><th>⧅</th><td>sensor x-direction</td></tr>
 <tr><th>⧄</th><td>sensor y-direction</td></tr>
 <tr><th style="color:red">|</th><td>sensor for monitor only</td></tr>
 <tr class="ul"><th style="color:green">|</th><td>sensor for balancing</td></tr>
 <tr><th>length</th><td id="rotorlength"></td></tr>
 <tr><th>mass</th><td id="rotormass"></td></tr>
 <tr><th>center of mass</th><td id="rotorcom"></td></tr>
 <tr><th>rotatorial inertia</th><td id="rotorjr"></td></tr>
 <tr><th>equatorial inertia</th><td id="rotorjq"></td></tr>
 <tr><th>x-bearing critical</th><td id="xbearing"></td></tr>
 <tr><th>y-bearing critical</th><td id="ybearing"></td></tr>
</table>
</div></details>

<details id="unbaldetails" ontoggle="togunbal(this)"><summary>unbalances</summary>
<div style="display:flex;justify-content:space-around">
<table id="utab">
<tr><td></td><td colspan="2">initial</td><td colspan="3">correction</td></tr>
<tr><th>node</th><th class="unitU">kgm</th><th>deg</th><th>cor</th><th class="unitU">kgm</th><th>deg</th></tr>
</table>
<table><caption>speed range</caption>
<tr><th>min</th><td><input id="minspeed" type="number"/></td><td class="unitN">rpm</td></tr>
<tr><th>max</th><td><input id="maxspeed" type="number"/></td><td class="unitN">rpm</td></tr>
<tr><th>steps</th><td><input id="steps" type="number" min="2" max="1000"/></td></tr>
</table>
</div>
</details>

<details id="animationdetails"><summary>animation</summary>
abc
</details>

<details id="respdetails"><summary>frequence response</summary>
def
</details>


<script>
const pi=Math.PI
let
ge=x=>document.getElementById(x),ce=x=>document.createElement(x),af=x=>Array.from(x),lo=x=>Number(BigInt.asUintN(32,x)),gc=x=>af(document.getElementsByClassName(x)),cE=x=>document.createElementNS("http://www.w3.org/2000/svg",x),
sA=(x,...y)=>{for(let i=0;i<y.length;i+=2)x.setAttributeNS(null,y[i],y[1+i]);return x},
su=x=>t_.decode(x),t_=new TextDecoder("utf-8"),us=x=>_t.encode(x),_t=new TextEncoder("utf-8"),u64s=s=>{let c=function(x){const r=new Uint8Array(x.length);for(let i=0;i<x.length;i++)r[i]=x.charCodeAt(i);return r};return c(atob(s))},


tamod=_=>{ let v=fmt(model.map(x=>JSON.stringify(x).slice(1,-1).replaceAll(`"`,"").replaceAll(","," "))) ;ta.cols=2+Math.max(...v.map(x=>x.length));ta.rows=v.length;ta.value=v.join("\n")},
modelT=x=>{try{model=JSON.parse("["+x.split("\n").map(x=>"{"+x.trim().replace(/ +/g,",").replace(/[a-zA-Z]+/g,x=>'"'+x+'"')+"}").join(",")+"]")}catch(e){};update(0)},
fmt=v=>{v.forEach((x,i)=>{v[i]=x.split(" ");v[i].push(..." ".repeat(9-v[i].length).split(""))});let col=j=>v.map(x=>x[j]);for(let j=0;j<v[0].length;j++){let c=col(j),m=Math.max(...c.map(x=>x.length));v.forEach((x,i)=>v[i][j]+=" ".repeat(m-x[j].length)) };return v.map((x,i)=>v[i]=x.join(" "))},

shafts=m=>m.filter((_,i)=>i%2),nodes =m=>m.filter((_,i)=>(1+i)%2),
discs=m=>nodes(m).filter(x=>x.D!=0),springs=m=>nodes(m).filter(x=>x.cx!=0&&x.cy!=0),unbals=m=>m.filter(x=>x.u!=0),sensors=m=>nodes(m).filter(x=>x.sen!="none"),cals=m=>nodes(m).filter(x=>x.cal!="none"),

svgmod=(m,a)=>{let D=0,L=0,X=[0],r="",rig=rigid(m);let sh=shafts(m);svg.dataset.i=a
 sh.forEach((x,i)=>{let st=(a==1+2*i)?"darkorange":"black"; let xi=L;
  r+=`<rect x="${xi}" y="${-x.D/2}"   width="${x.L}" height="${(x.D-x.d)/2}" fill="grey" class="ln" onclick="clickshaft(${1+2*i})"/>`
  r+=`<rect x="${xi}" y="${x.d/2}"    width="${x.L}" height="${(x.D-x.d)/2}" fill="grey" class="ln" onclick="clickshaft(${1+2*i})"/>`
  r+=`<rect x="${xi}" y="${(-x.d)/2}" width="${x.L}" height="${x.d}"    fill="lightgrey" class="ln" onclick="clickshaft(${1+2*i})"/>`
  r+=`<rect x="${xi}" y="${-x.D/2}"   width="${x.L}" height="${x.D}" fill="none" stroke="${st}" stroke-width="2px" vector-effect="non-scaling-stroke" />`;
  D=Math.max(D,x.D);L+=x.L;X.push(X[i]+x.L)})
 
 sh.forEach((x,i)=>{
  r+=`<circle cx="${X[i]}" cy="0" r="${D/10}" fill="black" stroke="${(a==(    2*i    ))?"darkorange":"black"}" stroke-width="2px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${   2*i     })"/>`})
  r+=`<circle cx="${  L }" cy="0" r="${D/10}" fill="black" stroke="${(a==(2*sh.length))?"darkorange":"black"}" stroke-width="2px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*sh.length})"/>`
 
 r+=`<circle cx="${rig.Z}" cy="0" r="${D/14}" fill="white" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke"/>` //com
 r+=`<circle cx="${rig.Z}" cy="0" r="${rig.iJ}" stroke="blue" fill="none" stroke-width="${D/40}" stroke-dasharray="${0.2*pi*rig.iJ} ${0.8*pi*rig.iJ}" stroke-dashoffset="${0.6*pi*rig.iJ}"/>` // radius of inertia
 r+=`<circle cx="${rig.Z}" cy="0" r="${rig.iQ}" stroke="blue" fill="none" stroke-width="${D/40}" stroke-dasharray="${0.1*pi*rig.iQ} ${0.9*pi*rig.iQ}" stroke-dashoffset="${0.05*pi*rig.iQ}"/>` // radius of inertia
 
 D=(8*D<L)?L/4:2*D
 nodes(m).forEach((x,i)=>{let xi=X[i],xr=Math.max(x.D,i?m[2*i-1].D:0,(2*i+1<m.length)?m[2*i+1].D:0)/2;
  if(x.M!=0){ //discs
   r+=`<line x1="${xi}" y1="${-x.D/2}" x2="${xi}" y2="${-x.d/2}" stroke="black" stroke-width="7px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*i})"/>`
   r+=`<line x1="${xi}" y1="${ x.D/2}" x2="${xi}" y2="${ x.d/2}" stroke="black" stroke-width="7px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*i})"/>`}
  if(x.sen!="none"){ //sensors
   r+=`<line x1="${xi}" y1="${-D/2}" x2="${xi}" y2="${-1.1*xr}"" stroke="red" stroke-width="2px" vector-effect="non-scaling-stroke" />`
   r+=`<rect x="${xi-D/20}" y="${-D/2}" width="${D/10}" height="${D/10}" fill="lightgrey" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*i})"/>`
   if(x.sen.includes("x"))r+=`<line x1="${xi-D/20}" y1="${-D/2}" x2="${xi+D/20}" y2="${D/10-D/2}" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" />`
   if(x.sen.includes("y"))r+=`<line x1="${xi+D/20}" y1="${-D/2}" x2="${xi-D/20}" y2="${D/10-D/2}" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" />`}
  if(x.cal!="none"){ //cals
   r+=`<line x1="${xi}" y1="${D/2}" x2="${xi}" y2="${1.1*xr}"" stroke="green" stroke-width="2px" vector-effect="non-scaling-stroke" />`
   r+=`<rect x="${xi-D/20}" y="${D/2-D/9.5}" width="${D/10}" height="${D/10}" fill="lightgrey" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" class="ln" onclick="clicknode(${2*i})"/>`
   if(x.cal.includes("x"))r+=`<line x1="${xi-D/20}" y1="${D/2-D/9.5}" x2="${xi+D/20}" y2="${D/2}" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" />`
   if(x.cal.includes("y"))r+=`<line x1="${xi+D/20}" y1="${D/2-D/9.5}" x2="${xi-D/20}" y2="${D/2}" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke" />`}
  if(x.cx!=0||x.cy!=0){ //springs 
   let st=((x.cx==x.cy)?'fill="black"':'fill="none" stroke="black" stroke-width="2px" vector-effect="non-scaling-stroke"')
   if(x.cx!=0)r+=`<polygon points="${xi},${xr} ${xi+D/20},${xr+D/10} ${xi},${xr+D/10}" ${st} class="ln" onclick="clicknode(${2*i})"/>`
   if(x.cy!=0)r+=`<polygon points="${xi},${xr} ${xi},${xr+D/10} ${xi-D/20},${xr+D/10}" ${st} class="ln" onclick="clicknode(${2*i})"/>`}
  if(x.u!=0)r+=`<rect x="${xi-D/20}" y="${-xr-D/10}" width="${D/10}" height="${D/10}" fill="black" class="ln" onclick="clicknode(${2*i})"/>` //unbals
 })
 
 X=L+D/5
 r+=`<line x1="${X}" x2="${X+D/5}" y1="0" y2="0" stroke-width="3px" stroke="black" vector-effect="non-scaling-stroke" class="ln" onclick="addshaft()"/>`
 X+=D/10
 r+=`<line x1="${X}" x2="${X}" y1="${-D/10}" y2="${D/10}" stroke-width="3px" stroke="black" vector-effect="non-scaling-stroke" class="ln" onclick="addshaft()"/>`
 X+=D/5
 
 svg.innerHTML=r
 sA(svg,"viewBox",`0 ${-D/2} ${X} ${D}`,"preserveAspectRatio","xMidYMid")
 
 rotorlength.textContent=`${scL(L).toPrecision(6)} ${uni("L")[0]}`
 rotormass.textContent  =`${scM(rig.M).toPrecision(6)} ${uni("M")[0]}`
 rotorcom.textContent   =`${scL(rig.Z).toPrecision(6)} ${uni("L")[0]}`
 rotorjr.textContent    =`${scL(rig.iJ).toPrecision(6)} ${uni("L")[0]}`
 rotorjq.textContent    =`${scL(rig.iQ).toPrecision(6)} ${uni("L")[0]}`
 xbearing.textContent   =`${scN(rig.nx[0]).toPrecision(5)}, ${scN(rig.nx[1]).toPrecision(6)} ${uni("N")[0]}`
 ybearing.textContent   =`${scN(rig.ny[0]).toPrecision(5)}, ${scN(rig.ny[1]).toPrecision(6)} ${uni("N")[0]}`
},
area=x=>0.25*pi*(x.D*x.D-x.d*x.d),mass=x=>area(x)*x.rho*x.L,

emptynode=_=>{return{M:0,D:0,d:0,cx:0,cy:0,u:0,a:0,sen:"none",cal:"none"}},
clicknode=i=>{rotordetails.open=true;shaftedit.style.display="none";nodeedit.style.display="block";nodecaption.textContent="element "+i+" (node)";nodeedit.dataset.i=i;svgmod(model,i)
 af([edDa,edDi,edM,edCx,edCy,edU,edA]).forEach(x=>x.value=null);edSen.value="none";edCal.value="none"
 let e=model[i];edDa.value=scL(e.D);edDi.value=scL(e.d);edM.value=scM(e.M);edCx.value=scC(e.cx);edCy.value=scC(e.cy);edU.value=scU(e.u);edA.value=e.a;edSen.value=e.sen;edCal.value=e.cal},
clickshaft=i=>{rotordetails.open=true;shaftedit.style.display="block";nodeedit.style.display="none"; shaftcaption.textContent="element "+i+" (shaft)";shaftedit.dataset.i=i;svgmod(model,i)
 let e=model[i];edl.value=scL(e.L);edda.value=scL(e.D);eddi.value=scL(e.d);ede.value=e.E,edrho.value=scR(e.rho);edm.value=scM(mass(e))},
changeunits=()=>{if(shaftedit.style.display=="block")clickshaft(+shaftedit.dataset.i);else clicknode(+nodeedit.dataset.i);"LMRCUNE".split("").forEach(x=>gc("unit"+x).forEach(e=>e.textContent=uni(x)[0]))},
addshaft=_=>{let n=model.length; model.push({...model[n-2]},emptynode());clickshaft(model.length-2)},
delelem=i=>{ if(0==i%2){model[i]=emptynode();return update(i)};if(i==0||model.length<4)return; model.splice(i-1,2); update(model.length-2)},
ed=(inp,s,u,j)=>{let c=1/((""!=u)?uni(u)[1]:1),t=inp.closest("table"),i=((j==undefined)?+t.dataset.i:j),v=c*(+inp.value),e=model[i];if("shaftedit"==t.id){if(s=="mass"){s="rho";v=v/area(e)*e.L};e[s]=v}else{e[s]=v}update(i)},

togrotor=d=>{unbaldetails.open=!d.open},
togunbal=d=>{rotordetails.open=!d.open},

urow=(u,a,i)=>utab.innerHTML+=`<tr><td>${i}</td><td><input type="number" value="${scU(u)}" onchange='ed(this,"u","U",${i})'/></td><td><input type="number" value="${a}" onchange='ed(this,"a","",${i})' min="0" max="360"/></td><td><input type="checkbox" style="width:1em"/></td><td id="coru"+i></td><td id="cora"+i></td></tr>`,
ubmod=m=>{while(utab.rows.length>2)utab.deleteRow(2);nodes(model).forEach((x,i)=>{if(x.u!=0||x.a!=0)urow(x.u,x.a,2*i)})},

rigid=m=>{ //rigid rotor properties
 let z=[0];shafts(m).forEach((x,i)=>z.push(z[i]+x.L))
 let M=shafts(m).reduce((s,e)=>s+mass(e),0)+nodes(m).reduce((s,e)=>s+e.M,0),
     Z=shafts(m).reduce((s,e,i)=>s+0.5*(z[i]+z[1+i])*mass(e)/M,0)+nodes(m).reduce((s,e,i)=>s+z[i]*e.M/M,0),
     J=shafts(m).reduce((s,e,i)=>s+mass(e)*(e.D*e.D+e.d*e.d)/8,0)                                       +nodes(m).reduce((s,e,i)=>s+e.M*(e.D*e.D+e.d*e.d)/ 8,                0),
     Q=shafts(m).reduce((s,e,i)=>s+mass(e)*((0.75*(e.D*e.D+e.d*e.d)+e.L*e.L)/12+((z[i]+z[1+i])-Z)**2),0)+nodes(m).reduce((s,e,i)=>s+e.M*(e.D*e.D+e.d*e.d)/16+e.M*(z[i]-Z)**2,0),
     nx=eig(m,M,Z,z,Q,"cx"),ny=eig(m,M,Z,z,Q,"cy")
 return{M:M,Z:Z,J:J,Q:1,iJ:Math.sqrt(J/M),iQ:Math.sqrt(Q/M),nx:nx,ny:ny}},
eig=(m,M,Z,z,Q,dir)=>{let c0=nodes(m).reduce((s,e,i)=>s+e[dir],0),c1=nodes(m).reduce((s,e,i)=>s+e[dir]*(z[i]-Z),0),c2=nodes(m).reduce((s,e,i)=>s+e[dir]*(z[i]-Z)**2,0),a=c0/M,b=c1/M,c=c1/Q,d=c2/Q,me=0.5*(a+d),det=a*d-b*c,rpm=30/pi;return[rpm*(me-Math.sqrt(me*me-det)),rpm*(me+Math.sqrt(me*me-det))]},

update=x=>{if(!unbaldetails.open){if(x%2)clickshaft(x);else clicknode(x)};tamod(model);ubmod(model);calculate()},
splitshaft=_=>{let i=+shaftedit.dataset.i,n=+splitinto.value;if(n<2||n>100)return;let sh=model[i];sh.L/=n;while(--n>0){console.log("n",n); model.splice(i,0,{L:sh.L,D:sh.D,d:sh.d,rho:sh.rho},emptynode()  )};update(i)},
svgkey=e=>{if(e.key=="Delete")delelem(+svg.dataset.i)},

uni=x=>{let t={
  iso:   {M:["kg",1],  L:["m",1],   R:["kg/m^3",1],U:["kgm",1],   C:["N/m",1],    N:["rpm",1]    },
  large: {M:["t",1e-3],L:["mm",1e3],R:["kg/m^3",1],U:["kgmm",1e3],C:["N/µm",1e-6],N:["rpm",1]    },
  medium:{M:["kg",1],  L:["mm",1e3],R:["kg/m^3",1],U:["gmm",1e6], C:["N/µm",1e-6],N:["rpm",1]    },
  small: {M:["g",1e3], L:["mm",1e3],R:["kg/m^3",1],U:["mgmm",1e9],C:["N/µm",1e-6],N:["krpm",1e-3]}
 };return t[units.value][x]},
scL=x=>x*uni("L")[1],scM=x=>x*uni("M")[1],scR=x=>x*uni("R")[1],scU=x=>x*uni("U")[1],scC=x=>x*uni("C")[1],scN=x=>x*uni("N")[1],

examples={
 empty:{model:[
  {M:0,D:0,d:0,cx:1e6,cy:1e6,u:0,a:0,sen:"none",cal:"none"},
  {L:0.100,D:0.010,d:0.005,E:200,rho:7850},
  {M:0,D:0,d:0,cx:1e6,cy:1e6,u:0,a:0,sen:"none",cal:"none"}
 ],speed:{min:1,max:100,steps:100}},
 resonance:{model:[
  {M:0,D:0,d:0,cx:1000,cy:1000,u:0,a:0,sen:"none",cal:"none"},
  {L:0.020,D:0.010,d:0.005,E:200,rho:7850},
  {M:0,D:0,d:0,cx:1000,cy:1000,u:0,a:0,sen:"none",cal:"none"},
  {L:0.020,D:0.015,d:0.005,E:200,rho:7850},
  {M:0.2,D:0.010,d:0.005,cx:0,cy:0,u:15,a:30,sen:"xy",cal:"x"}
 ],speed:{min:1,max:100,steps:100}}
},model,chex=x=>{let e=examples[x.value];model=e.model;minspeed.value=scN(e.speed.min);maxspeed.value=scN(e.speed.max);steps.value=e.speed.steps;update(0)},

calculate=_=>{
 console.log("calculate")
 if(kw&&rk){kinit()
 }else setTimeout(calculate,500)
},


kw=null,rk=null, //embed
K,C=()=>new Int8Array(K.memory.buffer),I=()=>new Int32Array(K.memory.buffer),J=()=>new BigInt64Array(K.memory.buffer),F=()=>new Float64Array(K.memory.buffer),
KC=x=>{x=("string"===typeof x)?us(x):x;let r=K.mk(18,x.length);C().set(x,lo(r));return r},Ks=x=>K.sc(KC(x)),
KF=x=>{let r=K.mk(21,x.length);F().set(x,lo(r)>>>3);return r},KZ=x=>{let r=K.mk(22,x.length/2);F().set(x,lo(r)>>>3);return r},
asn=(s,y)=>K.dx(K.Asn(Ks(s),y)),
kenv={env:{ 
 Exit:  function(x      ){},
 Args:  function(       ){return 0},
 Arg:   function(x,y    ){return 0},
 Read:  function(a,b,c  ){return -1},
 Write: function(a,b,c,d){let u=new Uint8Array(K.memory.buffer),v=u.slice(c,c+d);console.log("k:",su(v));return 0},
 ReadIn:function(x,y    ){return 0},
 Native:function(x,y    ){return 0}}},
kinit=()=>{console.log("kinit");WebAssembly.instantiate(kw,kenv).then(r=>{K=r.instance.exports;

 return
 K.kinit()
 
 let n=Math.ceil(model.length/2),p=nodes(model).map(x=>x.a*pi/180),ur=nodes(mode).map((x,i)=>x.u*Math.cos(p)),ui=nodes(mode).map((x,i)=>x.u*Math.sin(p)),
 u=new Array(2*n);for(let i=0;i<n;i++){u[2*i]=ur;u[1+2*i]=ui}
 
 "L D d E rho".split(" ").forEach(s=>asn(s,KF(shafts(model).map(x=>x[s]))))
 "M cx cy".split(" ").forEach(s=>asn(s,KF(nodes(model).map(x=>x[s]))))
 asn("J",KF(nodes(model).map(x=>x.m*(x.D*x.D+x.d*x.d)/8)))
 asn("U",KZ(u))
 
 K.dx(K.Val(KC(rk)))
})}

if(!kw)fetch("../k.wasm").then(r=>r.arrayBuffer()).then(r=>kw=new Uint8Array(r))
if(!rk)fetch("r.k").then(r=>r.text()).then(r=>rk=r)
units.value="medium";selex.value="resonance";chex(selex);changeunits()


</script>
</body></html>